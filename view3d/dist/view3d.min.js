/*
Copyright (c) NAVER Corp.
name: @olearis/view3d
license: MIT
author: NAVER Corp.
repository: https://github.com/naver/egjs-view3d
version: 2.10.2
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("three"),require("@egjs/component")):"function"==typeof define&&define.amd?define(["three","@egjs/component"],t):(e=e||self).View3D=t(e.THREE,e.Component)}(this,function(P,D){"use strict";class h extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,h.prototype),this.name="View3DError",this.code=t}}var r={WRONG_TYPE:0,ELEMENT_NOT_FOUND:1,CANVAS_NOT_FOUND:2,WEBGL_NOT_SUPPORTED:3,PROVIDE_SRC_FIRST:4,FILE_NOT_SUPPORTED:5,NOT_INITIALIZED:6,MODEL_FAIL_TO_LOAD:7},l=r,c={WRONG_TYPE:(e,t)=>typeof e+` is not a ${t.map(e=>`"${e}"`).join(" or ")}.`,ELEMENT_NOT_FOUND:e=>`Element with selector "${e}" not found.`,CANVAS_NOT_FOUND:"The canvas element was not found inside the given root element.",WEBGL_NOT_SUPPORTED:"WebGL is not supported on this browser.",PROVIDE_SRC_FIRST:'"src" should be provided before initialization.',FILE_NOT_SUPPORTED:e=>`Given file "${e}" is not supported.`,NOT_INITIALIZED:"View3D is not initialized yet.",MODEL_FAIL_TO_LOAD:e=>`Failed to load/parse the 3D model with the given url: "${e}". Check "loadError" event for actual error instance.`};const I=e=>"number"==typeof e,n=e=>"string"==typeof e,N=e=>!!e&&e.nodeType===Node.ELEMENT_NODE,F=(e,t)=>{let i=null;if(n(e)){t=(t||document).querySelector(e);if(!t)return null;i=t}else N(e)&&(i=e);return i},ee=(e,t)=>{t=F(e,t);if(t)return t;throw n(e)?new h(c.ELEMENT_NOT_FOUND(e),l.ELEMENT_NOT_FOUND):new h(c.WRONG_TYPE(e,["HTMLElement","string"]),l.WRONG_TYPE)},U=(e,t)=>{e=e.querySelector(t);if(e)return e;throw new h(c.CANVAS_NOT_FOUND,l.CANVAS_NOT_FOUND)},B=e=>{if(!n(e))return!1;var t=document.createDocumentFragment();try{t.querySelector(e)}catch(e){return!1}return!0},k=e=>!e||e<=0?[]:Array.apply(0,Array(e)).map((e,t)=>t),_=e=>e*Math.PI/180,p=e=>180*e/Math.PI,d=(e,t,i)=>Math.max(Math.min(e,i),t),H=(e,t,i)=>e*(1-i)+t*i,u=(e,t,i)=>{var s=Math.abs(i-t);return e<t?e=i-(t-e)%s:i<e&&(e=t+(e-i)%s),e},V=(s,...e)=>(e.forEach(i=>{Object.keys(i).forEach(e=>{var t=i[e];Array.isArray(s[e])&&Array.isArray(t)?s[e]=[...s[e],...t]:s[e]=t})}),s);const G=e=>{let t=1;for(;t<e;)t*=2;return t};const z=(e,t,i)=>{t=(new P.Vector2).subVectors(t,e).normalize(),i=(new P.Vector2).subVectors(i,e).normalize().angle()-t.angle(),e=-Math.sign(i)*(2*Math.PI-Math.abs(i));return Math.abs(i)<Math.abs(e)?i:e},Z=e=>"object"==typeof e?e:{},W=e=>e?"true":"false",j=(e,t,i)=>{var t=_(t),i=_(i),s=new P.Vector3(0,0,0);return s.y=e*Math.sin(i),s.z=e*Math.cos(i),s.x=s.z*Math.sin(-t),s.z=s.z*Math.cos(-t),s},K=e=>{var t=new P.Vector2(e.x,e.z),i=new P.Vector2;return{yaw:Math.abs(e.y)<=.99?z(i,new P.Vector2(0,1),t):0,pitch:Math.atan2(e.y,t.distanceTo(i))}},X=(e,t)=>{t={src:t,loaded:0,total:0,lengthComputable:!1,initialized:!1};return e.loadingContext.push(t),t},q=e=>{var t;return e.normalized&&ArrayBuffer.isView(e.array)?(e=e.array,t=te(e),e=1/(Math.pow(2,8*e.BYTES_PER_ELEMENT)-1),t?2*e:e):1},Y=(e,t,i,s)=>{var r=t.geometry,n=r.attributes.position,a=r.attributes.skinIndex,r=r.attributes.skinWeight;const o=t.skeleton.boneMatrices;n=(new P.Vector3).fromBufferAttribute(n,e).multiplyScalar(i);const h=new P.Vector4(0,0,0,0),l=new P.Vector4(n.x,n.y,n.z).applyMatrix4(t.bindMatrix);i=[r.getX(e),r.getY(e),r.getZ(e),r.getW(e)].map(e=>e*s);const c=[a.getX(e),a.getY(e),a.getZ(e),a.getW(e)];i.forEach((e,t)=>{t=(new P.Matrix4).fromArray(o,16*c[t]);h.add(l.clone().applyMatrix4(t).multiplyScalar(e))});n=(new P.Vector3).fromArray(h.applyMatrix4(t.bindMatrixInverse).toArray());return n.applyMatrix4(t.matrixWorld),n},te=e=>{e=new e.constructor(1);return e[0]=-1,e[0]<0},ie=e=>{if(e.capabilities.isWebGL2)return!0;{var e=e.getContext(),i=e.createTexture();let t=!0;try{var s=new Uint16Array(4),r=e.getExtension("OES_texture_half_float");t=!!r&&(e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,r.HALF_FLOAT_OES,s),e.getError()===e.NO_ERROR)}catch(e){t=!1}return e.deleteTexture(i),t}},se=(e,t,i)=>{if(!e||t<0||i<0)return null;e=e.meshes[t];const s=null==(t=null==e?void 0:e.geometry.index)?void 0:t.array;t=s?k(3).map(e=>s[3*i+e]):null;if(!e||!s||!t||t.some(e=>null==e))return null;const r=e.geometry.getAttribute("position");return t.map(e=>(new P.Vector3).fromBufferAttribute(r,e))},re=(e,t,i)=>{var s=se(e,t,i);if(!s)return null;const r=e.meshes[t],n=r.geometry.getIndex().array.slice(3*i,3*i+3);if(r.isSkinnedMesh){e=r.geometry,t=e.attributes.position,i=e.attributes.skinWeight;const a=q(t),o=q(i);s.forEach((e,t)=>{t=n[t],t=Y(t,r,a,o);e.copy(t)})}else s.forEach(e=>{e.applyMatrix4(r.matrixWorld)});return s};const ne=(e,t,i=!1)=>!e||!i&&e.constructor===t?e:"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e),ae=(e,t)=>{const s=t.min.toArray(),r=(new P.Vector3).subVectors(t.max,t.min).toArray();return(new P.Vector3).fromArray(e.map((e,t)=>{var i;return n(e)?(i=.01*parseFloat(e),s[t]+i*r[t]):e}))};function oe(e,t){var i={};for(r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var s=0,r=Object.getOwnPropertySymbols(e);s<r.length;s++)t.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(e,r[s])&&(i[r[s]]=e[r[s]]);return i}function Q(e,a,o,h){return new(o=o||Promise)(function(i,t){function s(e){try{n(h.next(e))}catch(e){t(e)}}function r(e){try{n(h.throw(e))}catch(e){t(e)}}function n(e){var t;e.done?i(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(s,r)}n((h=h.apply(e,a||[])).next())})}var he={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform float opacity;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\t\t\tgl_FragColor = opacity * texel;\n\n\t\t}"};class le{constructor(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}}var ce=new P.OrthographicCamera(-1,1,1,-1,0,1),de=new P.BufferGeometry;de.setAttribute("position",new P.Float32BufferAttribute([-1,3,0,-1,-1,0,3,-1,0],3)),de.setAttribute("uv",new P.Float32BufferAttribute([0,2,0,0,2,0],2));class ue{constructor(e){this._mesh=new P.Mesh(de,e)}dispose(){this._mesh.geometry.dispose()}render(e){e.render(this._mesh,ce)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}}class _e extends le{constructor(e,t){super(),this.textureID=void 0!==t?t:"tDiffuse",e instanceof P.ShaderMaterial?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=P.UniformsUtils.clone(e.uniforms),this.material=new P.ShaderMaterial({defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.fsQuad=new ue(this.material)}render(e,t,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.fsQuad.material=this.material,this.renderToScreen?e.setRenderTarget(null):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil)),this.fsQuad.render(e)}}class pe extends le{constructor(e,t){super(),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,i){var s,r,n=e.getContext(),a=e.state;a.buffers.color.setMask(!1),a.buffers.depth.setMask(!1),a.buffers.color.setLocked(!0),a.buffers.depth.setLocked(!0),r=this.inverse?(s=0,1):(s=1,0),a.buffers.stencil.setTest(!0),a.buffers.stencil.setOp(n.REPLACE,n.REPLACE,n.REPLACE),a.buffers.stencil.setFunc(n.ALWAYS,s,4294967295),a.buffers.stencil.setClear(r),a.buffers.stencil.setLocked(!0),e.setRenderTarget(i),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),a.buffers.color.setLocked(!1),a.buffers.depth.setLocked(!1),a.buffers.stencil.setLocked(!1),a.buffers.stencil.setFunc(n.EQUAL,1,4294967295),a.buffers.stencil.setOp(n.KEEP,n.KEEP,n.KEEP),a.buffers.stencil.setLocked(!0)}}class me{constructor(e,t){var i,s;this.renderer=e,void 0===t?(i={minFilter:P.LinearFilter,magFilter:P.LinearFilter,format:P.RGBAFormat},s=e.getSize(new P.Vector2),this._pixelRatio=e.getPixelRatio(),this._width=s.width,this._height=s.height,(t=new P.WebGLRenderTarget(this._width*this._pixelRatio,this._height*this._pixelRatio,i)).texture.name="EffectComposer.rt1"):(this._pixelRatio=1,this._width=t.width,this._height=t.height),this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],void 0===_e&&console.error("THREE.EffectComposer relies on ShaderPass"),this.copyPass=new _e(he),this.clock=new P.Clock}swapBuffers(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){e=this.passes.indexOf(e);-1!==e&&this.passes.splice(e,1)}isLastEnabledPass(e){for(var t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){void 0===e&&(e=this.clock.getDelta());for(var t=this.renderer.getRenderTarget(),i=!1,s=0,r=this.passes.length;s<r;s++){var n,a,o=this.passes[s];!1!==o.enabled&&(o.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(s),o.render(this.renderer,this.writeBuffer,this.readBuffer,e,i),o.needsSwap&&(i&&(n=this.renderer.getContext(),(a=this.renderer.state.buffers.stencil).setFunc(n.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),a.setFunc(n.EQUAL,1,4294967295)),this.swapBuffers()),void 0!==pe)&&(o instanceof pe?i=!0:!1&&(i=!1))}this.renderer.setRenderTarget(t)}reset(e){var t;void 0===e&&(t=this.renderer.getSize(new P.Vector2),this._pixelRatio=this.renderer.getPixelRatio(),this._width=t.width,this._height=t.height,(e=this.renderTarget1.clone()).setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)),this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;var i=this._width*this._pixelRatio,s=this._height*this._pixelRatio;this.renderTarget1.setSize(i,s),this.renderTarget2.setSize(i,s);for(var r=0;r<this.passes.length;r++)this.passes[r].setSize(i,s)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}}new P.OrthographicCamera(-1,1,1,-1,0,1);var e=new P.BufferGeometry;e.setAttribute("position",new P.Float32BufferAttribute([-1,3,0,-1,-1,0,3,-1,0],3)),e.setAttribute("uv",new P.Float32BufferAttribute([0,2,0,0,2,0],2));class ve extends le{constructor(e,t,i,s,r){super(),this.scene=e,this.camera=t,this.overrideMaterial=i,this.clearColor=s,this.clearAlpha=void 0!==r?r:0,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new P.Color}render(e,t,i){var s,r,n=e.autoClear;e.autoClear=!1,void 0!==this.overrideMaterial&&(r=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor&&(e.getClearColor(this._oldClearColor),s=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:i),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),this.clearColor&&e.setClearColor(this._oldClearColor,s),void 0!==this.overrideMaterial&&(this.scene.overrideMaterial=r),e.autoClear=n}}class ge extends le{constructor(e){super();var t=he;this.textureID="tDiffuse",this.uniforms=P.UniformsUtils.clone(t.uniforms),this.material=new P.ShaderMaterial({uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader}),this.renderTarget=e,void 0===this.renderTarget&&(this.renderTarget=new P.WebGLRenderTarget(window.innerWidth,window.innerHeight,{minFilter:P.LinearFilter,magFilter:P.LinearFilter,format:P.RGBFormat}),this.renderTarget.texture.name="SavePass.rt"),this.needsSwap=!1,this.fsQuad=new ue(this.material)}render(e,t,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),e.setRenderTarget(this.renderTarget),this.clear&&e.clear(),this.fsQuad.render(e)}}var o,fe={uniforms:{tDiffuse1:{value:null},tDiffuse2:{value:null},mixRatio:{value:.5},opacity:{value:1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform float opacity;\n\t\tuniform float mixRatio;\n\n\t\tuniform sampler2D tDiffuse1;\n\t\tuniform sampler2D tDiffuse2;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel1 = texture2D( tDiffuse1, vUv );\n\t\t\tvec4 texel2 = texture2D( tDiffuse2, vUv );\n\t\t\tgl_FragColor = opacity * mix( texel1, texel2, mixRatio );\n\n\t\t}"},Ee={uniforms:{tDiffuse:{value:null}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 tex = texture2D( tDiffuse, vUv );\n\n\t\t\tgl_FragColor = LinearTosRGB( tex ); // optional: LinearToGamma( tex, float( GAMMA_FACTOR ) );\n\n\t\t}"};const m={MOUSE_DOWN:"mousedown",MOUSE_MOVE:"mousemove",MOUSE_UP:"mouseup",TOUCH_START:"touchstart",TOUCH_MOVE:"touchmove",TOUCH_END:"touchend",WHEEL:"wheel",RESIZE:"resize",CONTEXT_MENU:"contextmenu",MOUSE_ENTER:"mouseenter",MOUSE_LEAVE:"mouseleave",POINTER_DOWN:"pointerdown",POINTER_MOVE:"pointermove",POINTER_UP:"pointerup",POINTER_ENTER:"pointerenter",POINTER_LEAVE:"pointerleave",LOAD:"load",ERROR:"error",CLICK:"click",DOUBLE_CLICK:"dblclick",CONTEXT_LOST:"webglcontextlost",CONTEXT_RESTORED:"webglcontextrestored"},i={GRAB:"grab",GRABBING:"grabbing",NONE:""},Te=((e=o=o||{})[e.LEFT=0]="LEFT",e[e.MIDDLE=1]="MIDDLE",e[e.RIGHT=2]="RIGHT","anonymous"),f="div",we="button",$="auto",E={READY:"ready",LOAD_START:"loadStart",LOAD:"load",LOAD_ERROR:"loadError",LOAD_FINISH:"loadFinish",MODEL_CHANGE:"modelChange",RESIZE:"resize",BEFORE_RENDER:"beforeRender",RENDER:"render",PROGRESS:"progress",INPUT_START:"inputStart",INPUT_END:"inputEnd",CAMERA_CHANGE:"cameraChange",ANIMATION_START:"animationStart",ANIMATION_LOOP:"animationLoop",ANIMATION_FINISHED:"animationFinished",ANNOTATION_FOCUS:"annotationFocus",ANNOTATION_UNFOCUS:"annotationUnfocus",AR_START:"arStart",AR_END:"arEnd",AR_MODEL_PLACED:"arModelPlaced",QUICK_LOOK_TAP:"quickLookTap"},be={SINE_WAVE:e=>Math.sin(e*Math.PI*2),EASE_OUT_CUBIC:e=>1-Math.pow(1-e,3),EASE_OUT_BOUNCE:e=>{var t=7.5625,i=2.75;return e<1/i?t*e*e:e<2/i?t*(e-=1.5/i)*e+.75:e<2.5/i?t*(e-=2.25/i)*e+.9375:t*(e-=2.625/i)*e+.984375}},J={WRAPPER:"view3d-wrapper",CANVAS:"view3d-canvas",POSTER:"view3d-poster",AR_OVERLAY:"view3d-ar-overlay",ANNOTATION_WRAPPER:"view3d-annotation-wrapper",ANNOTATION:"view3d-annotation",ANNOTATION_TOOLTIP:"view3d-annotation-tooltip",ANNOTATION_DEFAULT:"default",ANNOTATION_SELECTED:"selected",ANNOTATION_HIDDEN:"hidden",ANNOTATION_FLIP_X:"flip-x",ANNOTATION_FLIP_Y:"flip-y",CTX_LOST:"ctx-lost"},xe={LINEAR:P.LinearToneMapping,REINHARD:P.ReinhardToneMapping,CINEON:P.CineonToneMapping,ACES_FILMIC:P.ACESFilmicToneMapping},Se={FOV:"fov",DISTANCE:"distance"};e={WEBXR:"webAR",SCENE_VIEWER:"sceneViewer",QUICK_LOOK:"quickLook"};const ye={ONLY_AR:"ar_only",ONLY_3D:"3d_only",PREFER_AR:"ar_preferred",PREFER_3D:"3d_preferred"};var v;const g={ROTATE:0,TRANSLATE:1,ZOOM:2},Re={ONE:"one",NONE:"none",ALL:"all"};class Le{constructor(e){this._defaultRenderLoop=e=>{var{control:t,autoPlayer:i,animator:s}=this._view3D;(s.animating||t.animating||i.animating)&&this._renderFrame(e)},this._onContextLost=()=>{this._canvas.classList.add(J.CTX_LOST)},this._onContextRestore=()=>{var e=this._canvas,t=this._view3D.scene;e.classList.remove(J.CTX_LOST),t.initTextures(),this.renderSingleFrame()};var t=U(e.rootEl,e.canvasSelector),i=(this._canvas=t,this._view3D=e,this._renderQueued=!1,new P.WebGLRenderer({canvas:t,alpha:!0,antialias:!0,preserveDrawingBuffer:!0}));i.toneMapping=e.toneMapping,i.toneMappingExposure=e.exposure,i.outputEncoding=P.sRGBEncoding,i.setClearColor(0,0),this._halfFloatAvailable=ie(i),this._renderer=i,this._clock=new P.Clock(!1),this._canvasSize=new P.Vector2,t.addEventListener(m.CONTEXT_LOST,this._onContextLost),t.addEventListener(m.CONTEXT_RESTORED,this._onContextRestore)}get canvas(){return this._canvas}get context(){return this._renderer.getContext()}get threeRenderer(){return this._renderer}get defaultRenderLoop(){return this._defaultRenderLoop}get size(){var e=this._renderer.getSize(new P.Vector2);return{width:e.width,height:e.y}}get canvasSize(){return this._canvasSize}get capabilities(){var e=this._renderer;return Object.assign(Object.assign({},e.capabilities),{halfFloat:this._halfFloatAvailable})}effectsOn(e){this._effectsOn=e}setBlenMixRatio(e){this.blendPass.uniforms.mixRatio.value=e}destroy(){var e=this._canvas;this.stopAnimationLoop(),this._renderer.dispose(),e.removeEventListener(m.CONTEXT_LOST,this._onContextLost),e.removeEventListener(m.CONTEXT_RESTORED,this._onContextRestore)}resize(){var e,t=this._renderer,i=this._canvas;t.xr.isPresenting||(e=i.clientWidth||1,i=i.clientHeight||1,t.setPixelRatio(window.devicePixelRatio),t.setSize(e,i,!1),this._canvasSize.set(e,i))}setAnimationLoop(s){const r=this._view3D,n=this._clock;var e=this._canvas,t=(this.renderPass=new ve(r.scene.root,r.camera.threeCamera),new _e(Ee)),e=new P.WebGLRenderTarget((e.clientWidth||1)*window.devicePixelRatio,(e.clientHeight||1)*window.devicePixelRatio,{colorSpace:"srgb",stencilBuffer:!1}),e=new ge(e),i=(this.blendPass=new _e(fe,"tDiffuse1"),this.blendPass.uniforms.tDiffuse2.value=e.renderTarget.texture,this.blendPass.uniforms.mixRatio.value=0,new _e(he));i.renderToScreen=!0,this.composer=new me(this._renderer),this.composer.setSize(window.innerWidth,window.innerHeight),this.composer.setPixelRatio(window.devicePixelRatio),this.composer.addPass(this.renderPass),this.composer.addPass(t),this.composer.addPass(this.blendPass),this.composer.addPass(e),this.composer.addPass(i),n.start(),this._renderer.setAnimationLoop((e,t)=>{var i=Math.min(n.getDelta(),r.maxDeltaTime);s(i,t)})}stopAnimationLoop(){this._clock.stop(),this._renderer.setAnimationLoop(null)}renderSingleFrame(e=!1){this._renderer.xr.isPresenting||(e?this._renderFrame(0):this._renderQueued||(requestAnimationFrame(()=>{this._renderFrame(0)}),this._renderQueued=!0))}_renderFrame(e){var t,i=this._view3D,s=this._renderer,{scene:r,camera:n,control:a,autoPlayer:o,animator:h,annotation:l}=i;s.getContext().isContextLost()||(t=1e3*e,this._renderQueued=!1,h.update(e),a.update(t),o.update(t),i.trigger(E.BEFORE_RENDER,{type:E.BEFORE_RENDER,target:i,delta:t}),n.updatePosition(),r.shadowPlane.render(),this._effectsOn?this.composer.render():s.render(r.root,n.threeCamera),l.render(),i.trigger(E.RENDER,{type:E.RENDER,target:i,delta:t}))}}class Ae extends P.DataTextureLoader{constructor(e){super(e),this.type=P.HalfFloatType}parse(e){var t,i,s,r,n,a,o,h,l,c,d=-1,E=1,u=2,T=3,w=4,b=function(e,t){switch(e){case E:console.error("THREE.RGBELoader Read Error: "+(t||""));break;case u:console.error("THREE.RGBELoader Write Error: "+(t||""));break;case T:console.error("THREE.RGBELoader Bad File Format: "+(t||""));break;default:console.error("THREE.RGBELoader: Error: "+(t||""))}return d},_=1,p=2,m=4,v="\n",g=function(e,t,i){t=t||1024;for(var s=e.pos,r=-1,n=0,a="",o=String.fromCharCode.apply(null,new Uint16Array(e.subarray(s,s+128)));(r=o.indexOf(v))<0&&n<t&&s<e.byteLength;)a+=o,n+=o.length,s+=128,o+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(s,s+128)));return-1<r&&(!1!==i&&(e.pos+=n+r+1),a+o.slice(0,r))},e=new Uint8Array(e),f=(e.pos=0,function(e){var t,i,s=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,r=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,n=/^\s*FORMAT=(\S+)\s*$/,a=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,o={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};if(e.pos>=e.byteLength||!(t=g(e)))return b(E,"no header found");if(!(i=t.match(/^#\?(\S+)/)))return b(T,"bad initial token");for(o.valid|=_,o.programtype=i[1],o.string+=t+"\n";;){if(!1===(t=g(e)))break;if(o.string+=t+"\n","#"===t.charAt(0))o.comments+=t+"\n";else if((i=t.match(s))&&(o.gamma=parseFloat(i[1],10)),(i=t.match(r))&&(o.exposure=parseFloat(i[1],10)),(i=t.match(n))&&(o.valid|=p,o.format=i[1]),(i=t.match(a))&&(o.valid|=m,o.height=parseInt(i[1],10),o.width=parseInt(i[2],10)),o.valid&p&&o.valid&m)break}return o.valid&p?o.valid&m?o:b(T,"missing image size specifier"):b(T,"missing format specifier")}(e));if(d!==f){var x,S,y,R=f.width,L=f.height,A=function(e,t,i){var s=t;if(s<8||32767<s||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);if(s!==(e[2]<<8|e[3]))return b(T,"wrong scanline width");var r=new Uint8Array(4*t*i);if(!r.length)return b(w,"unable to allocate buffer space");for(var n=0,a=0,o=4*s,h=new Uint8Array(4),l=new Uint8Array(o),c=i;0<c&&a<e.byteLength;){if(a+4>e.byteLength)return b(E);if(h[0]=e[a++],h[1]=e[a++],h[2]=e[a++],h[3]=e[a++],2!=h[0]||2!=h[1]||(h[2]<<8|h[3])!=s)return b(T,"bad rgbe scanline format");for(var d=0,u=void 0;d<o&&a<e.byteLength;){var _=128<(u=e[a++]);if(_&&(u-=128),0===u||o<d+u)return b(T,"bad scanline data");if(_)for(var p=e[a++],m=0;m<u;m++)l[d++]=p;else l.set(e.subarray(a,a+u),d),d+=u,a+=u}for(var v=s,g=0;g<v;g++){var f=0;r[n]=l[g+0],f+=s,r[n+1]=l[g+f],f+=s,r[n+2]=l[g+f],f+=s,r[n+3]=l[g+f],n+=4}c--}return r}(e.subarray(e.pos),R,L);if(d!==A){switch(this.type){case P.UnsignedByteType:x=A,S=P.RGBEFormat,y=P.UnsignedByteType;break;case P.FloatType:for(var O=A.length/4,C=new Float32Array(3*O),M=0;M<O;M++)h=C,l=3*M,c=void 0,c=(a=A)[(o=4*M)+3],c=Math.pow(2,c-128)/255,h[l+0]=a[o+0]*c,h[l+1]=a[o+1]*c,h[l+2]=a[o+2]*c;x=C,S=P.RGBFormat,y=P.FloatType;break;case P.HalfFloatType:O=A.length/4;for(var D=new Uint16Array(3*O),I=0;I<O;I++)s=D,r=3*I,n=void 0,n=(t=A)[(i=4*I)+3],n=Math.pow(2,n-128)/255,s[r+0]=P.DataUtils.toHalfFloat(Math.min(t[i+0]*n,65504)),s[r+1]=P.DataUtils.toHalfFloat(Math.min(t[i+1]*n,65504)),s[r+2]=P.DataUtils.toHalfFloat(Math.min(t[i+2]*n,65504));x=D,S=P.RGBFormat,y=P.HalfFloatType;break;default:console.error("THREE.RGBELoader: unsupported type: ",this.type)}return{width:R,height:L,data:x,header:f.string,gamma:f.gamma,exposure:f.exposure,format:S,type:y}}}return null}setDataType(e){return this.type=e,this}load(e,i,t,s){return super.load(e,function(e,t){switch(e.type){case P.UnsignedByteType:e.encoding=P.RGBEEncoding,e.minFilter=P.NearestFilter,e.magFilter=P.NearestFilter,e.generateMipmaps=!1,e.flipY=!0;break;case P.FloatType:case P.HalfFloatType:e.encoding=P.LinearEncoding,e.minFilter=P.LinearFilter,e.magFilter=P.LinearFilter,e.generateMipmaps=!1,e.flipY=!0}i&&i(e,t)},t,s)}}class Oe{constructor(e){this._onLoadingProgress=(e,t,i)=>{var s=this._view3D;i.initialized=!0,i.lengthComputable=e.lengthComputable,i.loaded=e.loaded,i.total=e.total,s.trigger(E.PROGRESS,{type:E.PROGRESS,target:s,src:t,lengthComputable:e.lengthComputable,loaded:e.loaded,total:e.total})},this._view3D=e}}class Ce extends Oe{constructor(e){super(e)}load(r){const n=this._view3D;return new Promise((e,t)=>{var i=new P.TextureLoader;const s=X(n,r);i.setCrossOrigin(Te),i.load(r,e,e=>this._onLoadingProgress(e,r,s),e=>{s.initialized=!0,t(e)})})}loadHDRTexture(r){const n=this._view3D;return new Promise((t,i)=>{var e=new Ae;n.renderer.capabilities.halfFloat||(e.type=P.FloatType);const s=X(n,r);e.setCrossOrigin(Te),e.load(r,e=>{e.mapping=P.EquirectangularReflectionMapping,t(e)},e=>this._onLoadingProgress(e,r,s),e=>{s.initialized=!0,i(e)})})}}const Me=["alphaMap","aoMap","bumpMap","displacementMap","emissiveMap","envMap","lightMap","map","metalnessMap","normalMap","roughnessMap","sheenColorMap","sheenRoughnessMap","specularColorMap","specularIntensityMap","transmissionMap","clearcoatMap","clearcoatNormalMap"],T={HOLD:"hold",RELEASE:"release",ENABLE:"enable",DISABLE:"disable"},De=((t=v=v||{})[t.NONE=0]="NONE",t[t.ONE_FINGER_HORIZONTAL=1]="ONE_FINGER_HORIZONTAL",t[t.ONE_FINGER_VERTICAL=2]="ONE_FINGER_VERTICAL",t[t.ONE_FINGER=3]="ONE_FINGER",t[t.TWO_FINGER_HORIZONTAL=4]="TWO_FINGER_HORIZONTAL",t[t.TWO_FINGER_VERTICAL=8]="TWO_FINGER_VERTICAL",t[t.TWO_FINGER=12]="TWO_FINGER",t[t.PINCH=16]="PINCH","KHR_materials_variants"),Ie="EXT_View3D_texture_LOD",Pe="view3d-lod",Ne="view3d-annotation";var w,a,Fe={uniforms:{tDiffuse:{value:null},h:{value:1/512}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform float h;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 sum = vec4( 0.0 );\n\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;\n\n\t\t\tgl_FragColor = sum;\n\n\t\t}"},Ue={uniforms:{tDiffuse:{value:null},v:{value:1/512}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform float v;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 sum = vec4( 0.0 );\n\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;\n\t\t\tsum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;\n\n\t\t\tgl_FragColor = sum;\n\n\t\t}"};class Be{constructor(e,{darkness:t=.5,mapSize:i=9,blur:s=3.5,shadowScale:r=1,planeScale:n=2}={}){this._view3D=e,this._darkness=t,this._mapSize=i,this._blur=s,this._shadowScale=r,this._planeScale=n;t=e.renderer.threeRenderer,s=Math.min(Math.pow(2,Math.floor(i)),t.capabilities.maxTextureSize),this._root=new P.Group,this._renderTarget=new P.WebGLRenderTarget(s,s,{format:P.RGBAFormat}),this._blurTarget=new P.WebGLRenderTarget(s,s,{format:P.RGBAFormat}),this._renderTarget.texture.generateMipmaps=!1,this._blurTarget.texture.generateMipmaps=!1,r=new P.OrthographicCamera(-.5,.5,.5,-.5,0),r.rotation.x=Math.PI/2,this._shadowCamera=r,this._root.add(r),n=new P.OrthographicCamera(-.5,.5,.5,-.5,0);this._blurCamera=n,this._setupPlanes()}get root(){return this._root}get darkness(){return this._darkness}get mapSize(){return this._mapSize}get blur(){return this._blur}get shadowScale(){return this._shadowScale}get planeScale(){return this._planeScale}set darkness(e){this._plane.material.opacity=e,this._darkness=e}set blur(e){this._blur=e}set shadowScale(e){this._shadowScale=e;e=this._view3D.model;e&&this.updateDimensions(e)}updateDimensions(e){var t=this._root,i=this._shadowCamera,s=this._planeScale,r=e.bbox.getBoundingSphere(new P.Sphere),s=2*s*r.radius,n=this._shadowScale;i.far=n*(e.bbox.max.y-e.bbox.min.y)/s,i.rotation.set(Math.PI/2,Math.PI,0,"YXZ"),t.position.copy(r.center).setY(e.bbox.min.y),t.scale.setScalar(s),i.updateProjectionMatrix()}render(){this._plane.visible=!1;var e=this._view3D,{renderer:t,ar:i}=e,s=this._shadowCamera,t=t.threeRenderer,i=i.activeSession?i.activeSession.arScene:e.scene,e=t.xr.enabled,i=(t.xr.enabled=!1,i.root),r=i.background,n=(i.background=null,i.overrideMaterial=this._depthMaterial,t.getClearAlpha()),a=(t.setClearAlpha(0),t.getRenderTarget());t.setRenderTarget(this._renderTarget),t.clear(),t.render(i,s),i.overrideMaterial=null,this._blurShadow(this._blur),this._blurShadow(.4*this._blur),t.xr.enabled=e,t.setRenderTarget(a),t.setClearAlpha(n),i.background=r,this._plane.visible=!0}_blurShadow(e){var t=this._view3D["renderer"],i=this._blurCamera,t=t.threeRenderer,s=this._blurPlane,r=this._renderTarget,n=this._blurTarget,a=this._horizontalBlurMaterial,o=this._verticalBlurMaterial;s.visible=!0,a.uniforms.tDiffuse.value=r.texture,a.uniforms.h.value=+e/256,a.needsUpdate=!0,s.material=a,t.setRenderTarget(n),t.render(s,i),o.uniforms.tDiffuse.value=n.texture,o.uniforms.v.value=+e/256,o.needsUpdate=!0,s.material=o,t.setRenderTarget(r),t.render(s,i),s.visible=!1}_setupPlanes(){var e=this._root,t=new P.PlaneBufferGeometry,i=new P.MeshBasicMaterial({opacity:this._darkness,transparent:!0,side:P.BackSide,depthWrite:!1,map:this._renderTarget.texture}),i=new P.Mesh(t,i),e=(i.renderOrder=1,i.scale.set(-1,-1,1),i.rotation.order="YXZ",i.rotation.x=Math.PI/2,this._plane=i,e.add(i),new P.Mesh(t)),i=(this._blurPlane=e,new P.MeshDepthMaterial),t=(i.onBeforeCompile=e=>{e.fragmentShader=`
        `+e.fragmentShader.replace("gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );","gl_FragColor = vec4( vec3( 0.0 ), ( 1.0 - fragCoordZ ) * opacity );")},this._depthMaterial=i,new P.ShaderMaterial(Fe)),e=(t.depthTest=!1,this._horizontalBlurMaterial=t,new P.ShaderMaterial(Ue));e.depthTest=!1,this._verticalBlurMaterial=e}}class ke{static fromCubeTexture(e){for(var t=0,i=new P.Vector3,s=new P.Vector3,r=new P.Color,n=[0,0,0,0,0,0,0,0,0],a=new P.SphericalHarmonics3,o=a.coefficients,h=0;h<6;h++)for(var l=e.image[h],c=l.width,d=l.height,u=document.createElement("canvas"),u=(u.width=c,u.height=d,u.getContext("2d")),l=(u.drawImage(l,0,0,c,d),u.getImageData(0,0,c,d)),_=l.data,p=l.width,m=2/p,v=0,g=_.length;v<g;v+=4){r.setRGB(_[v]/255,_[v+1]/255,_[v+2]/255),He(r,e.encoding);var f=v/4,E=(f%p+.5)*m-1,T=1-(Math.floor(f/p)+.5)*m;switch(h){case 0:i.set(-1,T,-E);break;case 1:i.set(1,T,E);break;case 2:i.set(-E,1,-T);break;case 3:i.set(-E,-1,T);break;case 4:i.set(-E,T,1);break;case 5:i.set(E,T,-1)}var f=i.lengthSq(),w=4/(Math.sqrt(f)*f);t+=w,s.copy(i).normalize(),P.SphericalHarmonics3.getBasisAt(s,n);for(var b=0;b<9;b++)o[b].x+=n[b]*r.r*w,o[b].y+=n[b]*r.g*w,o[b].z+=n[b]*r.b*w}for(var x=4*Math.PI/t,S=0;S<9;S++)o[S].x*=x,o[S].y*=x,o[S].z*=x;return new P.LightProbe(a)}static fromCubeRenderTarget(e,t){for(var i=0,s=new P.Vector3,r=new P.Vector3,n=new P.Color,a=[0,0,0,0,0,0,0,0,0],o=new P.SphericalHarmonics3,h=o.coefficients,l=0;l<6;l++)for(var c=t.width,d=new Uint8Array(c*c*4),u=(e.readRenderTargetPixels(t,0,0,c,c,d,l),2/c),_=0,p=d.length;_<p;_+=4){n.setRGB(d[_]/255,d[_+1]/255,d[_+2]/255),He(n,t.texture.encoding);var m=_/4,v=(m%c+.5)*u-1,g=1-(Math.floor(m/c)+.5)*u;switch(l){case 0:s.set(1,g,-v);break;case 1:s.set(-1,g,v);break;case 2:s.set(v,1,-g);break;case 3:s.set(v,-1,g);break;case 4:s.set(v,g,1);break;case 5:s.set(-v,g,-1)}var m=s.lengthSq(),f=4/(Math.sqrt(m)*m);i+=f,r.copy(s).normalize(),P.SphericalHarmonics3.getBasisAt(r,a);for(var E=0;E<9;E++)h[E].x+=a[E]*n.r*f,h[E].y+=a[E]*n.g*f,h[E].z+=a[E]*n.b*f}for(var T=4*Math.PI/i,w=0;w<9;w++)h[w].x*=T,h[w].y*=T,h[w].z*=T;return new P.LightProbe(o)}}function He(e,t){switch(t){case P.sRGBEncoding:e.convertSRGBToLinear();break;case P.LinearEncoding:break;default:console.warn("WARNING: LightProbeGenerator convertColorToLinear() encountered an unsupported encoding.")}}class b{static createDefaultEnv(e){var t=new P.Scene,i=new P.PointLight(16777215,.8,20),i=(i.decay=2,i.position.set(0,7,0),t.add(i),new P.BoxBufferGeometry(1,1,1)),s=new P.MeshStandardMaterial({side:P.BackSide}),i=new P.Mesh(i,s),s=(i.castShadow=!1,i.scale.set(15,45,15),i.position.set(0,20,0),t.add(i),b._createRectAreaLightSource({intensity:4.5,width:4,height:4})),i=(s.position.set(0,2.5,0),s.rotateX(Math.PI/2),b._createRectAreaLightSource({intensity:3,width:2,height:2})),r=(i.position.set(0,1,4),i.lookAt(0,0,0),b._createRectAreaLightSource({intensity:3,width:2,height:2})),n=(r.position.set(-4,1,1),r.lookAt(0,0,0),b._createRectAreaLightSource({intensity:3,width:2,height:2})),a=(n.position.set(4,1,1),n.lookAt(0,0,0),b._createRectAreaLightSource({intensity:2.5,width:2,height:2})),o=(a.position.set(1.5,1,-4),a.lookAt(0,0,0),b._createRectAreaLightSource({intensity:2.5,width:2,height:2})),s=(o.position.set(-1.5,1,-4),o.lookAt(0,0,0),t.add(s,i,r,n,a,o),e.outputEncoding),i=e.toneMapping,r=(e.outputEncoding=P.LinearEncoding,e.toneMapping=P.NoToneMapping,new P.PMREMGenerator(e).fromScene(t,.035));return e.outputEncoding=s,e.toneMapping=i,r.texture}static createBlurredHDR(e,t){var e=e.renderer.threeRenderer,i=new P.Scene,t=(i.background=t,e.toneMappingExposure),s=(e.toneMappingExposure=1,new P.WebGLCubeRenderTarget(256,{encoding:P.sRGBEncoding,format:P.RGBAFormat})),r=new P.CubeCamera(.1,1e3,s),i=(r.update(e,i),ke.fromCubeRenderTarget(e,s)),n=new P.MeshStandardMaterial({side:P.BackSide}),a=new P.IcosahedronBufferGeometry(1,4),o=new P.Scene,n=new P.Mesh(a,n),h=a.getAttribute("normal");for(let e=0;e<h.count;e++)h.setXYZ(e,-h.getX(e),-h.getY(e),-h.getZ(e));return o.add(n),o.add(i),r.update(e,o),e.toneMappingExposure=t,s.texture}static _createRectAreaLightSource({intensity:e,width:t,height:i}){t=new P.PlaneBufferGeometry(t,i),i=new P.MeshBasicMaterial;return i.color.setScalar(e),new P.Mesh(t,i)}}class Ve{constructor(e){this._view3D=e,this._root=new P.Scene,this._userObjects=new P.Group,this._envObjects=new P.Group,this._fixedObjects=new P.Group,this._shadowPlane=new Be(e,Z(e.shadow));var t=this._root,i=this._userObjects,s=this._envObjects,r=this._fixedObjects,n=this._shadowPlane;i.name="userObjects",s.name="envObjects",r.name="fixedObjects",t.add(i,s,r),e.shadow&&r.add(n.root)}get root(){return this._root}get shadowPlane(){return this._shadowPlane}get userObjects(){return this._userObjects}get envObjects(){return this._envObjects}get fixedObjects(){return this._fixedObjects}reset({volatileOnly:e=!0}={}){this._removeChildsOf(this._userObjects),e||this._removeChildsOf(this._envObjects)}add(e,t=!0){t=t?this._userObjects:this._envObjects,e=Array.isArray(e)?e:[e];t.add(...e)}remove(e){e=Array.isArray(e)?e:[e];this._userObjects.remove(...e),this._envObjects.remove(...e)}setBackground(s){return Q(this,void 0,void 0,function*(){var e,t=this._view3D,i=this._root;"number"==typeof s||"#"===s.charAt(0)?i.background=new P.Color(s):((e=yield new Ce(t).load(s)).encoding=P.sRGBEncoding,i.background=e),t.renderer.renderSingleFrame()})}setSkybox(s){return Q(this,void 0,void 0,function*(){var e,t=this._root,i=this._view3D;t.background&&t.background.isTexture&&t.background.dispose(),s?(e=yield new Ce(i).loadHDRTexture(s),i.skyboxBlur?t.background=b.createBlurredHDR(i,e):t.background=e,t.environment=e):(t.background=null,t.environment=null),i.renderer.renderSingleFrame()})}setEnvMap(s){return Q(this,void 0,void 0,function*(){var e,t=this._view3D,i=this._root;s?(e=yield new Ce(t).loadHDRTexture(s),i.environment=e):i.environment=null,t.renderer.renderSingleFrame()})}initTextures(){var{skybox:e,envmap:t,background:i,useDefaultEnv:s}=this._view3D,r=[],s=(s&&this.setDefaultEnv(),e||t);return s&&(s=e?this.setSkybox(e):this.setEnvMap(t),r.push(s)),!e&&i&&r.push(this.setBackground(i)),r}setDefaultEnv(){var e=this._view3D.renderer,e=b.createDefaultEnv(e.threeRenderer);this._root.environment=e}_removeChildsOf(e){for(e.traverse(e=>{e.isMesh&&((e=e).geometry.dispose(),(Array.isArray(e.material)?e.material:[e.material]).forEach(t=>{Me.forEach(e=>{t[e]&&t[e].dispose()})}))});0<e.children.length;)e.remove(e.children[0])}}const x=be.EASE_OUT_CUBIC,Ge={min:0,max:1},ze={min:-1/0,max:1/0},We={min:-89.9,max:89.9},je={165:0,135:.4,0:1},Ke=[e.WEBXR,e.SCENE_VIEWER,e.QUICK_LOOK];class S{constructor({duration:e=300,loop:t=!1,range:i=Ge,easing:s=x}={}){this._duration=e,this._loop=t,this._range=i,this._easing=s,this._activated=!1,this.reset(0)}get val(){return this._val}get start(){return this._start}get end(){return this._end}get progress(){return this._progress}get duration(){return this._duration}get loop(){return this._loop}get range(){return this._range}get easing(){return this._easing}get activated(){return this._activated}set duration(e){this._duration=e}set loop(e){this._loop=e}set range(e){this._range=e}set easing(e){this._easing=e}update(e){var t,i,s,r,n;return this._activated?(t=this._start,i=this._end,n=this._duration,s=this._val,r=this._loop,e=this._progress+e/n,this._progress=(r?u:d)(e,0,1),n=this._easing(this._progress),this._val=H(t,i,n),!r&&1<=this._progress&&(this._activated=!1),this._val-s):0}reset(e){var t=this._range,e=d(e,t.min,t.max);this._start=e,this._end=e,this._val=e,this._progress=0,this._activated=!1}setEndDelta(e){var t=this._range;this._start=this._val,this._end=d(this._end+e,t.min,t.max),this._progress=0,this._activated=!0}}class Xe{constructor(e,t,i,{duration:s=300,easing:r=x,disableOnFinish:n=!0}={}){this._enabled=!1,this._finishCallbacks=[],this._view3D=e,this._motion=new S({duration:s,range:Ge,easing:r}),this._disableOnFinish=n,this.changeStartEnd(t,i)}get element(){return null}get enabled(){return this._enabled}get duration(){return this._motion.duration}get easing(){return this._motion.easing}get animating(){return this._motion.activated}set duration(e){this._motion.duration=e}set easing(e){this._motion.easing=e}destroy(){this.disable()}changeStartEnd(e,t){e=e.clone(),t=t.clone(),e.yaw=u(e.yaw,0,360),t.yaw=u(t.yaw,0,360),180<Math.abs(t.yaw-e.yaw)&&(t.yaw=t.yaw<e.yaw?t.yaw+360:t.yaw-360),this._from=e,this._to=t}update(e){var t,i,s,r;this._enabled&&(t=this._view3D.camera,i=this._from,s=this._to,(r=this._motion).update(e),e=r.val,t.yaw=H(i.yaw,s.yaw,e),t.pitch=H(i.pitch,s.pitch,e),t.zoom=H(i.zoom,s.zoom,e),t.pivot=i.pivot.clone().lerp(s.pivot,e),1<=e)&&(this._disableOnFinish&&this.disable(),this._finishCallbacks.forEach(e=>e()),this.clearFinished())}enable(){this._enabled||(this._enabled=!0,this.reset())}disable(){this._enabled&&(this._enabled=!1)}reset(){this._motion.reset(0),this._motion.setEndDelta(1)}onFinished(e){this._finishCallbacks.push(e)}clearFinished(){this._finishCallbacks=[]}resize(e){}sync(){}}class y{constructor(e,t,i,s=[0,0,0]){this.yaw=e,this.pitch=t,this.zoom=i,this.pivot=(new P.Vector3).fromArray(s)}clone(){return new y(this.yaw,this.pitch,this.zoom,this.pivot.toArray())}copy(e){this.yaw=e.yaw,this.pitch=e.pitch,this.zoom=e.zoom,this.pivot.copy(e.pivot)}equals(e){var{yaw:t,pitch:i,zoom:s,pivot:r}=this;return u(t,0,360)===u(e.yaw,0,360)&&i===e.pitch&&s===e.zoom&&r.equals(e.pivot)}}class qe{constructor(e){this._view3D=e,this._threeCamera=new P.PerspectiveCamera,this._maxTanHalfHFov=0,this._baseFov=45,this._baseDistance=0;var t=I(e.initialZoom)?e.initialZoom:0;this._defaultPose=new y(e.yaw,e.pitch,t),this._currentPose=this._defaultPose.clone(),this._newPose=this._currentPose.clone()}get threeCamera(){return this._threeCamera}get defaultPose(){return this._defaultPose}get currentPose(){return this._currentPose.clone()}get newPose(){return this._newPose}get yaw(){return this._currentPose.yaw}get pitch(){return this._currentPose.pitch}get zoom(){return this._currentPose.zoom}get distance(){return this._view3D.control.zoom.type===Se.FOV?this._baseDistance:this._baseDistance-this._currentPose.zoom}get baseDistance(){return this._baseDistance}get baseFov(){return this._baseFov}get pivot(){return this._currentPose.pivot}get fov(){return this._threeCamera.fov}get renderWidth(){return this.renderHeight*this._threeCamera.aspect}get renderHeight(){return 2*this.distance*Math.tan(_(this._threeCamera.getEffectiveFOV()/2))}set yaw(e){this._newPose.yaw=e}set pitch(e){this._newPose.pitch=e}set zoom(e){this._newPose.zoom=e}set pivot(e){this._newPose.pivot.copy(e)}set baseFov(e){this._baseFov=e}reset(e=0,t=x,i){var s=this._view3D;const r=s.control,n=s.autoPlayer,a=this._newPose,o=this._currentPose,h=null!=i?i:this._defaultPose;if(e<=0)return a.copy(h),o.copy(h),s.renderer.renderSingleFrame(),r.sync(),Promise.resolve();{const l=n.enabled,c=new Xe(s,o,h);return c.duration=e,c.easing=t,c.enable(),l&&n.disable(),r.add(c),new Promise(e=>{c.onFinished(()=>{a.copy(h),o.copy(h),r.remove(c),r.sync(),l&&n.enableAfterDelay(),e()})})}}resize({width:e,height:t},i=null){var{control:s,fov:r,maintainSize:n}=this._view3D;this._threeCamera.aspect=e/t,r===$?n&&null!=i?(e=t/i.height,n=this._currentPose.zoom,t=Math.tan(_((this._baseFov-n)/2)),this._baseFov=p(2*Math.atan(e*t))+n):this._applyEffectiveFov(45):this._baseFov=r,s.zoom.updateRange()}fit(e){var t=this._view3D,i=this._threeCamera,s=this._defaultPose,r=t.control,n=t.pivot,a=e.bbox,o=t.fov,h=o===$?45:o;const l=e.center;var c=t.ignoreCenterOnFit||t.center===$?(new P.Vector3).subVectors(a.max,a.min).lengthSq()/4:e.reduceVertices((e,t)=>Math.max(e,t.distanceToSquared(l)),0),c=Math.sqrt(c);const d=c/Math.sin(_(h/2));var u=e.reduceVertices((e,t)=>{var t=(new P.Vector3).subVectors(t,l),i=Math.hypot(t.x,t.z);return Math.max(e,i/(d-Math.abs(t.y)))},0);o===$?(this._maxTanHalfHFov=u,this._applyEffectiveFov(h)):this._maxTanHalfHFov=o,s.pivot=n===$?l.clone():ae(n,a),this._baseDistance=d,i.near=.1*(d-c),i.far=10*(d+c),r.zoom.updateRange(),I(t.initialZoom)?s.zoom=t.initialZoom:(u=this._baseFov,h=e.bbox,o=t.initialZoom.axis,n=t.initialZoom.ratio,c=(a=(new P.Vector3).subVectors(h.max,h.min))[o],r="y"===o?c/n:c/(n*i.aspect),e="z"!==o?d-a.z/2:d-a.x/2,t=p(2*Math.atan(r/(2*e))),s.zoom=u-t)}updatePosition(){var e=this._view3D,t=e.control,i=this._threeCamera,s=this._currentPose,r=this._newPose,n=this._baseFov,a=this._baseDistance,t=t.zoom.type===Se.FOV,o=s.clone(),n=(s.yaw=u(r.yaw,0,360),s.pitch=d(r.pitch,We.min,We.max),s.zoom=r.zoom,s.pivot.copy(r.pivot),t?n-s.zoom:n),t=t?a:a-s.zoom,a=j(t,s.yaw,s.pitch);a.add(s.pivot),i.fov=n,i.position.copy(a),i.lookAt(s.pivot),i.updateProjectionMatrix(),r.copy(s),e.trigger(E.CAMERA_CHANGE,{type:E.CAMERA_CHANGE,target:e,pose:s.clone(),prevPose:o})}_applyEffectiveFov(e){var t=this._threeCamera,e=Math.tan(_(e/2)),e=e*Math.max(1,this._maxTanHalfHFov/e/t.aspect);this._baseFov=p(2*Math.atan(e))}_parseBboxRatioOption(e,t){const s=t.min.toArray(),r=(new P.Vector3).subVectors(t.max,t.min).toArray();return e.map((e,t)=>{var i;return n(e)?(i=.01*parseFloat(e),s[t]+i*r[t]):e})}}class Ye{constructor(e){this._onResize=()=>{this._view3d.resize()},this._skipFirstResize=(()=>{let e=!0;return()=>{e?e=!1:this._onResize()}})(),this._view3d=e,this._enabled=!1,this._resizeObserver=null}get enabled(){return this._enabled}enable(){var e,t,i=this._view3d;return this._enabled&&this.disable(),i.useResizeObserver&&window.ResizeObserver?(t=0!==(t=(e=i.renderer.canvas).getBoundingClientRect()).width||0!==t.height,(t=new ResizeObserver(t?this._skipFirstResize:this._onResize)).observe(e),this._resizeObserver=t):(i.resize(),window.addEventListener(m.RESIZE,this._onResize)),this._enabled=!0,this}disable(){var e;return this._enabled&&((e=this._resizeObserver)?(e.disconnect(),this._resizeObserver=null):window.removeEventListener(m.RESIZE,this._onResize),this._enabled=!1),this}}class Ze{constructor(e){this._onAnimationLoop=t=>{var e=this._view3D,i=this._actions,s=this._clips,i=i.findIndex(e=>e===t.action);e.trigger(E.ANIMATION_LOOP,{type:E.ANIMATION_LOOP,target:e,index:i,action:t.action,clip:s[i]}),e.animationRepeatMode===Re.ALL&&(e=i+1>=s.length?0:i+1,this.play(e))},this._onAnimationFinished=t=>{var e=this._view3D,i=this._actions,s=this._clips,i=i.findIndex(e=>e===t.action);e.trigger(E.ANIMATION_FINISHED,{type:E.ANIMATION_FINISHED,target:e,index:i,action:t.action,clip:s[i]})},this._view3D=e,this._mixer=new P.AnimationMixer(e.scene.userObjects),this._clips=[],this._actions=[],this._activeAnimationIdx=-1,this._timeScale=1,this._fadePromises=[]}get clips(){return this._clips}get mixer(){return this._mixer}get actions(){return this._actions}get animationCount(){return this._clips.length}get activeAnimation(){var e;return null!=(e=this._clips[this._activeAnimationIdx])?e:null}get activeAction(){var e;return null!=(e=this._actions[this._activeAnimationIdx])?e:null}get activeAnimationIndex(){return this._activeAnimationIdx}get paused(){return 0===this._mixer.timeScale}get animating(){var e;return(null==(e=this.activeAction)?void 0:e.isRunning())&&!this.paused}get timeScale(){return this._timeScale}set timeScale(e){this._timeScale=e}init(){this._mixer.addEventListener("loop",this._onAnimationLoop),this._mixer.addEventListener("finished",this._onAnimationFinished)}destroy(){this.reset(),this._mixer.removeEventListener("loop",this._onAnimationLoop),this._mixer.removeEventListener("finished",this._onAnimationFinished)}setClips(e){const t=this._mixer;this._clips=e,this._actions=e.map(e=>{e=t.clipAction(e);return e.setEffectiveWeight(0),e}),this.updateRepeatMode()}play(e){var t=this._view3D,i=this._actions[e];i&&(this.stop(),this._restoreTimeScale(),i.setEffectiveTimeScale(1),i.setEffectiveWeight(1),i.play(),this._activeAnimationIdx=e,this._flushFadePromises(),t.trigger(E.ANIMATION_START,{type:E.ANIMATION_START,target:t,index:e,action:i,clip:this._clips[e]}))}crossFade(l,c,{synchronize:d=!1}={}){var u;return Q(this,void 0,void 0,function*(){const i=this._view3D,t=this._mixer;var e=this._actions,s=this._activeAnimationIdx;const r=e[l],n=null!=(u=e[s])?u:r,a="loop",o=(this._restoreTimeScale(),()=>{r.enabled=!0,r.setEffectiveTimeScale(1),r.setEffectiveWeight(1),r.time=0,r.play(),n.crossFadeTo(r,c/1e3,!0),this._activeAnimationIdx=l});if(d){const h=e=>{e.action===n&&(t.removeEventListener(a,h),o())};t.addEventListener(a,h)}else o();return this._flushFadePromises(),new Promise(e=>{const t=()=>{r.getEffectiveWeight()<1||(i.off(E.BEFORE_RENDER,t),e(!0))};i.on(E.BEFORE_RENDER,t),this._fadePromises.push({listener:t,resolve:e})})})}fadeOut(e){return Q(this,void 0,void 0,function*(){const i=this._view3D;const s=this._actions[this._activeAnimationIdx];return!!s&&(this._flushFadePromises(),this._restoreTimeScale(),s.fadeOut(e/1e3),new Promise(e=>{const t=()=>{0<s.getEffectiveWeight()||(i.off(E.BEFORE_RENDER,t),this._activeAnimationIdx=-1,e(!0))};i.on(E.BEFORE_RENDER,t),this._fadePromises.push({listener:t,resolve:e})}))})}pause(){this._mixer.timeScale=0}resume(){this._restoreTimeScale()}stop(){this._actions.forEach(e=>{e.stop(),e.setEffectiveWeight(0)}),this._view3D.renderer.renderSingleFrame(),this._activeAnimationIdx=-1,this._flushFadePromises()}update(e){this._mixer.update(e)}updateRepeatMode(){var e=this._view3D,t=this._actions;e.animationRepeatMode===Re.NONE?t.forEach(e=>{e.clampWhenFinished=!0,e.loop=P.LoopOnce}):t.forEach(e=>{e.clampWhenFinished=!1,e.loop=P.LoopRepeat})}reset(){var e=this._mixer;this.stop(),e.uncacheRoot(e.getRoot()),this._clips=[],this._actions=[]}_restoreTimeScale(){this._mixer.timeScale=this._timeScale}_flushFadePromises(){const i=this._view3D;this._fadePromises.forEach(({resolve:e,listener:t})=>{e(!1),i.off(E.BEFORE_RENDER,t)}),this._fadePromises=[]}}class Qe extends D{constructor({context:e=window,repeat:t=0,duration:i=300,easing:s=x}={}){super(),this._loop=()=>{var e=this._getDeltaTime(),t=this._duration,i=this._repeat,e=this._time+e,s=Math.floor(e/t),e=(this._time=(this._loopCount>=i?d:u)(e,0,t),this._time/t),r={progress:e,easedProgress:this._easing(e)};this.trigger("progress",r);for(let e=0;e<s;e++){if(this._loopCount++,this._loopCount>i)return this.trigger("finish"),void this.stop();this.trigger("loop",Object.assign(Object.assign({},r),{loopIndex:this._loopCount}))}this._rafId=this._ctx.requestAnimationFrame(this._loop)},this._repeat=t,this._duration=i,this._easing=s,this._ctx=e,this._rafId=-1,this._time=0,this._clock=0,this._loopCount=0}start(){0<=this._rafId||(this._updateClock(),this._loop())}stop(){this._rafId<0||(this._time=0,this._loopCount=0,this._stopLoop())}pause(){this._rafId<0||this._stopLoop()}_stopLoop(){this._ctx.cancelAnimationFrame(this._rafId),this._rafId=-1}_getDeltaTime(){var e=this._clock;return this._updateClock(),this._clock-e}_updateClock(){this._clock=Date.now()}}const $e={AR:"immersive-ar",VR:"immersive-vr"},Je={LOCAL:"local",LOCAL_FLOOR:"local-floor",VIEWER:"viewer"},R={SELECT_START:"selectstart",SELECT:"select",SELECT_END:"selectend",ESTIMATION_START:"estimationstart",ESTIMATION_END:"estimationend"},et={TOUCH:"generic-touchscreen"},tt={HIT_TEST:{requiredFeatures:["hit-test"]},DOM_OVERLAY:e=>e?{requiredFeatures:["dom-overlay"],domOverlay:{root:e}}:{},LIGHT_ESTIMATION:{optionalFeatures:["light-estimation"]}},it={},st={INTENT_AR_CORE:(e,t)=>`intent://arvr.google.com/scene-viewer/1.2?${e}#Intent;scheme=https;package=com.google.ar.core;action=android.intent.action.VIEW;${t?`S.browser_fallback_url=${t};`:""}end;`,INTENT_SEARCHBOX:(e,t)=>`intent://arvr.google.com/scene-viewer/1.2?${e}#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;${t?`S.browser_fallback_url=${t};`:""}end;`,FALLBACK_DEFAULT:e=>"https://arvr.google.com/scene-viewer?"+e};class rt{constructor({scale:e=1}={}){this.rotation=new P.Quaternion,this._axis=new P.Vector3(0,1,0),this._enabled=!1,this._active=!1,this._prevPos=new P.Vector2,this._fromQuat=new P.Quaternion,this._toQuat=new P.Quaternion,this._motion=new S({range:ze}),this._userScale=e}get enabled(){return this._enabled}get scale(){return this._userScale}set scale(e){this._userScale=e}updateRotation(e){this.rotation.copy(e),this._fromQuat.copy(e),this._toQuat.copy(e)}enable(){this._enabled=!0}disable(){this._enabled=!1}activate(){this._enabled&&(this._active=!0)}deactivate(){this._active=!1}updateAxis(e){this._axis.copy(e)}setInitialPos(e){this._prevPos.copy(e[0])}process({scene:e,xrCam:t},{coords:i}){var s,r;this._active&&1===i.length&&(s=this._prevPos,r=this._motion,i=i[0],e=e.modelMovable.getWorldPosition(new P.Vector3),e=(new P.Vector2).fromArray(e.project(t).toArray()),t=z(e,s,i)*this._userScale,e=(new P.Quaternion).setFromAxisAngle(this._axis,t),t=this._getInterpolatedQuaternion(),this._fromQuat.copy(t),this._toQuat.premultiply(e),r.reset(0),r.setEndDelta(1),s.copy(i))}update({scene:e},t){this._active&&(this._motion.update(t),t=this._getInterpolatedQuaternion(),this.rotation.copy(t),e.setModelRotation(t))}_getInterpolatedQuaternion(){var e=this._motion,t=this._toQuat,i=this._fromQuat,e=e.val;return(new P.Quaternion).copy(i).slerp(t,e)}}(t=w=w||{})[t.WAITING=0]="WAITING",t[t.TRANSLATING=1]="TRANSLATING",t[t.BOUNCING=2]="BOUNCING";class nt{constructor({hoverHeight:e=.1,bounceDuration:t=1e3,bounceEasing:i=be.EASE_OUT_BOUNCE}={}){this._hoverPosition=new P.Vector3,this._floorPosition=new P.Vector3,this._wallRotation=new P.Quaternion,this._dragPlane=new P.Plane,this._enabled=!1,this._vertical=!1,this._state=w.WAITING,this._initialPos=new P.Vector2,this._hoverHeight=e,this._bounceMotion=new S({duration:t,easing:i,range:ze})}get enabled(){return this._enabled}get floorPosition(){return this._floorPosition.clone()}get hoverHeight(){return this._hoverHeight}set hoverHeight(e){this._hoverHeight=e}enable(){this._enabled=!0}disable(){this.deactivate(),this._enabled=!1}activate(){this._enabled&&(this._dragPlane.constant=this._calcDragPlaneConstant(this._floorPosition),this._state=w.TRANSLATING)}deactivate(){var e,t,i;!this._enabled||this._vertical||this._state===w.WAITING?this._state=w.WAITING:(this._state=w.BOUNCING,e=this._floorPosition,i=this._hoverPosition,t=this._bounceMotion,i=i.y-e.y,t.reset(i),t.setEndDelta(-i))}init(e,t,i){this._floorPosition.copy(e),this._hoverPosition.copy(e);e=i?new P.Vector3(0,1,0).applyQuaternion(t):new P.Vector3(0,1,0);this._dragPlane.normal.copy(e),this._wallRotation.copy(t),this._vertical=i}setInitialPos(e){this._initialPos.copy(e[0])}process({frame:e,referenceSpace:t,xrCam:i},{hitResults:s}){var r=this._state,r=r===w.WAITING||r===w.BOUNCING;if(s&&1===s.length&&!r){var r=s[0],s=this._floorPosition.clone(),n=this._floorPosition,a=this._hoverPosition,o=this._hoverHeight,h=this._dragPlane,l=this._vertical,c=r.results[0]&&r.results[0].getPose(t),d=c&&(new P.Matrix4).fromArray(c.transform.matrix),u=c&&.75<d.elements[5],_=c&&d.elements[5]<.25,i=(new P.Vector3).setFromMatrixPosition(i.matrixWorld),d=c&&(new P.Vector3).setFromMatrixPosition(d);if(l){if(e&&(!c||!_))return(l=e.getPose(r.inputSource.targetRaySpace,t))?(_=l.transform.position,l=new P.Vector3(_.x,_.y,_.z).sub(i).normalize(),void((_=new P.Ray(i,l).intersectPlane(h,new P.Vector3))&&n.copy(_))):void 0;var l=new P.Vector3(0,1,0),_=c.transform.orientation,_=l.clone().applyQuaternion(new P.Quaternion(_.x,_.y,_.z,_.w)).normalize(),p=(new P.Vector3).crossVectors(new P.Vector3(0,1,0),_),m=new P.Vector3(0,1,0).applyQuaternion(this._wallRotation).normalize(),l=(Math.acos(Math.abs(m.dot(_)))>=Math.PI/18&&(m=(new P.Matrix4).makeBasis(p,l,_),(p=new P.Euler(0,0,0,"YXZ").setFromRotationMatrix(m)).z=0,p.x=Math.PI/2,this._wallRotation.setFromEuler(p),h.normal.copy(new P.Vector3(0,1,0).applyQuaternion(this._wallRotation)),h.constant=this._calcDragPlaneConstant(d)),(new P.Vector3).subVectors(d,i).normalize()),_=new P.Ray(i,l).intersectPlane(h,new P.Vector3);_&&n.copy(_)}else{if(e&&(!c||!u))return(m=e.getPose(r.inputSource.targetRaySpace,t))?(p=m.transform.position,l=new P.Vector3(p.x,p.y,p.z).sub(i).normalize(),void((_=new P.Ray(i,l).intersectPlane(h,new P.Vector3))&&(n.copy(_),n.setY(s.y),a.copy(_)))):void 0;c=-h.constant,u=d.y+o,e=(.1<u-c&&(h.constant=-u),(new P.Vector3).subVectors(d,i).normalize()),r=new P.Ray(i,e).intersectPlane(h,new P.Vector3);r&&(n.copy(r),n.setY(d.y),a.copy(r))}}}update({scene:e},t){var i=this._state,s=this._floorPosition,r=this._hoverPosition,n=this._bounceMotion,a=this._vertical;i===w.BOUNCING&&(n.update(t),r.setY(s.y+n.val),1<=n.progress)&&(this._state=w.WAITING),e.setRootPosition(s),a?e.setWallRotation(this._wallRotation):e.setModelHovering(r.y-s.y)}_calcDragPlaneConstant(e){var t=this._vertical,i=this._dragPlane.normal.clone(),i=new P.Plane(i,0),t=t?0:this._hoverHeight;return-(i.distanceToPoint(e)+t)}}class at{constructor({width:e=.1,padding:t=20,offset:i=.05,font:s="64px sans-serif",color:r="white"}={}){var n=document.createElement("canvas"),a=n.getContext("2d"),o=(a.font=s,a.measureText("100%")),h=o.actualBoundingBoxLeft+o.actualBoundingBoxRight,o=o.actualBoundingBoxAscent+o.actualBoundingBoxDescent,l=G(h),e=(n.width=l,e*((n.height=l)/h)),l=(this._ctx=a,this._canvas=n,this._height=e*o/h,this._texture=new P.CanvasTexture(n),new P.PlaneGeometry(e,e)),a=new P.Mesh(l,new P.MeshBasicMaterial({map:this._texture,transparent:!0,depthTest:!1}));this._mesh=a,this._font=s,this._color=r,this._padding=t,this._offset=i,this.hide()}get mesh(){return this._mesh}get height(){return this._height}get visible(){return this._mesh.visible}updatePosition(e,t,i){var s=this._mesh,i=this._height/2+this._offset+i,i=new P.Vector3(0,i,0).applyQuaternion(e.clone().invert());s.position.copy(i),s.lookAt(t)}updateScale(e){var t=this._ctx,i=this._canvas,s=this._padding,r=(100*e).toFixed(0),n=(t.clearRect(0,0,i.width,i.height),i.width/2),i=i.height/2,a=t.measureText(r+"%"),o=(a.actualBoundingBoxLeft+a.actualBoundingBoxRight)/2,a=(a.actualBoundingBoxAscent+a.actualBoundingBoxDescent)/2;t.beginPath(),t.moveTo(n-o,i-a-s),t.lineTo(n+o,i-a-s),t.quadraticCurveTo(n+o+s,i-a-s,n+o+s,i-a),t.lineTo(n+o+s,i+a),t.quadraticCurveTo(n+o+s,i+a+s,n+o,i+a+s),t.lineTo(n-o,i+a+s),t.quadraticCurveTo(n-o-s,i+a+s,n-o-s,i+a),t.lineTo(n-o-s,i-a),t.quadraticCurveTo(n-o-s,i-a-s,n-o,i-a-s),t.closePath(),t.lineWidth=5,t.fillStyle="rgba(0, 0, 0, 0.3)",t.fill(),t.stroke(),t.font=this._font,t.textAlign="center",t.textBaseline="middle",t.strokeStyle=this._color,t.fillStyle=this._color,t.fillText(r+"%",n,i),this._texture.needsUpdate=!0,this._mesh.scale.setScalar(1/e)}show(){this._mesh.visible=!0}hide(){this._mesh.visible=!1}}class ot{constructor({min:e=.05,max:t=5}={}){this._enabled=!1,this._active=!1,this._prevCoordDistance=-1,this._scaleMultiplier=1,this._ui=new at,this._motion=new S({duration:0,range:{min:e,max:t}}),this._motion.reset(1),this._ui=new at}get enabled(){return this._enabled}get scale(){return this._scaleMultiplier}get ui(){return this._ui}get range(){return this._motion.range}setInitialScale({scene:e,model:t,floorPosition:i,xrCam:s,initialScale:r}){var n=this._motion,a=n.range;if(r===$){var o=2*Math.atan(1/s.projectionMatrix.elements[5]),h=s.projectionMatrix.elements[0]/s.projectionMatrix.elements[5],s=s.position,l=t.bbox.max.y-t.bbox.min.y,s=s.distanceTo((new P.Vector3).addVectors(i,new P.Vector3(0,l/2,0)))*Math.tan(o/2),i=s*h,l=t.bbox.getBoundingSphere(new P.Sphere),o=s/l.radius,h=i/l.radius;const c=d(Math.min(h,o),a.min,1);n.reset(c)}else n.reset(d(r,a.min,a.max));const c=this._motion.val;this._scaleMultiplier=c,e.setModelScale(c)}setInitialPos(e){this._prevCoordDistance=(new P.Vector2).subVectors(e[0],e[1]).length()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.deactivate()}activate(e){this._active=!0,this._ui.show(),this._updateUIPosition(e)}deactivate(){this._active=!1,this._ui.hide(),this._prevCoordDistance=-1}process(e,{coords:t}){var i,s;2===t.length&&this._enabled&&this._active&&(i=this._motion,s=(t=(new P.Vector2).subVectors(t[0],t[1]).length())-this._prevCoordDistance,i.setEndDelta(s),this._prevCoordDistance=t,this._updateUIPosition(e))}update({scene:e},t){var i;this._enabled&&this._active&&((i=this._motion).update(t),this._scaleMultiplier=i.val,this._ui.updateScale(this._scaleMultiplier),e.setModelScale(this._scaleMultiplier))}_updateUIPosition({view3D:e,scene:t,xrCam:i,vertical:s}){e=e.model,i=(new P.Vector3).setFromMatrixPosition(i.matrixWorld),s=s?e.bbox.getBoundingSphere(new P.Sphere).radius:e.bbox.max.y-e.bbox.min.y;this._ui.updatePosition(t.root.quaternion,i,s)}}class ht{constructor({ringOpacity:e=.3,dirIndicatorOpacity:t=1,fadeoutDuration:i=1e3}={}){var s=Math.PI/18,r=new P.RingGeometry(.975,1,150,1,-6*s,30*s),s=(r.rotateX(-Math.PI/2),new P.RingGeometry(.96,1.015,30,1,25*s,4*s)),n=s.attributes["position"],a=Math.floor(11*n.count/16),o=Math.floor(13*n.count/16),h=Math.floor((o-a+1)/2),l=(new P.Vector3).fromBufferAttribute(n,a).y;for(let e=a;e<o;e++){var c=e-a,c=.025*(h-Math.abs(c-h));n.setY(e,l-c)}s.rotateX(-Math.PI/2);var d=new P.MeshBasicMaterial({transparent:!0,opacity:e,color:16777215}),u=new P.MeshBasicMaterial({transparent:!0,opacity:t,color:16777215}),r=new P.Mesh(r,d),d=new P.Mesh(s,u),s=new P.Group;s.add(r,d),s.position.setY(1e-4),this._mesh=s,this._ring=r,this._arrow=d,this._animator=new S({duration:i}),this._opacityRange={min:e,max:t},this.hide()}get mesh(){return this._mesh}updateSize(e){this._mesh.scale.setScalar(e.bbox.getBoundingSphere(new P.Sphere).radius)}update({delta:e,rotation:t}){var i,s,r=this._mesh,n=this._animator;r.visible&&(n.update(e),e=this._ring.material,i=this._arrow.material,s=this._opacityRange,e.opacity=n.val*s.min,i.opacity=n.val*s.max,n.val<=0&&(r.visible=!1),r.quaternion.copy(t),r.updateMatrix())}show(){this._mesh.visible=!0,this._animator.reset(1)}hide(){this._mesh.visible=!1}fadeout(){this._animator.setEndDelta(-1)}}(t=a=a||{})[t.WAITING=0]="WAITING",t[t.IN_DEADZONE=1]="IN_DEADZONE",t[t.OUT_OF_DEADZONE=2]="OUT_OF_DEADZONE";class lt{constructor({size:e=.1}={}){this._state=a.WAITING,this._detectedGesture=v.NONE,this._testingGestures=v.NONE,this._lastFingerCount=0,this._aspect=1,this._prevOneFingerPos=new P.Vector2,this._prevTwoFingerPos=new P.Vector2,this._initialTwoFingerDistance=0,this._prevOneFingerPosInitialized=!1,this._prevTwoFingerPosInitialized=!1,this._size=e}get size(){return this._size}get inDeadzone(){return this._state===a.IN_DEADZONE}set size(e){this._size=e}setAspect(e){this._aspect=e}setFirstInput(e){var t=e.length;1!==t||this._prevOneFingerPosInitialized?2!==t||this._prevTwoFingerPosInitialized||(this._prevTwoFingerPos.copy((new P.Vector2).addVectors(e[0],e[1]).multiplyScalar(.5)),this._initialTwoFingerDistance=(new P.Vector2).subVectors(e[0],e[1]).length(),this._prevTwoFingerPosInitialized=!0):(this._prevOneFingerPos.copy(e[0]),this._prevOneFingerPosInitialized=!0),this._lastFingerCount=t,this._state=a.IN_DEADZONE}addTestingGestures(...e){this._testingGestures=this._testingGestures|e.reduce((e,t)=>e|t,v.NONE)}cleanup(){this._testingGestures=v.NONE,this._lastFingerCount=0,this._prevOneFingerPosInitialized=!1,this._prevTwoFingerPosInitialized=!1,this._initialTwoFingerDistance=0,this._detectedGesture=v.NONE,this._state=a.WAITING}applyScreenAspect(e){const t=this._aspect;e.forEach(e=>{1<t?e.setY(e.y*t):e.setX(e.x/t)})}check(e){var t=this._state,i=this._size,s=this._testingGestures,r=this._lastFingerCount,n=e.length;if(t!==a.OUT_OF_DEADZONE){if(this._lastFingerCount=n,this.applyScreenAspect(e),n!==r)return this.setFirstInput(e),v.NONE;1===n?(t=e[0],r=this._prevOneFingerPos.clone(),(t=(new P.Vector2).subVectors(t,r)).length()>i&&(Math.abs(t.x)>Math.abs(t.y)?v.ONE_FINGER_HORIZONTAL&s&&(this._detectedGesture=v.ONE_FINGER_HORIZONTAL):v.ONE_FINGER_VERTICAL&s&&(this._detectedGesture=v.ONE_FINGER_VERTICAL))):2===n&&(r=(new P.Vector2).addVectors(e[1],e[0]).multiplyScalar(.5),t=this._prevTwoFingerPos.clone(),(n=(new P.Vector2).subVectors(r,t)).length()>i&&(Math.abs(n.x)>Math.abs(n.y)?v.TWO_FINGER_HORIZONTAL&s&&(this._detectedGesture=v.TWO_FINGER_HORIZONTAL):v.TWO_FINGER_VERTICAL&s&&(this._detectedGesture=v.TWO_FINGER_VERTICAL)),r=(new P.Vector2).subVectors(e[1],e[0]).length(),Math.abs(r-this._initialTwoFingerDistance)>i)&&v.PINCH&s&&(this._detectedGesture=v.PINCH),this._detectedGesture!==v.NONE&&(this._state=a.OUT_OF_DEADZONE)}return this._detectedGesture}}class ct{constructor(e,t,{rotate:i,translate:s,scale:r,ring:n,deadzone:a,initialScale:o}){this._onSelectStart=e=>{var e=e.frame,t=this._view3D,i=this._arScene,s=this._hitTestSource,r=this._deadzoneChecker,n=this._rotateControl,a=this._translateControl,o=this._scaleControl,h=t.renderer.threeRenderer,l=h.xr.getCamera(new P.PerspectiveCamera),h=h.xr.getReferenceSpace();!s||l.cameras.length<=0||(l=l.cameras[0],t=t.model,n.enabled&&r.addTestingGestures(v.ONE_FINGER),a.enabled&&r.addTestingGestures(v.ONE_FINGER),o.enabled&&r.addTestingGestures(v.PINCH),n=e.getHitTestResultsForTransientInput(s),a=this._hitResultToVector(n),r.applyScreenAspect(a),r.setFirstInput(a),1===a.length&&(o=e.getPose(n[0].inputSource.targetRaySpace,h))&&(s=(new P.Vector3).setFromMatrixPosition(l.matrixWorld),r=o.transform.position,a=new P.Vector3(r.x,r.y,r.z).sub(s).normalize(),e=new P.Ray(s,a),(n=t.bbox.getBoundingSphere(new P.Sphere)).applyMatrix4(i.modelMovable.matrixWorld),e.intersectSphere(n,new P.Vector3))&&(this._modelHit=!0),this._vertical&&!this._modelHit)||this._floorIndicator.show()},this._onSelectEnd=()=>{this._deactivate(),this._floorIndicator.fadeout()},this._view3D=e,this._arScene=t,this._vertical=!1,this._initialized=!1,this._modelHit=!1,this._hitTestSource=null,this._rotate=i,this._translate=s,this._scale=r,this._initialScale=o,this._rotateControl=new rt(Z(i)),this._translateControl=new nt(Z(s)),this._scaleControl=new ot(Z(r)),this._floorIndicator=new ht(n),this._deadzoneChecker=new lt(a)}get rotate(){return this._rotateControl}get translate(){return this._translateControl}get scale(){return this._scaleControl}init({model:n,session:a,size:o,vertical:h,hitPosition:l,hitRotation:c}){return Q(this,void 0,void 0,function*(){var e=this._arScene,t=this._translateControl,i=this._scaleControl,s=this._floorIndicator,r=this._deadzoneChecker,t=(this._vertical=h,t.init(l,c,h),r.setAspect(o.height/o.width),e.add(s.mesh,i.ui.mesh),this.syncTargetModel(n),yield a.requestHitTestSourceForTransientInput({profile:et.TOUCH}));this._hitTestSource=t,this._initialized=!0})}destroy(e){this._initialized&&(this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=null),this.disable(e),this._floorIndicator.hide(),this._scaleControl.ui.hide(),e.removeEventListener(R.SELECT_START,this._onSelectStart),e.removeEventListener(R.SELECT_END,this._onSelectEnd),this._initialized=!1)}enable(e){var t=this._rotate,i=this._translate,s=this._scale,r=this._rotateControl,n=this._translateControl,a=this._scaleControl,o=this._vertical;e.addEventListener(R.SELECT_START,this._onSelectStart),e.addEventListener(R.SELECT_END,this._onSelectEnd),t&&!o&&r.enable(),i&&n.enable(),s&&a.enable()}disable(e){var t=this._rotateControl,i=this._translateControl,s=this._scaleControl;e.removeEventListener(R.SELECT_START,this._onSelectStart),e.removeEventListener(R.SELECT_END,this._onSelectEnd),this._deactivate(),t.disable(),i.disable(),s.disable()}update(e){var{view3D:t,session:i,frame:s}=e,r=this._hitTestSource;r&&t.model&&(t=this._deadzoneChecker,i=i.inputSources,r=null!=(s=null==s?void 0:s.getHitTestResultsForTransientInput(r))?s:[],s={coords:this._hitResultToVector(r),inputSources:i,hitResults:r},t.inDeadzone?this._checkDeadzone(e,s):this._processInput(e,s),this._updateControls(e))}syncTargetModel(e){var t=this._initialScale,i=this._translateControl.floorPosition,s=this._view3D.renderer.threeRenderer.xr.getCamera(new P.PerspectiveCamera).cameras[0];this._floorIndicator.updateSize(e),this._scaleControl.setInitialScale({scene:this._arScene,model:e,floorPosition:i,xrCam:s,initialScale:t})}_deactivate(){this._modelHit=!1,this._deadzoneChecker.cleanup(),this._rotateControl.deactivate(),this._translateControl.deactivate(),this._scaleControl.deactivate()}_checkDeadzone(e,{coords:t}){var i=this._arScene,s=this._rotateControl,r=this._translateControl,n=this._scaleControl,a=this._deadzoneChecker.check(t.map(e=>e.clone()));if(a!==v.NONE)switch(a){case v.ONE_FINGER_HORIZONTAL:case v.ONE_FINGER_VERTICAL:(this._modelHit?(r.activate(),r):(s.activate(),s.updateRotation(i.modelMovable.quaternion),s)).setInitialPos(t);break;case v.PINCH:n.activate(e),n.setInitialPos(t)}}_processInput(e,t){this._rotateControl.process(e,t),this._translateControl.process(e,t),this._scaleControl.process(e,t)}_updateControls(e){var t=e["delta"],i=this._arScene,s=this._rotateControl,r=this._translateControl,n=this._scaleControl,a=this._floorIndicator,t=1e3*t,n=(s.update(e,t),r.update(e,t),n.update(e,t),s.rotation),e=r.floorPosition;i.setRootPosition(e),a.update({delta:t,rotation:n})}_hitResultToVector(e){return e.map(e=>(new P.Vector2).set(e.inputSource.gamepad.axes[0],-e.inputSource.gamepad.axes[1]))}}class dt{constructor(){this._root=new P.Scene,this._modelRoot=new P.Group,this._modelMovable=new P.Group,this._modelFixed=new P.Group,this._arRoot=new P.Group;var e=this._root,t=this._modelRoot,i=this._modelMovable,s=this._modelFixed,r=this._arRoot;t.add(i),e.add(t,s,r)}get root(){return this._root}get modelRoot(){return this._modelRoot}get modelMovable(){return this._modelMovable}get arRoot(){return this._arRoot}init(e){var t=this._root,i=this._modelMovable,s=this._modelFixed,e=e.scene;i.add(e.userObjects,e.envObjects),s.add(e.fixedObjects),t.environment=e.root.environment,this.hideModel()}destroy(e){var t=this._modelMovable,i=this._modelFixed;const s=e.scene;[...t.children,...i.children].forEach(e=>{s.root.add(e)})}showModel(){this._modelRoot.visible=!0}hideModel(){this._modelRoot.visible=!1}add(...e){this._arRoot.add(...e)}remove(...e){this._arRoot.remove(...e)}setRootPosition(e){this._root.position.copy(e)}setWallRotation(e){this._root.quaternion.copy(e)}updateModelRootPosition(e,t){var i=this._modelRoot;t&&(t=e.bbox.max.y-e.bbox.min.y,i.position.setZ(t/2),i.position.setY(-e.bbox.min.z),i.rotateX(-Math.PI/2),i.updateMatrix())}setModelHovering(e){this._modelMovable.position.setY(e)}setModelRotation(e){this._modelMovable.quaternion.copy(e)}setModelScale(e){this._root.scale.setScalar(e)}}class ut{constructor(){this._root=null}static isAvailable(){return null!=window.XRDOMOverlayState}get root(){return this._root}destroy(){this._root=null}getFeatures(e){return this._root=e,tt.DOM_OVERLAY(e)}}class _t{constructor(){this._source=null}static isAvailable(){return window.XRSession&&window.XRSession.prototype.requestHitTestSource}get ready(){return null!=this._source}destroy(){this._source&&(this._source.cancel(),this._source=null)}init(t){t.requestReferenceSpace(Je.VIEWER).then(e=>{t.requestHitTestSource({space:e}).then(e=>{this._source=e})})}getFeatures(){return tt.HIT_TEST}getResults(e){return null!=(e=null==e?void 0:e.getHitTestResults(this._source))?e:[]}}class pt{constructor(e,t,i,s,r){this.xrLight=e,this.renderer=t,this.lightProbe=i,this.xrWebGLBinding=null,this.estimationStartCallback=r,this.frameCallback=this.onXRFrame.bind(this);i=t.xr.getSession();if(s&&"XRWebGLBinding"in window){var r=new P.WebGLCubeRenderTarget(16),n=(e.environment=r.texture,t.getContext());switch(i.preferredReflectionFormat){case"srgba8":n.getExtension("EXT_sRGB");break;case"rgba16f":n.getExtension("OES_texture_half_float")}this.xrWebGLBinding=new XRWebGLBinding(i,n),this.lightProbe.addEventListener("reflectionchange",()=>{this.updateReflection()})}i.requestAnimationFrame(this.frameCallback)}updateReflection(){var e,t=this.renderer.properties.get(this.xrLight.environment);t&&(e=this.xrWebGLBinding.getReflectionCubeMap(this.lightProbe))&&(t.__webglTexture=e)}onXRFrame(e,t){var i;this.xrLight&&(t.session.requestAnimationFrame(this.frameCallback),t=t.getLightEstimate(this.lightProbe))&&(this.xrLight.lightProbe.sh.fromArray(t.sphericalHarmonicsCoefficients),this.xrLight.lightProbe.intensity=1,i=Math.max(1,Math.max(t.primaryLightIntensity.x,Math.max(t.primaryLightIntensity.y,t.primaryLightIntensity.z))),this.xrLight.directionalLight.color.setRGB(t.primaryLightIntensity.x/i,t.primaryLightIntensity.y/i,t.primaryLightIntensity.z/i),this.xrLight.directionalLight.intensity=i,this.xrLight.directionalLight.position.copy(t.primaryLightDirection),this.estimationStartCallback)&&(this.estimationStartCallback(),this.estimationStartCallback=null)}dispose(){this.xrLight=null,this.renderer=null,this.lightProbe=null,this.xrWebGLBinding=null}}class mt extends P.Group{constructor(t){var i=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],s=(super(),this.lightProbe=new P.LightProbe,this.lightProbe.intensity=0,this.add(this.lightProbe),this.directionalLight=new P.DirectionalLight,this.directionalLight.intensity=0,this.add(this.directionalLight),this.environment=null),r=!1;t.xr.addEventListener("sessionstart",()=>{var e=t.xr.getSession();"requestLightProbe"in e&&e.requestLightProbe({reflectionFormat:e.preferredReflectionFormat}).then(e=>{s=new pt(this,t,e,i,()=>{r=!0,this.dispatchEvent({type:"estimationstart"})})})}),t.xr.addEventListener("sessionend",()=>{s&&(s.dispose(),s=null),r&&this.dispatchEvent({type:"estimationend"})}),this.dispose=()=>{s&&(s.dispose(),s=null),this.remove(this.lightProbe),this.lightProbe=null,this.remove(this.directionalLight),this.directionalLight=null,this.environment=null}}}class vt{constructor(e,t){this._onEstimationStart=()=>{var e=this._light,t=this._arScene;e&&(t.add(e),e.environment)&&(t.root.environment=e.environment)},this._onEstimationEnd=()=>{var e=this._light,t=this._arScene;e&&(t.remove(e),t.root.environment=this._origEnvironment)},this._view3D=e,this._arScene=t,this._light=null,this._origEnvironment=null}static isAvailable(){return!0}getFeatures(){return tt.LIGHT_ESTIMATION}init(){var e=this._view3D.renderer.threeRenderer,e=new mt(e);(this._light=e).addEventListener(R.ESTIMATION_START,this._onEstimationStart),e.addEventListener(R.ESTIMATION_END,this._onEstimationEnd)}destroy(){var e=this._light;e&&(e.removeEventListener(R.ESTIMATION_START,this._onEstimationStart),e.removeEventListener(R.ESTIMATION_END,this._onEstimationEnd),this._light=null)}}class gt{constructor(e,{features:t=it,vertical:i=!1,overlayRoot:s=null,useLightEstimation:r=!0,rotate:n=!0,translate:a=!0,scale:o=!0,ring:h={},deadzone:l={},initialScale:c=$}={}){this._view3D=e,this._modelPlaced=!1,this.features=t,this.vertical=i,this.overlayRoot=s,this.useLightEstimation=r,this._arScene=new dt,this._control=new ct(e,this._arScene,{rotate:n,translate:a,scale:o,ring:h,deadzone:l,initialScale:c}),this._hitTest=new _t,this._domOverlay=new ut,this._lightEstimation=new vt(e,this._arScene)}static isAvailable(){return navigator.xr&&navigator.xr.isSessionSupported&&_t.isAvailable()&&ut.isAvailable()?navigator.xr.isSessionSupported($e.AR):Promise.resolve(!1)}get control(){return this._control}get arScene(){return this._arScene}get hitTest(){return this._hitTest}get domOverlay(){return this._domOverlay}get lightEstimation(){return this._lightEstimation}enter(){return Q(this,void 0,void 0,function*(){const o=this._view3D,h=o.scene,l=this._arScene,e=o.renderer,c=e.threeRenderer,d=this._control;var t=this._hitTest;const i=this._domOverlay;var s=this.useLightEstimation;const r=this._lightEstimation,u=this.vertical;var n=this._getAllXRFeatures();c.xr.enabled=!0,s&&r.init();const _=yield navigator.xr.requestSession($e.AR,n),a=c.getPixelRatio();c.setPixelRatio(1),c.xr.setReferenceSpaceType(Je.LOCAL),yield c.xr.setSession(_),l.init(o),t.init(_);_.addEventListener("end",()=>Q(this,void 0,void 0,function*(){d.destroy(_),l.destroy(o),r.destroy(),i.destroy(),c.setPixelRatio(a),e.stopAnimationLoop(),e.setAnimationLoop(e.defaultRenderLoop),o.trigger(E.AR_END,{target:o,type:E.AR_END,session:this})}),{once:!0});const p=new P.Vector2(window.outerWidth,window.outerHeight),m=new P.Clock;m.start(),e.stopAnimationLoop(),c.xr.setAnimationLoop((e,t)=>{var i,s,r,n=c.xr.getCamera(new P.PerspectiveCamera),a=m.getDelta();n.cameras.length<=0||(n=n.cameras[0],i=c.xr.getReferenceSpace(),s={width:null!=(r=null==(s=_.renderState.baseLayer)?void 0:s.framebufferWidth)?r:1,height:null!=(r=null==s?void 0:s.framebufferHeight)?r:1},r={view3D:o,scene:l,session:_,delta:a,frame:t,vertical:u,referenceSpace:i,xrCam:n,size:s},t=1e3*a,o.trigger(E.BEFORE_RENDER,{type:E.BEFORE_RENDER,target:o,delta:t}),this._modelPlaced?(o.animator.update(a),d.update(r),h.shadowPlane.render(),c.render(l.root,n),o.annotation.render(n,p)):this._initModelPosition(r),o.trigger(E.RENDER,{type:E.RENDER,target:o,delta:t}))}),o.trigger(E.AR_START,{type:E.AR_START,target:o,session:this})})}exit(){return Q(this,void 0,void 0,function*(){var e=this._view3D.renderer.threeRenderer.xr.getSession();return null==e?void 0:e.end()})}_getAllXRFeatures(){var e=this.features,t=null!=(t=F(this.overlayRoot))?t:this._createARRootElement();return V({},this._domOverlay.getFeatures(t),this._hitTest.getFeatures(),this._lightEstimation.getFeatures(),e)}_initModelPosition(e){const{frame:t,session:i,size:s,vertical:r,referenceSpace:n}=e;var e=this._view3D,a=e.model;const o=this._arScene;var h=this._hitTest;if(h.ready&&a){const p=this._control;var l=h.getResults(t);if(!(l.length<=0)){l=l[0].getPose(n);if(l){var c=(new P.Matrix4).fromArray(l.transform.matrix);if(!(!r&&c.elements[5]<.75||r&&(.25<=c.elements[5]||c.elements[5]<=-.25))){var d,u,c=(new P.Vector3).setFromMatrixPosition(c),_=new P.Quaternion;r&&(u=new P.Vector3(0,1,0),l=l.transform.orientation,l=u.clone().applyQuaternion(new P.Quaternion(l.x,l.y,l.z,l.w)).normalize(),d=(new P.Vector3).crossVectors(new P.Vector3(0,1,0),l),d=(new P.Matrix4).makeBasis(d,u,l),(u=new P.Euler(0,0,0,"YXZ").setFromRotationMatrix(d)).z=0,u.x=Math.PI/2,_.setFromEuler(u),o.setWallRotation(_)),o.updateModelRootPosition(a,r),o.setRootPosition(c),o.showModel(),h.destroy(),this._modelPlaced=!0,e.trigger(E.AR_MODEL_PLACED,{type:E.AR_MODEL_PLACED,target:e,session:this,model:a}),p.init({model:a,vertical:r,session:i,size:s,hitPosition:c,hitRotation:_});const m=p.scale.scale;l=new Qe({context:i,duration:1e3});l.on("progress",e=>{o.setModelScale(e.easedProgress*m)}),l.on("finish",()=>{o.setModelScale(m),p.enable(i)}),l.start()}}}}}_createARRootElement(){const e=this._view3D,t=document.createElement(f);return t.classList.add("view3d-ar-overlay"),e.rootEl.appendChild(t),e.once(E.AR_END,()=>{e.rootEl.removeChild(t)}),t}}gt.type=e.WEBXR;class ft{constructor(e,t={}){var{file:i=null,mode:s=ye.ONLY_AR,fallbackURL:r=null,title:n=null,link:a=null,sound:o=null,resizable:h=!0,vertical:l=!1,disableOcclusion:c=!1,initialScale:d=$,shareText:u=null}=t,t=oe(t,["file","mode","fallbackURL","title","link","sound","resizable","vertical","disableOcclusion","initialScale","shareText"]);this._view3D=e,this.file=i,this.fallbackURL=r,this.mode=s,this.title=n,this.link=a,this.sound=o,this.resizable=h,this.vertical=l,this.disableOcclusion=c,this.initialScale=d,this.shareText=u,this.otherParams=t}static isAvailable(){return Promise.resolve(/android/i.test(navigator.userAgent))}enter(){var s;return Q(this,void 0,void 0,function*(){var e=this._view3D.model;const t=Object.assign({title:this.title,link:this.link,sound:this.sound,mode:this.mode,initial_scale:this.initialScale},this.otherParams);t.resizable=W(this.resizable),t.enable_vertical_placement=W(this.vertical),t.disable_occlusion=W(this.disableOcclusion),t.share_text=this.shareText?encodeURIComponent(this.shareText):null;var i=null!=(s=this.file)?s:e.src;if(!i)return Promise.reject(new h(c.FILE_NOT_SUPPORTED(null!=(s=this.file)?s:e.src),l.FILE_NOT_SUPPORTED));t.file=new URL(i,window.location.href).href;e=this.fallbackURL,i=Object.keys(t).filter(e=>null!=t[e]).map(e=>e+"="+t[e]).join("&"),e=t.mode===ye.ONLY_AR?st.INTENT_AR_CORE(i,e):st.INTENT_SEARCHBOX(i,e||st.FALLBACK_DEFAULT(i)),i=document.createElement("a");i.href=e,i.click()})}exit(){return Promise.resolve()}}ft.type=e.SCENE_VIEWER;class Et{constructor(e,{allowsContentScaling:t=!0,canonicalWebPageURL:i=null,applePayButtonType:s=null,callToAction:r=null,checkoutTitle:n=null,checkoutSubtitle:a=null,price:o=null,custom:h=null,customHeight:l=null}={}){this._view3D=e,this.allowsContentScaling=t,this.canonicalWebPageURL=i,this.applePayButtonType=s,this.callToAction=r,this.checkoutTitle=n,this.checkoutSubtitle=a,this.price=o,this.custom=h,this.customHeight=l}static isAvailable(){return Promise.resolve((e=document.createElement("a")).relList&&e.relList.supports&&e.relList.supports("ar")&&(/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&1<navigator.maxTouchPoints));var e}enter(){const t=this._view3D;var e,i,s,r,n,a,o=t.iosSrc;return o?(e=this.canonicalWebPageURL,i=this.custom,s=window.location.href,(r=document.createElement("a")).setAttribute("rel","ar"),r.appendChild(document.createElement("img")),n=Object.entries({applePayButtonType:this.applePayButtonType,callToAction:this.callToAction,checkoutTitle:this.checkoutTitle,checkoutSubtitle:this.checkoutSubtitle,price:this.price,customHeight:this.customHeight}).reduce((e,[t,i])=>(i&&(e[t]=i),e),{}),a=new URL(o,s),this.allowsContentScaling||(n.allowsContentScaling="0"),e&&(n.canonicalWebPageURL=new URL(e,s).href),i&&(n.custom=new URL(i,s).href),a.hash=new URLSearchParams(n).toString(),r.setAttribute("href",a.href),r.addEventListener("message",e=>{"_apple_ar_quicklook_button_tapped"===e.data&&t.trigger(E.QUICK_LOOK_TAP,Object.assign(Object.assign({},e),{type:E.QUICK_LOOK_TAP,target:t}))},!1),r.click(),Promise.resolve()):Promise.reject(new h(c.FILE_NOT_SUPPORTED(""+o),l.FILE_NOT_SUPPORTED))}exit(){return Promise.resolve()}}Et.type=e.QUICK_LOOK;const Tt={[e.WEBXR]:gt,[e.SCENE_VIEWER]:ft,[e.QUICK_LOOK]:Et};class wt{constructor(e){this._view3D=e,this._activeSession=null,e.on(E.AR_START,({session:e})=>{this._activeSession=e}),e.on(E.AR_END,()=>{this._activeSession=null})}get activeSession(){return this._activeSession}isAvailable(){return Q(this,void 0,void 0,function*(){var e=this._getSesssionClasses();return(yield Promise.all(e.map(e=>e.isAvailable()))).some(e=>!0===e)})}enter(){return Q(this,void 0,void 0,function*(){var e=this._view3D;if(!e.model||!e.initialized)throw new h(c.NOT_INITIALIZED,l.NOT_INITIALIZED);for(const t of this._getSesssionClasses())try{if(yield t.isAvailable())return yield new t(e,Z(e[t.type])).enter(),Promise.resolve()}catch(e){}return Promise.reject()})}exit(){return Q(this,void 0,void 0,function*(){var e=this._activeSession;null!=e&&e.exit()})}_getSesssionClasses(){return this._getUsingSessionTypes().map(e=>Tt[e])}_getUsingSessionTypes(){const t=this._view3D;return t.arPriority.filter(e=>!!t[e])}}class bt{constructor(e,{element:t=null,focus:i=[],focusDuration:s=1e3,focusOffset:r=[],baseFov:n=45,baseDistance:a=null}={}){this._onClick=()=>{this.focus()},this._onWheel=e=>{e.preventDefault(),e.stopPropagation()},this._view3D=e,this._element=t,this._focus=i,this._focusDuration=s,this._focusOffset=r,this._baseFov=n,this._baseDistance=a,this._enabled=!1,this._hidden=!1,this._focusing=!1,this._tooltipSize=new P.Vector2,t&&(t.draggable=!1,this.resize())}get element(){return this._element}get renderable(){return!!this._element}get focusing(){return this._focusing}get focusPose(){return this._focus}get focusDuration(){return this._focusDuration}get focusOffset(){return this._focusOffset}get baseFov(){return this._baseFov}get baseDistance(){return this._baseDistance}get hidden(){return this._hidden}set focusDuration(e){this._focusDuration=e}set baseFov(e){this._baseFov=e}set baseDistance(e){this._baseDistance=e}destroy(){var e=this._view3D.annotation.wrapper,t=this._element;this.disableEvents(),t&&t.parentElement===e&&e.removeChild(t)}resize(){var e=this._element;e&&(e=e.querySelector("."+J.ANNOTATION_TOOLTIP))&&this._tooltipSize.set(e.offsetWidth,e.offsetHeight)}render({screenPos:e,screenSize:t,renderOrder:i}){var s=this._element,r=this._tooltipSize;s&&!this._hidden&&(s.style.zIndex=""+(i+1),s.style.transform=`translate(-50%, -50%) translate(${e.x}px, ${e.y}px)`,e.y+r.y>t.y?s.classList.add(J.ANNOTATION_FLIP_Y):s.classList.remove(J.ANNOTATION_FLIP_Y),e.x+r.x>t.x?s.classList.add(J.ANNOTATION_FLIP_X):s.classList.remove(J.ANNOTATION_FLIP_X))}show(){var e=this._element;this._hidden=!1,e&&e.classList.remove(J.ANNOTATION_HIDDEN)}hide(){var e=this._element;this._hidden=!0,e&&e.classList.add(J.ANNOTATION_HIDDEN)}setOpacity(e){var t=this._element;t&&(t.style.opacity=""+e)}enableEvents(){var e=this._element;e&&!this._enabled&&(e.addEventListener(m.CLICK,this._onClick),e.addEventListener(m.WHEEL,this._onWheel),this._enabled=!0)}disableEvents(){var e=this._element;e&&this._enabled&&(e.removeEventListener(m.CLICK,this._onClick),e.removeEventListener(m.WHEEL,this._onWheel),this._enabled=!1)}handleUserInput(){this._focusing&&this._view3D.annotationAutoUnfocus&&this.unfocus()}_getFocus(){var e=this._view3D,t=(new P.Vector3).fromArray(this._focus),i=e.camera.baseDistance,s=this._baseFov,r=(null!=(r=this._baseDistance)?r:i)*Math.tan(_((s-t.z)/2)),s=2*p(Math.atan(r/i));return t.z=e.camera.baseFov-s,t}_getPivotOffset(){var e,t=this._focusOffset;return new P.Vector3(null!=(e=t[0])?e:0,null!=(e=t[1])?e:0,null!=(e=t[2])?e:0)}_onFocus(){var e=this._view3D,t=this._element;e.annotation.list.forEach(e=>{e._focusing&&e.unfocus()}),t&&t.classList.add(J.ANNOTATION_SELECTED),this._focusing=!0,e.trigger(E.ANNOTATION_FOCUS,{type:E.ANNOTATION_FOCUS,target:e,annotation:this})}_onUnfocus(){var e=this._view3D,t=this._element;t&&t.classList.remove(J.ANNOTATION_SELECTED),this._focusing=!1,e.trigger(E.ANNOTATION_UNFOCUS,{type:E.ANNOTATION_UNFOCUS,target:e,annotation:this})}}class xt extends bt{constructor(e,t={}){var{position:i=[]}=t;super(e,oe(t,["position"])),this._position=(new P.Vector3).fromArray(i)}get position(){return this._position}focus(){return Q(this,void 0,void 0,function*(){if(!this._focusing){var t=this._view3D["camera"],i=this._focus;let e;var s,r=this._getPivotOffset(),r=(new P.Vector3).addVectors(this._position,r);return e=0<i.length?(i=this._getFocus(),new y(i.x,i.y,i.z,r.toArray())):(i=this._calculateNormalFromModelCenter(),{yaw:i,pitch:s}=K(i),new y(p(i),p(s),0,r.toArray())),window.addEventListener(m.CLICK,()=>{this.unfocus()},{once:!0,capture:!0}),this._onFocus(),e.equals(t.currentPose)?Promise.resolve():t.reset(this._focusDuration,x,e)}})}unfocus(){this._focusing&&this._onUnfocus()}toJSON(){return{position:this._position.toArray(),focus:this._focus,duration:this._focusDuration,focusOffset:this._focusOffset}}_calculateNormalFromModelCenter(){var e=this._view3D.model,e=e?e.bbox.getCenter(new P.Vector3):new P.Vector3;return(new P.Vector3).subVectors(this._position,e).normalize()}}class St extends bt{constructor(e,t={}){var{meshIndex:i=-1,faceIndex:s=-1,weights:r=k(3).map(()=>1/3)}=t;super(e,oe(t,["meshIndex","faceIndex","weights"])),this._meshIndex=i,this._faceIndex=s,this._weights=r,this._trackingControl=null}get position(){return this._getPosition()}get renderable(){return!!this._element&&0<=this._meshIndex&&0<=this._faceIndex}get meshIndex(){return this._meshIndex}get faceIndex(){return this._faceIndex}get weights(){return this._weights}focus(){return Q(this,void 0,void 0,function*(){var e,t,i,s,r;this._focusing||({camera:t,control:i}=e=this._view3D,s=this._getFocus(),r=this._getFocusPivot(),s=new y(s.x,s.y,s.z,r.toArray()),r=new Xe(e,t.currentPose,s,{duration:this._focusDuration,disableOnFinish:!1}),(this._trackingControl=r).enable(),i.add(r),this._onFocus())})}unfocus(){this._focusing&&(this.destroyTrackingControl(),this._onUnfocus())}render(e){super.render(e);var t,i,s,e=this._trackingControl;e&&(t=this._view3D["camera"],s=this._getFocus(),i=this._getFocusPivot(),s=new y(s.x,s.y,s.z,i.toArray()),e.changeStartEnd(t.currentPose,s),e.reset())}handleUserInput(){this._focusing&&(this._view3D.annotationAutoUnfocus?this.unfocus():this.destroyTrackingControl())}toJSON(){return{meshIndex:this._meshIndex,faceIndex:this._faceIndex,focus:this._focus,duration:this._focusDuration,focusOffset:this._focusOffset}}destroyTrackingControl(){var e=this._view3D["control"],t=this._trackingControl;t&&(e.sync(),e.remove(t),t.destroy(),this._trackingControl=null)}_getPosition(){var e=this._view3D.model,t=this._meshIndex,i=this._faceIndex,s=this._weights,e=re(e,t,i);return e?(new P.Vector3).addScaledVector(e[0],s[0]).addScaledVector(e[1],s[1]).addScaledVector(e[2],s[2]):new P.Vector3}_getFocusPivot(){var e=this._getPosition(),t=this._getPivotOffset();return(new P.Vector3).addVectors(e,t)}}class yt{constructor(e){this._onInput=()=>{this._list.forEach(e=>{e.handleUserInput()})},this._view3D=e,this._list=[],this._wrapper=F(e.annotationWrapper,e.rootEl)||this._createWrapper()}get list(){return this._list}get wrapper(){return this._wrapper}init(){this._view3D.control.controls.forEach(e=>{e.on({[T.HOLD]:this._onInput})})}destroy(){this._view3D.control.controls.forEach(e=>{e.off({[T.HOLD]:this._onInput})}),this.reset()}resize(){this._list.forEach(e=>{e.resize()})}collect(){const r=this._view3D;var e=this._wrapper,e=[].slice.apply(e.querySelectorAll(r.annotationSelector)).map(e=>{var t,i,s=e.dataset.focus,s={element:e,focus:s?s.split(" ").map(e=>parseFloat(e)):[],focusDuration:e.dataset.duration?parseFloat(e.dataset.duration):void 0};return e.dataset.meshIndex?(t=parseFloat(e.dataset.meshIndex),i=e.dataset.faceIndex?parseFloat(e.dataset.faceIndex):void 0,new St(r,Object.assign(Object.assign({},s),{meshIndex:t,faceIndex:i}))):(i=(t=e.dataset.position)?t.split(" ").map(e=>parseFloat(e)):[],new xt(r,Object.assign(Object.assign({},s),{position:i})))});this.add(...e)}load(e){const s=new P.FileLoader;return new Promise((t,i)=>{s.load(e,e=>{e=JSON.parse(e),e=this.parse(e);this.add(...e),t(e)},void 0,e=>{i(e)})})}parse(e){const n=this._view3D,{baseFov:a,baseDistance:o,items:t}=e;return t.map(e=>{var{meshIndex:t,faceIndex:i,position:s}=e,r=oe(e,["meshIndex","faceIndex","position"]),e=this._createDefaultAnnotationElement(e.label);return null!=t&&null!=i?new St(n,Object.assign(Object.assign({meshIndex:t,faceIndex:i},r),{baseFov:a,baseDistance:o,element:e})):new xt(n,Object.assign(Object.assign({position:s},r),{baseFov:a,baseDistance:o,element:e}))})}render(e,t){var i=this._view3D,s=i.model;if(s){const o=null!=t?t:i.renderer.canvasSize,h=o.clone().multiplyScalar(.5),l=null!=e?e:i.camera.threeCamera,r=l.position,c=s.center,d=i.annotationBreakpoints;t=[...this._list].filter(e=>e.renderable).map(e=>{var t=e.position;return{annotation:e,position:t,distToCameraSquared:r.distanceToSquared(t)}}).sort((e,t)=>t.distToCameraSquared-e.distToCameraSquared);const u=(new P.Vector3).subVectors(r,c).normalize(),_=Object.keys(d).map(e=>parseFloat(e)).sort((e,t)=>t-e);t.forEach(({annotation:e,position:t},i)=>{if(e.element){var s=t.clone().project(l),s=new P.Vector2(s.x,-s.y),r=(new P.Vector3).subVectors(t,c).normalize(),n=p(Math.abs(Math.acos(r.dot(u))));s.multiply(h),s.add(h);for(const a of _)if(n>=a){e.setOpacity(d[a]);break}e.render({position:t,renderOrder:i,screenPos:s,screenSize:o})}})}}add(...e){const t=this._wrapper;e.forEach(e=>{e.enableEvents(),e.element&&e.element.parentElement!==t&&t.appendChild(e.element)}),this._list.push(...e)}remove(e){e=this._list.splice(e,1)[0];return e?(e.destroy(),e):null}reset(){var e=this._list;e.splice(0,e.length).forEach(e=>{e.destroy()})}toJSON(){var e=this._view3D,t=this._list.map(e=>{return Object.assign(Object.assign({},e.toJSON()),{label:(null==(e=null==(e=e.element)?void 0:e.querySelector("."+J.ANNOTATION_TOOLTIP))?void 0:e.innerHTML)||null})}),i=e.renderer.size,i=Math.max(i.height/i.width,1);return{baseFov:e.camera.baseFov,baseDistance:e.camera.baseDistance,aspect:i,items:t}}_createWrapper(){var e=this._view3D,t=document.createElement(f);return t.classList.add(J.ANNOTATION_WRAPPER),e.rootEl.appendChild(t),t}_createDefaultAnnotationElement(e){var t,i=document.createElement(f);return i.classList.add(J.ANNOTATION),i.classList.add(J.ANNOTATION_DEFAULT),e&&((t=document.createElement(f)).classList.add(J.ANNOTATION_TOOLTIP),t.classList.add(J.ANNOTATION_DEFAULT),t.innerHTML=e,i.appendChild(t)),i}}class Rt extends D{constructor(e,{duration:t=300,easing:i=x,scale:s=1,disablePitch:r=!1,disableYaw:n=!1}={}){super(),this._screenScale=new P.Vector2(0,0),this._prevPos=new P.Vector2(0,0),this._isFirstTouch=!1,this._scrolling=!1,this._enabled=!1,this._onMouseDown=e=>{var t;e.button===o.LEFT&&(t=this._view3D.renderer.canvas,e.preventDefault(),(t.focus?t:window).focus(),this._prevPos.set(e.clientX,e.clientY),window.addEventListener(m.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(m.MOUSE_UP,this._onMouseUp,!1),this.trigger(T.HOLD,{inputType:g.ROTATE}))},this._onMouseMove=e=>{e.preventDefault();var t=this._prevPos,i=new P.Vector2(e.clientX,e.clientY).sub(t).multiplyScalar(this._scale);i.multiply(this._screenScale),this._xMotion.setEndDelta(i.x),this._yMotion.setEndDelta(i.y),t.set(e.clientX,e.clientY)},this._onMouseUp=()=>{this._prevPos.set(0,0),window.removeEventListener(m.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(m.MOUSE_UP,this._onMouseUp,!1),this.trigger(T.RELEASE,{inputType:g.ROTATE})},this._onTouchStart=e=>{e=e.touches[0];this._isFirstTouch=!0,this._prevPos.set(e.clientX,e.clientY),this.trigger(T.HOLD,{inputType:g.ROTATE})},this._onTouchMove=e=>{if(!(1<e.touches.length||this._scrolling)){var t=e.touches[0],i=this._view3D.scrollable;if(this._isFirstTouch){if(i){i=new P.Vector2(t.clientX,t.clientY).sub(this._prevPos);if(Math.abs(i.y)>Math.abs(i.x))return void(this._scrolling=!0)}this._isFirstTouch=!1}!1!==e.cancelable&&e.preventDefault(),e.stopPropagation();i=this._prevPos,e=new P.Vector2(t.clientX,t.clientY).sub(i).multiplyScalar(this._scale);e.multiply(this._screenScale),this._xMotion.setEndDelta(e.x),this._yMotion.setEndDelta(e.y),i.set(t.clientX,t.clientY)}},this._onTouchEnd=e=>{e=e.touches[0];e?this._prevPos.set(e.clientX,e.clientY):(this._prevPos.set(0,0),this.trigger(T.RELEASE,{inputType:g.ROTATE})),this._scrolling=!1},this._view3D=e,this._scale=s,this._duration=t,this._easing=i,this._disablePitch=r,this._disableYaw=n,this._xMotion=new S({duration:t,range:ze,easing:i}),this._yMotion=new S({duration:t,range:We,easing:i})}get enabled(){return this._enabled}get animating(){return this._xMotion.activated||this._yMotion.activated}get scale(){return this._scale}get duration(){return this._duration}get easing(){return this._easing}get disablePitch(){return this._disablePitch}get disableYaw(){return this._disableYaw}set scale(e){this._scale=e}set duration(e){this._duration=e,this._xMotion.duration=e,this._yMotion.duration=e}set easing(e){this._easing=e,this._xMotion.easing=e,this._yMotion.easing=e}destroy(){this.disable(),this.reset(),this.off()}reset(){this._isFirstTouch=!1,this._scrolling=!1}update(e){var t=this._view3D.camera,i=this._xMotion,s=this._yMotion,t=t.newPose,r=!this._disableYaw,n=!this._disablePitch,i=new P.Vector2(i.update(e),s.update(e));r&&(t.yaw+=i.x),n&&(t.pitch+=i.y)}resize(e){this._screenScale.set(360/e.width,180/e.height)}enable(){var e;this._enabled||((e=this._view3D.renderer.canvas).addEventListener(m.MOUSE_DOWN,this._onMouseDown),e.addEventListener(m.TOUCH_START,this._onTouchStart,{passive:!1}),e.addEventListener(m.TOUCH_MOVE,this._onTouchMove,{passive:!1}),e.addEventListener(m.TOUCH_END,this._onTouchEnd),this._enabled=!0,this.sync(),this.trigger(T.ENABLE,{inputType:g.ROTATE}))}disable(){var e;this._enabled&&((e=this._view3D.renderer.canvas).removeEventListener(m.MOUSE_DOWN,this._onMouseDown),window.removeEventListener(m.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(m.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(m.TOUCH_START,this._onTouchStart),e.removeEventListener(m.TOUCH_MOVE,this._onTouchMove),e.removeEventListener(m.TOUCH_END,this._onTouchEnd),this._enabled=!1,this.trigger(T.DISABLE,{inputType:g.ROTATE}))}sync(){var e=this._view3D.camera;this._xMotion.reset(e.yaw),this._yMotion.reset(e.pitch)}}class Lt extends D{constructor(e,{easing:t=x,duration:i=0,scale:s=1}={}){super(),this._enabled=!1,this._touchInitialized=!1,this._prevPos=new P.Vector2(0,0),this._screenSize=new P.Vector2(0,0),this._onMouseDown=e=>{var t;e.button===o.RIGHT&&(t=this._view3D.renderer.canvas,e.preventDefault(),(t.focus?t:window).focus(),this._prevPos.set(e.clientX,e.clientY),window.addEventListener(m.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(m.MOUSE_UP,this._onMouseUp,!1),window.addEventListener(m.CONTEXT_MENU,this._onContextMenu,!1),this.trigger(T.HOLD,{inputType:g.TRANSLATE}))},this._onMouseMove=e=>{e.preventDefault();var t=this._prevPos,i=new P.Vector2(e.clientX,e.clientY).sub(t).multiplyScalar(this._scale);this._xMotion.setEndDelta(-i.x),this._yMotion.setEndDelta(i.y),t.set(e.clientX,e.clientY)},this._onMouseUp=()=>{this._prevPos.set(0,0),window.removeEventListener(m.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(m.MOUSE_UP,this._onMouseUp,!1),this.trigger(T.RELEASE,{inputType:g.TRANSLATE})},this._onTouchStart=e=>{2===e.touches.length&&(!1!==e.cancelable&&e.preventDefault(),this._prevPos.copy(this._getTouchesMiddle(e.touches)),this._touchInitialized=!0,this.trigger(T.HOLD,{inputType:g.TRANSLATE}))},this._onTouchMove=e=>{var t,i;2===e.touches.length&&(!1!==e.cancelable&&e.preventDefault(),e.stopPropagation(),t=this._prevPos,e=this._getTouchesMiddle(e.touches),this._touchInitialized?(i=(new P.Vector2).subVectors(e,t).multiplyScalar(this._scale),this._xMotion.setEndDelta(-i.x),this._yMotion.setEndDelta(i.y),t.copy(e)):(t.copy(e),this._touchInitialized=!0))},this._onTouchEnd=e=>{2!==e.touches.length?this._touchInitialized&&(this._touchInitialized=!1,this.trigger(T.RELEASE,{inputType:g.TRANSLATE})):(this._prevPos.copy(this._getTouchesMiddle(e.touches)),this._touchInitialized=!0)},this._onContextMenu=e=>{e.preventDefault(),window.removeEventListener(m.CONTEXT_MENU,this._onContextMenu,!1)},this._view3D=e,this._xMotion=new S({duration:i,range:ze,easing:t}),this._yMotion=new S({duration:i,range:ze,easing:t}),this._scale=s}get enabled(){return this._enabled}get animating(){return this._xMotion.activated||this._yMotion.activated}get scale(){return this._scale}get duration(){return this._duration}get easing(){return this._easing}set scale(e){this._scale=e}set duration(e){this._duration=e,this._xMotion.duration=e,this._yMotion.duration=e}set easing(e){this._easing=e,this._xMotion.easing=e,this._yMotion.easing=e}destroy(){this.disable(),this.reset(),this.off()}reset(){this._touchInitialized=!1}update(e){var t=this._view3D.camera,i=t.newPose,s=this._screenSize,e=new P.Vector2(this._xMotion.update(e),this._yMotion.update(e)),r=new P.Vector3(1,0,0).applyQuaternion(t.threeCamera.quaternion),n=new P.Vector3(0,1,0).applyQuaternion(t.threeCamera.quaternion),t=new P.Vector2(t.renderWidth,t.renderHeight).divide(s),s=(e.multiply(t),i.pivot.clone());i.pivot=s.add(r.multiplyScalar(e.x)).add(n.multiplyScalar(e.y))}resize(e){this._screenSize.copy(new P.Vector2(e.width,e.height))}enable(){var e;this._enabled||((e=this._view3D.renderer.canvas).addEventListener(m.MOUSE_DOWN,this._onMouseDown,!1),e.addEventListener(m.TOUCH_START,this._onTouchStart,{passive:!1,capture:!1}),e.addEventListener(m.TOUCH_MOVE,this._onTouchMove,{passive:!1,capture:!1}),e.addEventListener(m.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),this._enabled=!0,this.sync(),this.trigger(T.ENABLE,{inputType:g.TRANSLATE}))}disable(){var e;this._enabled&&((e=this._view3D.renderer.canvas).removeEventListener(m.MOUSE_DOWN,this._onMouseDown,!1),window.removeEventListener(m.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(m.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(m.TOUCH_START,this._onTouchStart,!1),e.removeEventListener(m.TOUCH_MOVE,this._onTouchMove,!1),e.removeEventListener(m.TOUCH_END,this._onTouchEnd,!1),window.removeEventListener(m.CONTEXT_MENU,this._onContextMenu,!1),this._enabled=!1,this.trigger(T.DISABLE,{inputType:g.TRANSLATE}))}sync(){this._xMotion.reset(0),this._yMotion.reset(0)}_getTouchesMiddle(e){return new P.Vector2(e[0].clientX+e[1].clientX,e[0].clientY+e[1].clientY).multiplyScalar(.5)}}class At extends D{constructor(e,{type:t=Se.FOV,scale:i=1,duration:s=300,minFov:r=1,maxFov:n=$,minDistance:a=.1,maxDistance:o=2,doubleTap:h=!0,easing:l=x}={}){super(),this._scaleModifier=1,this._wheelModifier=.02,this._touchModifier=.05,this._prevTouchDistance=-1,this._enabled=!1,this._isFirstTouch=!0,this._isWheelScrolling=!1,this._onWheel=e=>{var t=this._view3D.wheelScrollable;0===e.deltaY||t||(e.preventDefault(),e.stopPropagation(),t=this._motion,e=-this._scale*this._scaleModifier*this._wheelModifier*e.deltaY,this._isWheelScrolling||this.trigger(T.HOLD,{inputType:g.ZOOM}),this._isWheelScrolling=!0,t.setEndDelta(e))},this._onTouchMove=e=>{var t,i,s=e.touches;2===s.length&&(!1!==e.cancelable&&e.preventDefault(),e.stopPropagation(),e=this._motion,t=this._prevTouchDistance,i=new P.Vector2(s[0].pageX,s[0].pageY),s=new P.Vector2(s[1].pageX,s[1].pageY),i=i.sub(s).length()*this._scale*this._scaleModifier*this._touchModifier,s=this._isFirstTouch?0:i-t,this._prevTouchDistance=i,this._isFirstTouch&&this.trigger(T.HOLD,{inputType:g.ZOOM}),this._isFirstTouch=!1,e.setEndDelta(s))},this._onTouchEnd=e=>{0===e.touches.length&&(this.trigger(T.RELEASE,{inputType:g.ZOOM}),this._prevTouchDistance=-1,this._isFirstTouch=!0)},this._onDoubleClick=e=>{var t=this._view3D;if(this._doubleTap&&t.model){var{zoomIn:i=.8,duration:s=300,easing:r=x,useZoomOut:n=!0}=Z(this._doubleTap),i=-this._motion.range.min*i;if(t.camera.zoom>=i&&n){const h=t.camera.currentPose.clone();h.zoom=0,void t.camera.reset(s,r,h)}else{var n=new P.Raycaster,a=new P.Vector2,o=t.renderer.canvasSize,e=(a.x=e.offsetX/o.x*2-1,a.y=2*-(e.offsetY/o.y)+1,n.setFromCamera(a,t.camera.threeCamera),n.intersectObject(t.model.scene));if(e.length){var o=e[0].point,{yaw:a,pitch:n}=t.camera;const h=new y(a,n,i,o.toArray());t.camera.reset(s,r,h)}}}},this._view3D=e,this._type=t,this._scale=i,this._duration=s,this._minFov=r,this._maxFov=n,this._minDistance=a,this._maxDistance=o,this._doubleTap=h,this._easing=l,this._motion=new S({duration:s,easing:l,range:{min:-1/0,max:1/0}})}get enabled(){return this._enabled}get animating(){return this._motion.activated}get range(){return this._motion.range}get type(){return this._type}get scale(){return this._scale}get duration(){return this._duration}get minFov(){return this._minFov}get maxFov(){return this._maxFov}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}get doubleTap(){return this._doubleTap}get easing(){return this._easing}set type(e){this._type=e}set scale(e){this._scale=e}destroy(){this.disable(),this.reset(),this.off()}reset(){this._prevTouchDistance=-1,this._isFirstTouch=!0,this._isWheelScrolling=!1}update(e){var t=this._view3D.camera.newPose,i=this._motion,s=i.progress,e=i.update(e),i=i.progress;t.zoom-=e,this._isWheelScrolling&&s<1&&1<=i&&(this.trigger(T.RELEASE,{inputType:g.ZOOM}),this._isWheelScrolling=!1)}resize(e){}enable(){var e;this._enabled||((e=this._view3D.renderer.canvas).addEventListener(m.WHEEL,this._onWheel,{passive:!1,capture:!1}),e.addEventListener(m.TOUCH_MOVE,this._onTouchMove,{passive:!1,capture:!1}),e.addEventListener(m.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),e.addEventListener(m.DOUBLE_CLICK,this._onDoubleClick),this._enabled=!0,this.sync(),this.trigger(T.ENABLE,{inputType:g.ZOOM}))}disable(){var e;this._enabled&&((e=this._view3D.renderer.canvas).removeEventListener(m.WHEEL,this._onWheel,!1),e.removeEventListener(m.TOUCH_MOVE,this._onTouchMove,!1),e.removeEventListener(m.TOUCH_END,this._onTouchEnd,!1),e.removeEventListener(m.DOUBLE_CLICK,this._onDoubleClick),this._enabled=!1,this.trigger(T.DISABLE,{inputType:g.ZOOM}))}sync(){var e=this._view3D.camera;this._motion.reset(-e.zoom),this._type===Se.FOV?this._scaleModifier=-1:this._scaleModifier=-e.baseDistance/44}updateRange(){var e,t,i=this._motion.range,s=this._view3D["camera"];this._type===Se.FOV?(e=s.baseFov,t=this._maxFov,i.max=t===$?Math.min(e+45,175)-e:t-e,i.min=this._minFov-e):(i.max=s.baseDistance*this._maxDistance-s.baseDistance,i.min=s.baseDistance*this._minDistance-s.baseDistance)}}class Ot{constructor(e){this._onEnable=({inputType:e})=>{var t;e!==g.ZOOM&&(t=(e=this._view3D).renderer.canvas,e.useGrabCursor)&&(this._rotateControl.enabled||this._translateControl.enabled)&&t.style.cursor===i.NONE&&this._setCursor(i.GRAB)},this._onDisable=({inputType:e})=>{e===g.ZOOM||this._view3D.renderer.canvas.style.cursor===i.NONE||this._rotateControl.enabled||this._translateControl.enabled||this._setCursor(i.NONE)},this._onHold=({inputType:e})=>{var t=this._view3D;e!==g.ZOOM&&t.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&this._setCursor(i.GRABBING),t.trigger(E.INPUT_START,{type:E.INPUT_START,target:t,inputType:e})},this._onRelease=({inputType:e})=>{var t=this._view3D;e!==g.ZOOM&&t.useGrabCursor&&(this._rotateControl.enabled||this._translateControl.enabled)&&this._setCursor(i.GRAB),t.trigger(E.INPUT_END,{type:E.INPUT_END,target:t,inputType:e})},this._view3D=e,this._rotateControl=new Rt(e,Z(e.rotate)),this._translateControl=new Lt(e,Z(e.translate)),this._zoomControl=new At(e,Z(e.zoom)),this._extraControls=[],[this._rotateControl,this._translateControl,this._zoomControl].forEach(e=>{e.on({[T.HOLD]:this._onHold,[T.RELEASE]:this._onRelease,[T.ENABLE]:this._onEnable,[T.DISABLE]:this._onDisable})})}get rotate(){return this._rotateControl}get translate(){return this._translateControl}get zoom(){return this._zoomControl}get controls(){return[this._rotateControl,this._translateControl,this._zoomControl]}get extraControls(){return this._extraControls}get animating(){return this._rotateControl.animating||this._translateControl.animating||this._zoomControl.animating||this._extraControls.some(e=>e.animating)}destroy(){this._rotateControl.destroy(),this._translateControl.destroy(),this._zoomControl.destroy(),this._extraControls.forEach(e=>e.destroy()),this._extraControls=[]}update(t){this._rotateControl.update(t),this._translateControl.update(t),this._zoomControl.update(t),this._extraControls.forEach(e=>e.update(t))}resize(t){this._rotateControl.resize(t),this._translateControl.resize(t),this._zoomControl.resize(t),this._extraControls.forEach(e=>e.resize(t))}enable(){var e=this._view3D;e.rotate&&this._rotateControl.enable(),e.translate&&this._translateControl.enable(),e.zoom&&this._zoomControl.enable(),this._extraControls.forEach(e=>e.enable())}disable(){this._rotateControl.disable(),this._translateControl.disable(),this._zoomControl.disable(),this._extraControls.forEach(e=>e.disable())}sync(){this._rotateControl.sync(),this._translateControl.sync(),this._zoomControl.sync(),this._extraControls.forEach(e=>e.sync())}add(e){this._extraControls.push(e)}remove(t){var e=this._extraControls,i=e.findIndex(e=>e===t);0<=i&&e.splice(i,1)}updateCursor(){var e=this._view3D.useGrabCursor?i.GRAB:i.NONE;this._setCursor(e)}_setCursor(e){var t=this._view3D;!t.useGrabCursor&&e!==i.NONE||(t.renderer.canvas.style.cursor=e)}}class Ct{constructor(e,{delay:t=2e3,delayOnMouseLeave:i=0,speed:s=1,pauseOnHover:r=!1,canInterrupt:n=!0,disableOnInterrupt:a=!1}={}){this._enabled=!1,this._interrupted=!1,this._interruptionTimer=-1,this._hovering=!1,this._onMouseDown=e=>{!this._canInterrupt||e.button!==o.LEFT&&e.button!==o.RIGHT||(this._interrupted=!0,this._clearTimeout(),window.addEventListener(m.MOUSE_UP,this._onMouseUp,!1))},this._onMouseUp=()=>{window.removeEventListener(m.MOUSE_UP,this._onMouseUp,!1),this._setUninterruptedAfterDelay(this._delay)},this._onTouchStart=()=>{this._canInterrupt&&(this._interrupted=!0,this._clearTimeout())},this._onTouchEnd=()=>{this._setUninterruptedAfterDelay(this._delay)},this._onMouseEnter=()=>{this._pauseOnHover&&(this._interrupted=!0,this._hovering=!0)},this._onMouseLeave=()=>{this._pauseOnHover&&(this._hovering=!1,this._setUninterruptedAfterDelay(this._delayOnMouseLeave))},this._onWheel=()=>{this._canInterrupt&&(this._interrupted=!0,this._setUninterruptedAfterDelay(this._delay))},this._view3D=e,this._delay=t,this._delayOnMouseLeave=i,this._speed=s,this._pauseOnHover=r,this._canInterrupt=n,this._disableOnInterrupt=a}get enabled(){return this._enabled}get animating(){return this._enabled&&!this._interrupted}get delay(){return this._delay}get delayOnMouseLeave(){return this._delayOnMouseLeave}get speed(){return this._speed}get pauseOnHover(){return this._pauseOnHover}get canInterrupt(){return this._canInterrupt}get disableOnInterrupt(){return this._disableOnInterrupt}set delay(e){this._delay=e}set delayOnMouseLeave(e){this._delayOnMouseLeave=e}set speed(e){this._speed=e}set pauseOnHover(e){this._pauseOnHover=e}set canInterrupt(e){this._canInterrupt=e}set disableOnInterrupt(e){this._disableOnInterrupt=e}destroy(){this.disable()}update(e){this._enabled&&(this._interrupted?this._disableOnInterrupt&&this.disable():this._view3D.camera.newPose.yaw+=this._speed*e/100)}enable(){var e;this._enabled||((e=this._view3D.renderer.canvas).addEventListener(m.MOUSE_DOWN,this._onMouseDown,!1),e.addEventListener(m.TOUCH_START,this._onTouchStart,{passive:!1,capture:!1}),e.addEventListener(m.TOUCH_END,this._onTouchEnd,{passive:!1,capture:!1}),e.addEventListener(m.MOUSE_ENTER,this._onMouseEnter,!1),e.addEventListener(m.MOUSE_LEAVE,this._onMouseLeave,!1),e.addEventListener(m.WHEEL,this._onWheel,{passive:!1,capture:!1}),this._enabled=!0)}enableAfterDelay(){this.enable(),this._interrupted=!0,this._setUninterruptedAfterDelay(this._delay)}disable(){var e;this._enabled&&((e=this._view3D.renderer.canvas).removeEventListener(m.MOUSE_DOWN,this._onMouseDown,!1),window.removeEventListener(m.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(m.TOUCH_START,this._onTouchStart,!1),e.removeEventListener(m.TOUCH_END,this._onTouchEnd,!1),e.removeEventListener(m.MOUSE_ENTER,this._onMouseEnter,!1),e.removeEventListener(m.MOUSE_LEAVE,this._onMouseLeave,!1),e.removeEventListener(m.WHEEL,this._onWheel,!1),this._enabled=!1,this._interrupted=!1,this._hovering=!1,this._clearTimeout())}_setUninterruptedAfterDelay(e){this._hovering||(this._clearTimeout(),0<e?this._interruptionTimer=window.setTimeout(()=>{this._interrupted=!1,this._interruptionTimer=-1},e):(this._interrupted=!1,this._interruptionTimer=-1))}_clearTimeout(){0<=this._interruptionTimer&&(window.clearTimeout(this._interruptionTimer),this._interruptionTimer=-1)}}class Mt extends P.Loader{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new Nt(e)}),this.register(function(e){return new Vt(e)}),this.register(function(e){return new Gt(e)}),this.register(function(e){return new Ft(e)}),this.register(function(e){return new Ut(e)}),this.register(function(e){return new Bt(e)}),this.register(function(e){return new kt(e)}),this.register(function(e){return new Ht(e)}),this.register(function(e){return new It(e)}),this.register(function(e){return new zt(e)})}load(t,i,e,s){function r(e){s?s(e):console.error(e),n.manager.itemError(t),n.manager.itemEnd(t)}var n=this,a=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:P.LoaderUtils.extractUrlBase(t),o=(this.manager.itemStart(t),new P.FileLoader(this.manager));o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(t,function(e){try{n.parse(e,a,function(e){i(e),n.manager.itemEnd(t)},r)}catch(e){r(e)}},e,r)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,i,s){var r,n={},a={};if("string"==typeof e)r=e;else if(P.LoaderUtils.decodeText(new Uint8Array(e,0,4))===Wt){try{n[L.KHR_BINARY_GLTF]=new Xt(e)}catch(e){return void(s&&s(e))}r=n[L.KHR_BINARY_GLTF].content}else r=P.LoaderUtils.decodeText(new Uint8Array(e));var o=JSON.parse(r);if(void 0===o.asset||o.asset.version[0]<2)s&&s(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));else{var h=new bi(o,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});h.fileLoader.setRequestHeader(this.requestHeader);for(var l=0;l<this.pluginCallbacks.length;l++){var c=this.pluginCallbacks[l](h);n[(a[c.name]=c).name]=!0}if(o.extensionsUsed)for(var d=0;d<o.extensionsUsed.length;++d){var u=o.extensionsUsed[d],_=o.extensionsRequired||[];switch(u){case L.KHR_MATERIALS_UNLIT:n[u]=new Pt;break;case L.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:n[u]=new Qt;break;case L.KHR_DRACO_MESH_COMPRESSION:n[u]=new qt(o,this.dracoLoader);break;case L.KHR_TEXTURE_TRANSFORM:n[u]=new Yt;break;case L.KHR_MESH_QUANTIZATION:n[u]=new $t;break;default:0<=_.indexOf(u)&&void 0===a[u]&&console.warn('THREE.GLTFLoader: Unknown extension "'+u+'".')}}h.setExtensions(n),h.setPlugins(a),h.parse(i,s)}}}function Dt(){var i={};return{get:function(e){return i[e]},add:function(e,t){i[e]=t},remove:function(e){delete i[e]},removeAll:function(){i={}}}}var L={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};class It{constructor(e){this.parser=e,this.name=L.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){for(var e=this.parser,t=this.parser.json.nodes||[],i=0,s=t.length;i<s;i++){var r=t[i];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){var t=this.parser,i="light:"+e,s=t.cache.get(i);if(!s){var r,n=t.json,a=((n.extensions&&n.extensions[this.name]||{}).lights||[])[e],o=new P.Color(16777215),h=(void 0!==a.color&&o.fromArray(a.color),void 0!==a.range?a.range:0);switch(a.type){case"directional":(r=new P.DirectionalLight(o)).target.position.set(0,0,-1),r.add(r.target);break;case"point":(r=new P.PointLight(o)).distance=h;break;case"spot":(r=new P.SpotLight(o)).distance=h,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,r.angle=a.spot.outerConeAngle,r.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,r.target.position.set(0,0,-1),r.add(r.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}r.position.set(0,0,0),r.decay=2,void 0!==a.intensity&&(r.intensity=a.intensity),r.name=t.createUniqueName(a.name||"light_"+e),s=Promise.resolve(r),t.cache.add(i,s)}return s}createNodeAttachment(e){var t=this,i=this.parser,e=i.json.nodes[e],s=(e.extensions&&e.extensions[this.name]||{}).light;return void 0===s?null:this._loadLight(s).then(function(e){return i._getNodeRef(t.cache,s,e)})}}class Pt{constructor(){this.name=L.KHR_MATERIALS_UNLIT}getMaterialType(){return P.MeshBasicMaterial}extendParams(e,t,i){var s,r=[],t=(e.color=new P.Color(1,1,1),e.opacity=1,t.pbrMetallicRoughness);return t&&(Array.isArray(t.baseColorFactor)&&(s=t.baseColorFactor,e.color.fromArray(s),e.opacity=s[3]),void 0!==t.baseColorTexture)&&r.push(i.assignTexture(e,"map",t.baseColorTexture)),Promise.all(r)}}class Nt{constructor(e){this.parser=e,this.name=L.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]?P.MeshPhysicalMaterial:null}extendMaterialParams(e,t){var i,s=this.parser,e=s.json.materials[e];return e.extensions&&e.extensions[this.name]?(i=[],void 0!==(e=e.extensions[this.name]).clearcoatFactor&&(t.clearcoat=e.clearcoatFactor),void 0!==e.clearcoatTexture&&i.push(s.assignTexture(t,"clearcoatMap",e.clearcoatTexture)),void 0!==e.clearcoatRoughnessFactor&&(t.clearcoatRoughness=e.clearcoatRoughnessFactor),void 0!==e.clearcoatRoughnessTexture&&i.push(s.assignTexture(t,"clearcoatRoughnessMap",e.clearcoatRoughnessTexture)),void 0!==e.clearcoatNormalTexture&&(i.push(s.assignTexture(t,"clearcoatNormalMap",e.clearcoatNormalTexture)),void 0!==e.clearcoatNormalTexture.scale)&&(s=e.clearcoatNormalTexture.scale,t.clearcoatNormalScale=new P.Vector2(s,s)),Promise.all(i)):Promise.resolve()}}class Ft{constructor(e){this.parser=e,this.name=L.KHR_MATERIALS_SHEEN}getMaterialType(e){e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]?P.MeshPhysicalMaterial:null}extendMaterialParams(e,t){var i,s=this.parser,e=s.json.materials[e];return e.extensions&&e.extensions[this.name]?(i=[],t.sheenColor=new P.Color(0,0,0),t.sheenRoughness=0,t.sheen=1,void 0!==(e=e.extensions[this.name]).sheenColorFactor&&t.sheenColor.fromArray(e.sheenColorFactor),void 0!==e.sheenRoughnessFactor&&(t.sheenRoughness=e.sheenRoughnessFactor),void 0!==e.sheenColorTexture&&i.push(s.assignTexture(t,"sheenColorMap",e.sheenColorTexture)),void 0!==e.sheenRoughnessTexture&&i.push(s.assignTexture(t,"sheenRoughnessMap",e.sheenRoughnessTexture)),Promise.all(i)):Promise.resolve()}}class Ut{constructor(e){this.parser=e,this.name=L.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]?P.MeshPhysicalMaterial:null}extendMaterialParams(e,t){var i,s=this.parser,e=s.json.materials[e];return e.extensions&&e.extensions[this.name]?(i=[],void 0!==(e=e.extensions[this.name]).transmissionFactor&&(t.transmission=e.transmissionFactor),void 0!==e.transmissionTexture&&i.push(s.assignTexture(t,"transmissionMap",e.transmissionTexture)),Promise.all(i)):Promise.resolve()}}class Bt{constructor(e){this.parser=e,this.name=L.KHR_MATERIALS_VOLUME}getMaterialType(e){e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]?P.MeshPhysicalMaterial:null}extendMaterialParams(e,t){var i,s=this.parser,e=s.json.materials[e];return e.extensions&&e.extensions[this.name]?(i=[],e=e.extensions[this.name],t.thickness=void 0!==e.thicknessFactor?e.thicknessFactor:0,void 0!==e.thicknessTexture&&i.push(s.assignTexture(t,"thicknessMap",e.thicknessTexture)),t.attenuationDistance=e.attenuationDistance||0,s=e.attenuationColor||[1,1,1],t.attenuationColor=new P.Color(s[0],s[1],s[2]),Promise.all(i)):Promise.resolve()}}class kt{constructor(e){this.parser=e,this.name=L.KHR_MATERIALS_IOR}getMaterialType(e){e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]?P.MeshPhysicalMaterial:null}extendMaterialParams(e,t){var e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]&&(e=e.extensions[this.name],t.ior=void 0!==e.ior?e.ior:1.5),Promise.resolve()}}class Ht{constructor(e){this.parser=e,this.name=L.KHR_MATERIALS_SPECULAR}getMaterialType(e){e=this.parser.json.materials[e];return e.extensions&&e.extensions[this.name]?P.MeshPhysicalMaterial:null}extendMaterialParams(e,t){var i,s,r=this.parser,e=r.json.materials[e];return e.extensions&&e.extensions[this.name]?(i=[],e=e.extensions[this.name],t.specularIntensity=void 0!==e.specularFactor?e.specularFactor:1,void 0!==e.specularTexture&&i.push(r.assignTexture(t,"specularIntensityMap",e.specularTexture)),s=e.specularColorFactor||[1,1,1],t.specularColor=new P.Color(s[0],s[1],s[2]),void 0!==e.specularColorTexture&&i.push(r.assignTexture(t,"specularColorMap",e.specularColorTexture).then(function(e){e.encoding=P.sRGBEncoding})),Promise.all(i)):Promise.resolve()}}class Vt{constructor(e){this.parser=e,this.name=L.KHR_TEXTURE_BASISU}loadTexture(e){var t=this.parser,i=t.json,s=i.textures[e];if(s.extensions&&s.extensions[this.name]){var s=s.extensions[this.name],s=i.images[s.source],r=t.options.ktx2Loader;if(r)return t.loadTextureImage(e,s,r);if(i.extensionsRequired&&0<=i.extensionsRequired.indexOf(this.name))throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures")}return null}}class Gt{constructor(e){this.parser=e,this.name=L.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(t){var i,s,r=this.name,n=this.parser,a=n.json,e=a.textures[t];return e.extensions&&e.extensions[r]?(e=e.extensions[r],i=a.images[e.source],s=n.textureLoader,i.uri&&null!==(e=n.options.manager.getHandler(i.uri))&&(s=e),this.detectSupport().then(function(e){if(e)return n.loadTextureImage(t,i,s);if(a.extensionsRequired&&0<=a.extensionsRequired.indexOf(r))throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return n.loadTexture(t)})):null}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){var t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class zt{constructor(e){this.name=L.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){var t=this.parser.json,e=t.bufferViews[e];if(e.extensions&&e.extensions[this.name]){var a=e.extensions[this.name],e=this.parser.getDependency("buffer",a.buffer),o=this.parser.options.meshoptDecoder;if(o&&o.supported)return Promise.all([e,o.ready]).then(function(e){var t=a.byteOffset||0,i=a.byteLength||0,s=a.count,r=a.byteStride,n=new ArrayBuffer(s*r),e=new Uint8Array(e[0],t,i);return o.decodeGltfBuffer(new Uint8Array(n),s,r,e,a.mode,a.filter),n});if(t.extensionsRequired&&0<=t.extensionsRequired.indexOf(this.name))throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files")}return null}}var Wt="glTF",jt=1313821514,Kt=5130562;class Xt{constructor(e){this.name=L.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,12);if(this.header={magic:P.LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Wt)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");for(var i=this.header.length-12,s=new DataView(e,12),r=0;r<i;){var n,a=s.getUint32(r,!0),o=(r+=4,s.getUint32(r,!0));r+=4,o===jt?(n=new Uint8Array(e,12+r,a),this.content=P.LoaderUtils.decodeText(n)):o===Kt&&(this.body=e.slice(n=12+r,n+a)),r+=a}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class qt{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=L.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){var i,s,r=this.json,n=this.dracoLoader,a=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,h={},l={},c={};for(i in o){var d=ui[i]||i.toLowerCase();h[d]=o[i]}for(s in e.attributes){var u,_,p=ui[s]||s.toLowerCase();void 0!==o[s]&&(u=r.accessors[e.attributes[s]],_=hi[u.componentType],c[p]=_,l[p]=!0===u.normalized)}return t.getDependency("bufferView",a).then(function(e){return new Promise(function(s){n.decodeDracoFile(e,function(e){for(var t in e.attributes){var i=e.attributes[t],t=l[t];void 0!==t&&(i.normalized=t)}s(e)},h,c)})})}}class Yt{constructor(){this.name=L.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Zt extends P.MeshStandardMaterial{constructor(e){super(),this.isGLTFSpecularGlossinessMaterial=!0;var i=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),s=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),r=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),n=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),a=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.roughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.roughness += geometryRoughness;","material.roughness = min( material.roughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),o={specular:{value:(new P.Color).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=o,this.onBeforeCompile=function(e){for(var t in o)e.uniforms[t]=o[t];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",i).replace("#include <metalnessmap_pars_fragment>",s).replace("#include <roughnessmap_fragment>",r).replace("#include <metalnessmap_fragment>",n).replace("#include <lights_physical_fragment>",a)},Object.defineProperties(this,{specular:{get:function(){return o.specular.value},set:function(e){o.specular.value=e}},specularMap:{get:function(){return o.specularMap.value},set:function(e){(o.specularMap.value=e)?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return o.glossiness.value},set:function(e){o.glossiness.value=e}},glossinessMap:{get:function(){return o.glossinessMap.value},set:function(e){(o.glossinessMap.value=e)?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}copy(e){return super.copy(e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}class Qt{constructor(){this.name=L.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"]}getMaterialType(){return Zt}extendParams(e,t,i){var s,t=t.extensions[this.name],r=(e.color=new P.Color(1,1,1),e.opacity=1,[]);return Array.isArray(t.diffuseFactor)&&(s=t.diffuseFactor,e.color.fromArray(s),e.opacity=s[3]),void 0!==t.diffuseTexture&&r.push(i.assignTexture(e,"map",t.diffuseTexture)),e.emissive=new P.Color(0,0,0),e.glossiness=void 0!==t.glossinessFactor?t.glossinessFactor:1,e.specular=new P.Color(1,1,1),Array.isArray(t.specularFactor)&&e.specular.fromArray(t.specularFactor),void 0!==t.specularGlossinessTexture&&(s=t.specularGlossinessTexture,r.push(i.assignTexture(e,"glossinessMap",s)),r.push(i.assignTexture(e,"specularMap",s))),Promise.all(r)}createMaterial(e){var t=new Zt(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=P.TangentSpaceNormalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}class $t{constructor(){this.name=L.KHR_MESH_QUANTIZATION}}class A extends P.Interpolant{constructor(e,t,i,s){super(e,t,i,s)}copySampleValue_(e){for(var t=this.resultBuffer,i=this.sampleValues,s=this.valueSize,r=e*s*3+s,n=0;n!==s;n++)t[n]=i[r+n];return t}}A.prototype.beforeStart_=A.prototype.copySampleValue_,A.prototype.afterEnd_=A.prototype.copySampleValue_,A.prototype.interpolate_=function(e,t,i,s){for(var r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=2*a,h=3*a,l=s-t,s=(i-t)/l,i=s*s,t=i*s,c=e*h,d=c-h,u=-2*t+3*i,_=t-i,p=1-u,m=_-i+s,v=0;v!==a;v++){var g=n[d+v+a],f=n[d+v+o]*l,E=n[c+v+a],T=n[c+v]*l;r[v]=p*g+m*f+u*E+_*T}return r};var Jt=new P.Quaternion;class ei extends A{interpolate_(e,t,i,s){e=super.interpolate_(e,t,i,s);return Jt.fromArray(e).normalize().toArray(e),e}}var ti=0,ii=1,si=2,ri=3,ni=4,ai=5,oi=6,hi={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},li={9728:P.NearestFilter,9729:P.LinearFilter,9984:P.NearestMipmapNearestFilter,9985:P.LinearMipmapNearestFilter,9986:P.NearestMipmapLinearFilter,9987:P.LinearMipmapLinearFilter},ci={33071:P.ClampToEdgeWrapping,33648:P.MirroredRepeatWrapping,10497:P.RepeatWrapping},di={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ui={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},_i={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},pi={CUBICSPLINE:void 0,LINEAR:P.InterpolateLinear,STEP:P.InterpolateDiscrete},mi="OPAQUE",vi="MASK",gi="BLEND";function fi(e,t,i){for(var s in i.extensions)void 0===e[s]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[s]=i.extensions[s])}function Ei(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function Ti(e){for(var t="",i=Object.keys(e).sort(),s=0,r=i.length;s<r;s++)t+=i[s]+":"+e[i[s]]+";";return t}function wi(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}class bi{constructor(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Dt,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.textureCache={},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new P.ImageBitmapLoader(this.options.manager):this.textureLoader=new P.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new P.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(i,e){var s=this,r=this.json,n=this.extensions;this.cache.removeAll(),this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(e){var t={scene:e[0][r.scene||0],scenes:e[0],animations:e[1],cameras:e[2],asset:r.asset,parser:s,userData:{}};fi(n,t,r),Ei(t,r),Promise.all(s._invokeAll(function(e){return e.afterRoot&&e.afterRoot(t)})).then(function(){i(t)})}).catch(e)}_markDefs(){for(var e=this.json.nodes||[],t=this.json.skins||[],i=this.json.meshes||[],s=0,r=t.length;s<r;s++)for(var n=t[s].joints,a=0,o=n.length;a<o;a++)e[n[a]].isBone=!0;for(var h=0,l=e.length;h<l;h++){var c=e[h];void 0!==c.mesh&&(this._addNodeRef(this.meshCache,c.mesh),void 0!==c.skin)&&(i[c.mesh].isSkinnedMesh=!0),void 0!==c.camera&&this._addNodeRef(this.cameraCache,c.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,i){var s,n;return e.refs[t]<=1?i:(s=i.clone(),(n=(e,t)=>{var i,s,r=this.associations.get(e);null!=r&&this.associations.set(t,r);for([i,s]of e.children.entries())n(s,t.children[i])})(i,s),s.name+="_instance_"+e.uses[t]++,s)}_invokeOne(e){var t=Object.values(this.plugins);t.push(this);for(var i=0;i<t.length;i++){var s=e(t[i]);if(s)return s}return null}_invokeAll(e){for(var t=Object.values(this.plugins),i=(t.unshift(this),[]),s=0;s<t.length;s++){var r=e(t[s]);r&&i.push(r)}return i}getDependency(e,t){var i=e+":"+t,s=this.cache.get(i);if(!s){switch(e){case"scene":s=this.loadScene(t);break;case"node":s=this.loadNode(t);break;case"mesh":s=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":s=this.loadAccessor(t);break;case"bufferView":s=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":s=this.loadBuffer(t);break;case"material":s=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":s=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":s=this.loadSkin(t);break;case"animation":s=this.loadAnimation(t);break;case"camera":s=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(i,s)}return s}getDependencies(i){var s,e,t=this.cache.get(i);return t||(e=(s=this).json[i+("mesh"===i?"es":"s")]||[],t=Promise.all(e.map(function(e,t){return s.getDependency(i,t)})),this.cache.add(i,t)),t}loadBuffer(e){var i,s=this.json.buffers[e],r=this.fileLoader;if(s.type&&"arraybuffer"!==s.type)throw new Error("THREE.GLTFLoader: "+s.type+" buffer type is not supported.");return void 0===s.uri&&0===e?Promise.resolve(this.extensions[L.KHR_BINARY_GLTF].body):(i=this.options,new Promise(function(e,t){r.load(P.LoaderUtils.resolveURL(s.uri,i.path),e,void 0,function(){t(new Error('THREE.GLTFLoader: Failed to load buffer "'+s.uri+'".'))})}))}loadBufferView(e){var s=this.json.bufferViews[e];return this.getDependency("buffer",s.buffer).then(function(e){var t=s.byteLength||0,i=s.byteOffset||0;return e.slice(i,i+t)})}loadAccessor(e){var f=this,E=this.json,T=this.json.accessors[e];return void 0===T.bufferView&&void 0===T.sparse?Promise.resolve(null):(e=[],void 0!==T.bufferView?e.push(this.getDependency("bufferView",T.bufferView)):e.push(null),void 0!==T.sparse&&(e.push(this.getDependency("bufferView",T.sparse.indices.bufferView)),e.push(this.getDependency("bufferView",T.sparse.values.bufferView))),Promise.all(e).then(function(e){var t,i=e[0],s=di[T.type],r=hi[T.componentType],n=r.BYTES_PER_ELEMENT,a=T.byteOffset||0,o=void 0!==T.bufferView?E.bufferViews[T.bufferView].byteStride:void 0,h=!0===T.normalized,l=o&&o!==n*s?(c=Math.floor(a/o),d="InterleavedBuffer:"+T.bufferView+":"+T.componentType+":"+c+":"+T.count,(u=f.cache.get(d))||(t=new r(i,c*o,T.count*o/n),u=new P.InterleavedBuffer(t,o/n),f.cache.add(d,u)),new P.InterleavedBufferAttribute(u,s,a%o/n,h)):(t=null===i?new r(T.count*s):new r(i,a,T.count*s),new P.BufferAttribute(t,s,h));if(void 0!==T.sparse){var c=hi[T.sparse.indices.componentType],d=T.sparse.indices.byteOffset||0,u=T.sparse.values.byteOffset||0,_=new c(e[1],d,T.sparse.count*di.SCALAR),p=new r(e[2],u,T.sparse.count*s);null!==i&&(l=new P.BufferAttribute(l.array.slice(),l.itemSize,l.normalized));for(var m=0,v=_.length;m<v;m++){var g=_[m];if(l.setX(g,p[m*s]),2<=s&&l.setY(g,p[m*s+1]),3<=s&&l.setZ(g,p[m*s+2]),4<=s&&l.setW(g,p[m*s+3]),5<=s)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return l}))}loadTexture(e){var t=this.json,i=this.options,s=t.textures[e],t=t.images[s.source],s=this.textureLoader;return t.uri&&null!==(i=i.manager.getHandler(t.uri))&&(s=i),this.loadTextureImage(e,t,s)}loadTextureImage(i,t,r){var s=this,n=this.json,a=this.options,o=n.textures[i],e=(t.uri||t.bufferView)+":"+o.sampler;if(this.textureCache[e])return this.textureCache[e];var h=self.URL||self.webkitURL,l=t.uri||"",c=!1;if(void 0!==t.bufferView)l=s.getDependency("bufferView",t.bufferView).then(function(e){c=!0;e=new Blob([e],{type:t.mimeType});return l=h.createObjectURL(e)});else if(void 0===t.uri)throw new Error("THREE.GLTFLoader: Image "+i+" is missing URI and bufferView");var d=Promise.resolve(l).then(function(s){return new Promise(function(t,e){var i=t;!0===r.isImageBitmapLoader&&(i=function(e){e=new P.Texture(e);e.needsUpdate=!0,t(e)}),r.load(P.LoaderUtils.resolveURL(s,a.path),i,void 0,e)})}).then(function(e){!0===c&&h.revokeObjectURL(l),e.flipY=!1,o.name&&(e.name=o.name);var t=(n.samplers||{})[o.sampler]||{};return e.magFilter=li[t.magFilter]||P.LinearFilter,e.minFilter=li[t.minFilter]||P.LinearMipmapLinearFilter,e.wrapS=ci[t.wrapS]||P.RepeatWrapping,e.wrapT=ci[t.wrapT]||P.RepeatWrapping,s.associations.set(e,{textures:i}),e}).catch(function(){return console.error("THREE.GLTFLoader: Couldn't load texture",l),null});return this.textureCache[e]=d}assignTexture(s,r,n){var a=this;return this.getDependency("texture",n.index).then(function(e){var t,i;return void 0===n.texCoord||0==n.texCoord||"aoMap"===r&&1==n.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+n.texCoord+" for texture "+r+" not yet supported."),a.extensions[L.KHR_TEXTURE_TRANSFORM]&&(t=void 0!==n.extensions?n.extensions[L.KHR_TEXTURE_TRANSFORM]:void 0)&&(i=a.associations.get(e),e=a.extensions[L.KHR_TEXTURE_TRANSFORM].extendTexture(e,t),a.associations.set(e,i)),s[r]=e})}assignFinalMaterial(e){var t,i,s=e.geometry,r=e.material,n=void 0===s.attributes.tangent,a=void 0!==s.attributes.color,o=void 0===s.attributes.normal;e.isPoints?(t="PointsMaterial:"+r.uuid,(i=this.cache.get(t))||(i=new P.PointsMaterial,P.Material.prototype.copy.call(i,r),i.color.copy(r.color),i.map=r.map,i.sizeAttenuation=!1,this.cache.add(t,i)),r=i):e.isLine&&(t="LineBasicMaterial:"+r.uuid,(i=this.cache.get(t))||(i=new P.LineBasicMaterial,P.Material.prototype.copy.call(i,r),i.color.copy(r.color),this.cache.add(t,i)),r=i),(n||a||o)&&(t="ClonedMaterial:"+r.uuid+":",r.isGLTFSpecularGlossinessMaterial&&(t+="specular-glossiness:"),n&&(t+="derivative-tangents:"),a&&(t+="vertex-colors:"),o&&(t+="flat-shading:"),(i=this.cache.get(t))||(i=r.clone(),a&&(i.vertexColors=!0),o&&(i.flatShading=!0),n&&(i.normalScale&&(i.normalScale.y*=-1),i.clearcoatNormalScale)&&(i.clearcoatNormalScale.y*=-1),this.cache.add(t,i),this.associations.set(i,this.associations.get(r))),r=i),r.aoMap&&void 0===s.attributes.uv2&&void 0!==s.attributes.uv&&s.setAttribute("uv2",s.attributes.uv),e.material=r}getMaterialType(){return P.MeshStandardMaterial}loadMaterial(t){var i,s=this,e=this.json,r=this.extensions,n=e.materials[t],a={},e=n.extensions||{},o=[],h=(e[L.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]?(h=r[L.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS],i=h.getMaterialType(),o.push(h.extendParams(a,n,s))):e[L.KHR_MATERIALS_UNLIT]?(h=r[L.KHR_MATERIALS_UNLIT],i=h.getMaterialType(),o.push(h.extendParams(a,n,s))):(e=n.pbrMetallicRoughness||{},a.color=new P.Color(1,1,1),a.opacity=1,Array.isArray(e.baseColorFactor)&&(h=e.baseColorFactor,a.color.fromArray(h),a.opacity=h[3]),void 0!==e.baseColorTexture&&o.push(s.assignTexture(a,"map",e.baseColorTexture)),a.metalness=void 0!==e.metallicFactor?e.metallicFactor:1,a.roughness=void 0!==e.roughnessFactor?e.roughnessFactor:1,void 0!==e.metallicRoughnessTexture&&(o.push(s.assignTexture(a,"metalnessMap",e.metallicRoughnessTexture)),o.push(s.assignTexture(a,"roughnessMap",e.metallicRoughnessTexture))),i=this._invokeOne(function(e){return e.getMaterialType&&e.getMaterialType(t)}),o.push(Promise.all(this._invokeAll(function(e){return e.extendMaterialParams&&e.extendMaterialParams(t,a)})))),!0===n.doubleSided&&(a.side=P.DoubleSide),n.alphaMode||mi);return h===gi?(a.transparent=!0,a.depthWrite=!1):(a.format=P.RGBFormat,a.transparent=!1,h===vi&&(a.alphaTest=void 0!==n.alphaCutoff?n.alphaCutoff:.5)),void 0!==n.normalTexture&&i!==P.MeshBasicMaterial&&(o.push(s.assignTexture(a,"normalMap",n.normalTexture)),a.normalScale=new P.Vector2(1,1),void 0!==n.normalTexture.scale)&&(e=n.normalTexture.scale,a.normalScale.set(e,e)),void 0!==n.occlusionTexture&&i!==P.MeshBasicMaterial&&(o.push(s.assignTexture(a,"aoMap",n.occlusionTexture)),void 0!==n.occlusionTexture.strength)&&(a.aoMapIntensity=n.occlusionTexture.strength),void 0!==n.emissiveFactor&&i!==P.MeshBasicMaterial&&(a.emissive=(new P.Color).fromArray(n.emissiveFactor)),void 0!==n.emissiveTexture&&i!==P.MeshBasicMaterial&&o.push(s.assignTexture(a,"emissiveMap",n.emissiveTexture)),Promise.all(o).then(function(){var e=i===Zt?r[L.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(a):new i(a);return n.name&&(e.name=n.name),e.map&&(e.map.encoding=P.sRGBEncoding),e.emissiveMap&&(e.emissiveMap.encoding=P.sRGBEncoding),Ei(e,n),s.associations.set(e,{materials:t}),n.extensions&&fi(r,e,n),e})}createUniqueName(e){for(var t=P.PropertyBinding.sanitizeNodeName(e||""),i=t,s=1;this.nodeNamesUsed[i];++s)i=t+"_"+s;return this.nodeNamesUsed[i]=!0,i}loadGeometries(e){var i=this,s=this.extensions,t=this.primitiveCache;for(var r=[],n=0,a=e.length;n<a;n++){var o=e[n],h=(l=void 0,l=(l=(h=o).extensions&&h.extensions[L.KHR_DRACO_MESH_COMPRESSION])?"draco:"+l.bufferView+":"+l.indices+":"+Ti(l.attributes):h.indices+":"+Ti(h.attributes)+":"+h.mode),l=t[h];l?r.push(l.promise):(l=void 0,l=o.extensions&&o.extensions[L.KHR_DRACO_MESH_COMPRESSION]?function(t){return s[L.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(t,i).then(function(e){return xi(e,t,i)})}(o):xi(new P.BufferGeometry,o,i),t[h]={primitive:o,promise:l},r.push(l))}return Promise.all(r)}loadMesh(b){for(var x=this,e=this.json,S=this.extensions,y=e.meshes[b],R=y.primitives,t=[],i=0,s=R.length;i<s;i++){var r=void 0===R[i].material?(void 0===(r=this.cache).DefaultMaterial&&(r.DefaultMaterial=new P.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:P.FrontSide})),r.DefaultMaterial):this.getDependency("material",R[i].material);t.push(r)}return t.push(x.loadGeometries(R)),Promise.all(t).then(function(e){for(var t=e.slice(0,e.length-1),i=e[e.length-1],s=[],r=0,n=i.length;r<n;r++){var a=i[r],o=R[r],h=void 0,l=t[r];if(o.mode===ni||o.mode===ai||o.mode===oi||void 0===o.mode)!0!==(h=new(!0===y.isSkinnedMesh?P.SkinnedMesh:P.Mesh)(a,l)).isSkinnedMesh||h.geometry.attributes.skinWeight.normalized||h.normalizeSkinWeights(),o.mode===ai?h.geometry=Si(h.geometry,P.TriangleStripDrawMode):o.mode===oi&&(h.geometry=Si(h.geometry,P.TriangleFanDrawMode));else if(o.mode===ii)h=new P.LineSegments(a,l);else if(o.mode===ri)h=new P.Line(a,l);else if(o.mode===si)h=new P.LineLoop(a,l);else{if(o.mode!==ti)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+o.mode);h=new P.Points(a,l)}if(0<Object.keys(h.geometry.morphAttributes).length){v=m=p=_=u=d=c=void 0;var c=h,d=y;if(c.updateMorphTargets(),void 0!==d.weights)for(var u=0,_=d.weights.length;u<_;u++)c.morphTargetInfluences[u]=d.weights[u];if(d.extras&&Array.isArray(d.extras.targetNames)){var p=d.extras.targetNames;if(c.morphTargetInfluences.length===p.length){c.morphTargetDictionary={};for(var m=0,v=p.length;m<v;m++)c.morphTargetDictionary[p[m]]=m}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}h.name=x.createUniqueName(y.name||"mesh_"+b),Ei(h,y),o.extensions&&fi(S,h,o),x.assignFinalMaterial(h),s.push(h)}for(var g=0,f=s.length;g<f;g++)x.associations.set(s[g],{meshes:b,primitives:g});if(1===s.length)return s[0];var E=new P.Group;x.associations.set(E,{meshes:b});for(var T=0,w=s.length;T<w;T++)E.add(s[T]);return E})}loadCamera(e){var t,e=this.json.cameras[e],i=e[e.type];if(i)return"perspective"===e.type?t=new P.PerspectiveCamera(P.MathUtils.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===e.type&&(t=new P.OrthographicCamera(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),e.name&&(t.name=this.createUniqueName(e.name)),Ei(t,e),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){var e=this.json.skins[e],t={joints:e.joints};return void 0===e.inverseBindMatrices?Promise.resolve(t):this.getDependency("accessor",e.inverseBindMatrices).then(function(e){return t.inverseBindMatrices=e,t})}loadAnimation(s){for(var r=this.json.animations[s],e=[],t=[],i=[],n=[],a=[],o=0,h=r.channels.length;o<h;o++){var l=r.channels[o],c=r.samplers[l.sampler],l=l.target,d=void 0!==l.node?l.node:l.id,u=void 0!==r.parameters?r.parameters[c.input]:c.input,_=void 0!==r.parameters?r.parameters[c.output]:c.output;e.push(this.getDependency("node",d)),t.push(this.getDependency("accessor",u)),i.push(this.getDependency("accessor",_)),n.push(c),a.push(l)}return Promise.all([Promise.all(e),Promise.all(t),Promise.all(i),Promise.all(n),Promise.all(a)]).then(function(e){for(var g=e[0],f=e[1],E=e[2],T=e[3],w=e[4],b=[],t=0,i=g.length;t<i;t++)!function(e){var t=g[e],i=f[e],s=E[e],r=T[e],n=w[e];if(void 0===t)return;t.updateMatrix(),t.matrixAutoUpdate=!0;var a=void 0;switch(_i[n.path]){case _i.weights:a=P.NumberKeyframeTrack;break;case _i.rotation:a=P.QuaternionKeyframeTrack;break;default:a=P.VectorKeyframeTrack}var e=t.name||t.uuid,o=void 0!==r.interpolation?pi[r.interpolation]:P.InterpolateLinear,h=[],l=(_i[n.path]===_i.weights?t.traverse(function(e){!0===e.isMesh&&e.morphTargetInfluences&&h.push(e.name||e.uuid)}):h.push(e),s.array);if(s.normalized){for(var c=wi(l.constructor),d=new Float32Array(l.length),u=0,_=l.length;u<_;u++)d[u]=l[u]*c;l=d}for(var p=0,m=h.length;p<m;p++){var v=new a(h[p]+"."+_i[n.path],i.array,l,o);"CUBICSPLINE"===r.interpolation&&(v.createInterpolant=function(e){return new(this instanceof P.QuaternionKeyframeTrack?ei:A)(this.times,this.values,this.getValueSize()/3,e)},v.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),b.push(v)}}(t);e=r.name||"animation_"+s;return new P.AnimationClip(e,void 0,b)})}createNodeMesh(e){var t=this.json,i=this,s=t.nodes[e];return void 0===s.mesh?null:i.getDependency("mesh",s.mesh).then(function(e){e=i._getNodeRef(i.meshCache,s.mesh,e);return void 0!==s.weights&&e.traverse(function(e){if(e.isMesh)for(var t=0,i=s.weights.length;t<i;t++)e.morphTargetInfluences[t]=s.weights[t]}),e})}loadNode(n){var t,e=this.json,a=this.extensions,o=this,h=e.nodes[n],l=h.name?o.createUniqueName(h.name):"";return t=[],(e=o._invokeOne(function(e){return e.createNodeMesh&&e.createNodeMesh(n)}))&&t.push(e),void 0!==h.camera&&t.push(o.getDependency("camera",h.camera).then(function(e){return o._getNodeRef(o.cameraCache,h.camera,e)})),o._invokeAll(function(e){return e.createNodeAttachment&&e.createNodeAttachment(n)}).forEach(function(e){t.push(e)}),Promise.all(t).then(function(e){var t,i=!0===h.isBone?new P.Bone:1<e.length?new P.Group:1===e.length?e[0]:new P.Object3D;if(i!==e[0])for(var s=0,r=e.length;s<r;s++)i.add(e[s]);return h.name&&(i.userData.name=h.name,i.name=l),Ei(i,h),h.extensions&&fi(a,i,h),void 0!==h.matrix?((t=new P.Matrix4).fromArray(h.matrix),i.applyMatrix4(t)):(void 0!==h.translation&&i.position.fromArray(h.translation),void 0!==h.rotation&&i.quaternion.fromArray(h.rotation),void 0!==h.scale&&i.scale.fromArray(h.scale)),o.associations.has(i)||o.associations.set(i,{}),o.associations.get(i).nodes=n,i})}loadScene(e){for(var t=this.json,i=this.extensions,e=this.json.scenes[e],r=this,s=new P.Group,n=(e.name&&(s.name=r.createUniqueName(e.name)),Ei(s,e),e.extensions&&fi(i,s,e),e.nodes||[]),a=[],o=0,h=n.length;o<h;o++)a.push(function a(e,o,h,l){var c=h.nodes[e];return l.getDependency("node",e).then(function(e){var o;return void 0===c.skin?e:l.getDependency("skin",c.skin).then(function(e){for(var t=[],i=0,s=(o=e).joints.length;i<s;i++)t.push(l.getDependency("node",o.joints[i]));return Promise.all(t)}).then(function(a){return e.traverse(function(e){if(e.isMesh){for(var t=[],i=[],s=0,r=a.length;s<r;s++){var n=a[s];n?(t.push(n),n=new P.Matrix4,void 0!==o.inverseBindMatrices&&n.fromArray(o.inverseBindMatrices.array,16*s),i.push(n)):console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',o.joints[s])}e.bind(new P.Skeleton(t,i),e.matrixWorld)}}),e})}).then(function(e){o.add(e);var t=[];if(c.children)for(var i=c.children,s=0,r=i.length;s<r;s++){var n=i[s];t.push(a(n,e,h,l))}return Promise.all(t)})}(n[o],s,t,r));return Promise.all(a).then(function(){return r.associations=(e=>{var t,i,s=new Map;for([t,i]of r.associations)(t instanceof P.Material||t instanceof P.Texture)&&s.set(t,i);return e.traverse(e=>{var t=r.associations.get(e);null!=t&&s.set(e,t)}),s})(s),s})}}function xi(p,m,v){var e,t=m.attributes,i=[];for(e in t){var s=ui[e]||e.toLowerCase();s in p.attributes||i.push(function(e,t){return v.getDependency("accessor",e).then(function(e){p.setAttribute(t,e)})}(t[e],s))}void 0===m.indices||p.index||(r=v.getDependency("accessor",m.indices).then(function(e){p.setIndex(e)}),i.push(r)),Ei(p,m);var r=p,n=m,a=v,o=n.attributes,h=new P.Box3;if(void 0!==o.POSITION){var o=a.json.accessors[o.POSITION],l=o.min,c=o.max;if(void 0===l||void 0===c)console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");else{h.set(new P.Vector3(l[0],l[1],l[2]),new P.Vector3(c[0],c[1],c[2])),o.normalized&&(l=wi(hi[o.componentType]),h.min.multiplyScalar(l),h.max.multiplyScalar(l));var d=n.targets;if(void 0!==d){for(var u=new P.Vector3,_=new P.Vector3,g=0,f=d.length;g<f;g++){var E,T,w=d[g];void 0!==w.POSITION&&(T=(w=a.json.accessors[w.POSITION]).min,E=w.max,void 0!==T&&void 0!==E?(_.setX(Math.max(Math.abs(T[0]),Math.abs(E[0]))),_.setY(Math.max(Math.abs(T[1]),Math.abs(E[1]))),_.setZ(Math.max(Math.abs(T[2]),Math.abs(E[2]))),w.normalized&&(T=wi(hi[w.componentType]),_.multiplyScalar(T)),u.max(_)):console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION."))}h.expandByVector(u)}r.boundingBox=h;c=new P.Sphere;h.getCenter(c.center),c.radius=h.min.distanceTo(h.max)/2,r.boundingSphere=c}}return Promise.all(i).then(function(){if(void 0===m.targets)return p;for(var i=p,e=m.targets,t=v,s=!1,r=!1,n=0,a=e.length;n<a;n++){var o=e[n];if(void 0!==o.POSITION&&(s=!0),void 0!==o.NORMAL&&(r=!0),s&&r)break}if(!s&&!r)return Promise.resolve(i);for(var h=[],l=[],c=0,d=e.length;c<d;c++){var u,_=e[c];s&&(u=void 0!==_.POSITION?t.getDependency("accessor",_.POSITION):i.attributes.position,h.push(u)),r&&(u=void 0!==_.NORMAL?t.getDependency("accessor",_.NORMAL):i.attributes.normal,l.push(u))}return Promise.all([Promise.all(h),Promise.all(l)]).then(function(e){var t=e[0],e=e[1];return s&&(i.morphAttributes.position=t),r&&(i.morphAttributes.normal=e),i.morphTargetsRelative=!0,i})})}function Si(e,t){var i=e.getIndex();if(null===i){var s=[],r=e.getAttribute("position");if(void 0===r)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(var n=0;n<r.count;n++)s.push(n);e.setIndex(s),i=e.getIndex()}var a=i.count-2,o=[];if(t===P.TriangleFanDrawMode)for(var h=1;h<=a;h++)o.push(i.getX(0)),o.push(i.getX(h)),o.push(i.getX(h+1));else for(var l=0;l<a;l++)l%2==0?(o.push(i.getX(l)),o.push(i.getX(l+1)),o.push(i.getX(l+2))):(o.push(i.getX(l+2)),o.push(i.getX(l+1)),o.push(i.getX(l)));o.length/3!=a&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");t=e.clone();return t.setIndex(o),t}var yi=new WeakMap;class Ri extends P.Loader{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,i,t,s){var r=new P.FileLoader(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,e=>{var t={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(e,t).then(i).catch(s)},t,s)}decodeDracoFile(e,t,i,s){s={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:s||this.defaultAttributeTypes,useUniqueIDs:!!i};this.decodeGeometry(e,s).then(t)}decodeGeometry(i,s){for(var e in s.attributeTypes){var t=s.attributeTypes[e];void 0!==t.BYTES_PER_ELEMENT&&(s.attributeTypes[e]=t.name)}var r,n=JSON.stringify(s);if(yi.has(i)){var a=yi.get(i);if(a.key===n)return a.promise;if(0===i.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var o=this.workerNextTaskID++,a=i.byteLength,a=this._getWorker(o,a).then(e=>(r=e,new Promise((e,t)=>{r._callbacks[o]={resolve:e,reject:t},r.postMessage({type:"decode",id:o,taskConfig:s,buffer:i},[i])}))).then(e=>this._createGeometry(e.geometry));return a.catch(()=>!0).then(()=>{r&&o&&this._releaseTask(r,o)}),yi.set(i,{key:n,promise:a}),a}_createGeometry(e){var t=new P.BufferGeometry;e.index&&t.setIndex(new P.BufferAttribute(e.index.array,1));for(var i=0;i<e.attributes.length;i++){var s=e.attributes[i],r=s.name,n=s.array,s=s.itemSize;t.setAttribute(r,new P.BufferAttribute(n,s))}return t}_loadLibrary(i,e){var s=new P.FileLoader(this.manager);return s.setPath(this.decoderPath),s.setResponseType(e),s.setWithCredentials(this.withCredentials),new Promise((e,t)=>{s.load(i,e,void 0,t)})}preload(){return this._initDecoder(),this}_initDecoder(){var i,e;return this.decoderPending||(e=[],(i="object"!=typeof WebAssembly||"js"===this.decoderConfig.type)?e.push(this._loadLibrary("draco_decoder.js","text")):(e.push(this._loadLibrary("draco_wasm_wrapper.js","text")),e.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(e).then(e=>{var t=e[0],e=(i||(this.decoderConfig.wasmBinary=e[1]),function(){var i,t;function h(e,t,i,s){var r,n=s.attributeIDs,a=s.attributeTypes,o=t.GetEncodedGeometryType(i);if(o===e.TRIANGULAR_MESH)r=new e.Mesh,g=t.DecodeBufferToMesh(i,r);else{if(o!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");r=new e.PointCloud,g=t.DecodeBufferToPointCloud(i,r)}if(!g.ok()||0===r.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+g.error_msg());var h,l,c,d,u,_,p,m,v,g,f,E,T,w={index:null,attributes:[]};for(h in n){var b=self[a[h]],x=void 0,S=void 0;if(s.useUniqueIDs)S=n[h],x=t.GetAttributeByUniqueId(r,S);else{if(-1===(S=t.GetAttributeId(r,e[n[h]])))continue;x=t.GetAttribute(r,S)}w.attributes.push((S=e,l=t,c=r,d=h,b=b,v=m=p=_=u=void 0,u=(x=x).num_components(),_=c.num_points()*u,p=_*b.BYTES_PER_ELEMENT,m=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(S,b),v=S._malloc(p),l.GetAttributeDataArrayForAllPoints(c,x,m,p,v),l=new b(S.HEAPF32.buffer,v,_).slice(),S._free(v),{name:d,array:l,itemSize:u}))}return o===e.TRIANGULAR_MESH&&(w.index=(i=e,g=t,f=3*(o=r).num_faces(),E=4*f,T=i._malloc(E),g.GetTrianglesUInt32Array(o,E,T),g=new Uint32Array(i.HEAPF32.buffer,T,f).slice(),i._free(T),{array:g,itemSize:1})),e.destroy(r),w}onmessage=function(e){var n=e.data;switch(n.type){case"init":i=n.decoderConfig,t=new Promise(function(t){i.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(i)});break;case"decode":var a=n.buffer,o=n.taskConfig;t.then(e=>{var e=e.draco,t=new e.Decoder,i=new e.DecoderBuffer;i.Init(new Int8Array(a),a.byteLength);try{var s=h(e,t,i,o),r=s.attributes.map(e=>e.array.buffer);s.index&&r.push(s.index.array.buffer),self.postMessage({type:"decode",id:n.id,geometry:s},r)}catch(e){console.error(e),self.postMessage({type:"error",id:n.id,error:e.message})}finally{e.destroy(i),e.destroy(t)}})}}}.toString()),t=["/* draco decoder */",t,"","/* worker */",e.substring(e.indexOf("{")+1,e.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([t]))})),this.decoderPending}_getWorker(t,s){return this._initDecoder().then(()=>{this.workerPool.length<this.workerLimit?((i=new Worker(this.workerSourceURL))._callbacks={},i._taskCosts={},i._taskLoad=0,i.postMessage({type:"init",decoderConfig:this.decoderConfig}),i.onmessage=function(e){var t=e.data;switch(t.type){case"decode":i._callbacks[t.id].resolve(t);break;case"error":i._callbacks[t.id].reject(t);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+t.type+'"')}},this.workerPool.push(i)):this.workerPool.sort(function(e,t){return e._taskLoad>t._taskLoad?-1:1});var i,e=this.workerPool[this.workerPool.length-1];return e._taskCosts[t]=s,e._taskLoad+=s,e})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(var e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}class Li{constructor(){this.pool=0<arguments.length&&void 0!==arguments[0]?arguments[0]:4,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){var t;this.workers[e]||((t=this.workerCreator()).addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t)}_getIdleWorker(){for(var e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){var i,s=this.workersResolve[e];s&&s(t),this.queue.length?({resolve:s,msg:t,transfer:i}=this.queue.shift(),this.workersResolve[e]=s,this.workers[e].postMessage(t,i)):this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(i,s){return new Promise(e=>{var t=this._getIdleWorker();-1!==t?(this._initWorker(t),this.workerStatus|=1<<t,this.workersResolve[t]=e,this.workers[t].postMessage(i,s)):this.queue.push({resolve:e,msg:i,transfer:s})})}dispose(){this.workers.forEach(e=>e.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}var Ai=new WeakMap,Oi=0;class s extends P.Loader{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new Li,this.workerSourceURL="",this.workerConfig=null,"undefined"!=typeof MSC_TRANSCODER&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerPool.setWorkerLimit(e),this}detectSupport(e){return this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},this}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),this}init(){var e,t;return this.transcoderPending||((e=new P.FileLoader(this.manager)).setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials),e=e.loadAsync("basis_transcoder.js"),(t=new P.FileLoader(this.manager)).setPath(this.transcoderPath),t.setResponseType("arraybuffer"),t.setWithCredentials(this.withCredentials),t=t.loadAsync("basis_transcoder.wasm"),this.transcoderPending=Promise.all([e,t]).then(e=>{var[e,t]=e,i=s.BasisWorker.toString(),e=["/* constants */","let _EngineFormat = "+JSON.stringify(s.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(s.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(s.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([e])),this.transcoderBinary=t,this.workerPool.setWorkerCreator(()=>{var e=new Worker(this.workerSourceURL),t=this.transcoderBinary.slice(0);return e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:t},[t]),e})}),0<Oi&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),Oi++),this.transcoderPending}load(e,t,i,s){if(null===this.workerConfig)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");var r=new P.FileLoader(this.manager),n=(r.setResponseType("arraybuffer"),r.setWithCredentials(this.withCredentials),new P.CompressedTexture);return r.load(e,e=>{if(Ai.has(e))return Ai.get(e).promise.then(t).catch(s);this._createTexture([e]).then(function(e){n.copy(e),n.needsUpdate=!0,t&&t(n)}).catch(s)},i,s),n}_createTextureFrom(e){var{mipmaps:e,width:t,height:i,format:s,type:r,error:n,dfdTransferFn:a,dfdFlags:o}=e;return"error"===r?Promise.reject(n):((r=new P.CompressedTexture(e,t,i,s,P.UnsignedByteType)).minFilter=1===e.length?P.LinearFilter:P.LinearMipmapLinearFilter,r.magFilter=P.LinearFilter,r.generateMipmaps=!1,r.needsUpdate=!0,r.encoding=2===a?P.sRGBEncoding:P.LinearEncoding,r.premultiplyAlpha=!!(1&o),r)}_createTexture(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=this.init().then(()=>this.workerPool.postMessage({type:"transcode",buffers:e,taskConfig:t},e)).then(e=>this._createTextureFrom(e.data));return Ai.set(e[0],{promise:i}),i}dispose(){return URL.revokeObjectURL(this.workerSourceURL),this.workerPool.dispose(),Oi--,this}}s.BasisFormat={ETC1S:0,UASTC_4x4:1},s.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},s.EngineFormat={RGBAFormat:P.RGBAFormat,RGBA_ASTC_4x4_Format:P.RGBA_ASTC_4x4_Format,RGBA_BPTC_Format:P.RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:P.RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format:P.RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format:P.RGBA_S3TC_DXT5_Format,RGB_ETC1_Format:P.RGB_ETC1_Format,RGB_ETC2_Format:P.RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format:P.RGB_PVRTC_4BPPV1_Format,RGB_S3TC_DXT1_Format:P.RGB_S3TC_DXT1_Format},s.BasisWorker=function(){var m,i,v,g=_EngineFormat,f=_TranscoderFormat,E=_BasisFormat;self.addEventListener("message",function(e){var t,l=e.data;switch(l.type){case"init":m=l.config,t=l.transcoderBinary,i=new Promise(e=>{v={wasmBinary:t,onRuntimeInitialized:e},BASIS(v)}).then(()=>{v.initializeBasis(),void 0===v.KTX2File&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")});break;case"transcode":i.then(()=>{try{for(var{width:e,height:t,hasAlpha:i,mipmaps:s,format:r,dfdTransferFn:n,dfdFlags:a}=function(e){var t=new v.KTX2File(new Uint8Array(e));function i(){t.close(),t.delete()}if(!t.isValid())throw i(),new Error("THREE.KTX2Loader:\tInvalid or unsupported .ktx2 file");var e=t.isUASTC()?E.UASTC_4x4:E.ETC1S,s=t.getWidth(),r=t.getHeight(),n=t.getLevels(),a=t.getHasAlpha(),o=t.getDFDTransferFunc(),h=t.getDFDFlags(),{transcoderFormat:l,engineFormat:e}=function(e,t,i,s){for(var r,n,a=e===E.ETC1S?T:w,o=0;o<a.length;o++){var h=a[o];if(m[h.if]&&(h.basisFormat.includes(e)&&(!h.needsPowerOfTwo||b(t)&&b(i))))return r=h.transcoderFormat[s?1:0],n=h.engineFormat[s?1:0],{transcoderFormat:r,engineFormat:n}}return console.warn("THREE.KTX2Loader: No suitable compressed texture format found. Decoding to RGBA32."),r=f.RGBA32,n=g.RGBAFormat,{transcoderFormat:r,engineFormat:n}}(e,s,r,a);if(!s||!r||!n)throw i(),new Error("THREE.KTX2Loader:\tInvalid texture");if(!t.startTranscoding())throw i(),new Error("THREE.KTX2Loader: .startTranscoding failed");for(var c=[],d=0;d<n;d++){var u=t.getImageLevelInfo(d,0,0),_=u.origWidth,u=u.origHeight,p=new Uint8Array(t.getImageTranscodedSizeInBytes(d,0,0,l));if(!t.transcodeImage(p,d,0,0,l,0,-1,-1))throw i(),new Error("THREE.KTX2Loader: .transcodeImage failed.");c.push({data:p,width:_,height:u})}return i(),{width:s,height:r,hasAlpha:a,mipmaps:c,format:e,dfdTransferFn:o,dfdFlags:h}}(l.buffers[0]),o=[],h=0;h<s.length;++h)o.push(s[h].data.buffer);self.postMessage({type:"transcode",id:l.id,width:e,height:t,hasAlpha:i,mipmaps:s,format:r,dfdTransferFn:n,dfdFlags:a},o)}catch(e){console.error(e),self.postMessage({type:"error",id:l.id,error:e.message})}})}});var e=[{if:"astcSupported",basisFormat:[E.UASTC_4x4],transcoderFormat:[f.ASTC_4x4,f.ASTC_4x4],engineFormat:[g.RGBA_ASTC_4x4_Format,g.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[E.ETC1S,E.UASTC_4x4],transcoderFormat:[f.BC7_M5,f.BC7_M5],engineFormat:[g.RGBA_BPTC_Format,g.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[E.ETC1S,E.UASTC_4x4],transcoderFormat:[f.BC1,f.BC3],engineFormat:[g.RGB_S3TC_DXT1_Format,g.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[E.ETC1S,E.UASTC_4x4],transcoderFormat:[f.ETC1,f.ETC2],engineFormat:[g.RGB_ETC2_Format,g.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[E.ETC1S,E.UASTC_4x4],transcoderFormat:[f.ETC1,f.ETC1],engineFormat:[g.RGB_ETC1_Format,g.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[E.ETC1S,E.UASTC_4x4],transcoderFormat:[f.PVRTC1_4_RGB,f.PVRTC1_4_RGBA],engineFormat:[g.RGB_PVRTC_4BPPV1_Format,g.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],T=e.sort(function(e,t){return e.priorityETC1S-t.priorityETC1S}),w=e.sort(function(e,t){return e.priorityUASTC-t.priorityUASTC});function b(e){return e<=2||0==(e&e-1)&&0!==e}};class Ci{constructor({src:e,scenes:t,center:i=$,parser:s=null,animations:r=[],annotations:n=[],variants:a=[],fixSkinnedBbox:o=!1,castShadow:h=!0,receiveShadow:l=!1}){this._src=e;e=new P.Group,e.add(...t),this._scene=e,this._parser=s,this._animations=r,this._annotations=n,this._variants=a,t=this._getInitialBbox(o),s=t.min.y;e.translateY(-s),e.updateMatrixWorld(),t.translate(new P.Vector3(0,-s,0)),this._fixSkinnedBbox=o,this._bbox=t,this._center=i===$?t.getCenter(new P.Vector3):ae(i,t),this.castShadow=h,this.receiveShadow=l}get src(){return this._src}get scene(){return this._scene}get animations(){return this._animations}get annotations(){return this._annotations}get meshes(){return this._getAllMeshes()}get bbox(){return this._bbox}get center(){return this._center}set castShadow(t){this.meshes.forEach(e=>e.castShadow=t)}set receiveShadow(t){this.meshes.forEach(e=>e.receiveShadow=t)}selectVariant(t){return Q(this,void 0,void 0,function*(){var e=this._variants;const s=this._parser;if(!(e.length<=0)&&s){let i=0;null!=t&&(i=n(t)?e.findIndex(({name:e})=>e===t):t);e=this._scene;const r=[];return e.traverse(t=>Q(this,void 0,void 0,function*(){var e;t.isMesh&&t.userData.gltfExtensions&&(e=t.userData.gltfExtensions[De])&&(t.userData.originalMaterial||(t.userData.originalMaterial=t.material),(e=e.mappings.find(e=>e.variants.includes(i)))?(e=s.getDependency("material",e.material),r.push(e),t.material=yield e,s.assignFinalMaterial(t)):t.material=t.userData.originalMaterial)})),Promise.all(r)}})}reduceVertices(n,e){var t=this.meshes;let a=e;return t.forEach(t=>{var i=t.geometry.attributes["position"];if(i)if(t.updateMatrixWorld(),this._fixSkinnedBbox&&t.isSkinnedMesh)this._forEachSkinnedVertices(t,e=>{a=n(a,e)});else{var s=q(i);for(let e=0;e<i.count;e++){var r=(new P.Vector3).fromBufferAttribute(i,e);i.normalized&&r.multiplyScalar(s),r.applyMatrix4(t.matrixWorld),a=n(a,r)}}}),a}_getInitialBbox(e){return this._scene.updateMatrixWorld(),e&&this._hasSkinnedMesh()?this._getSkeletonBbox():(new P.Box3).setFromObject(this._scene)}_getSkeletonBbox(){const t=new P.Box3;return this.meshes.forEach(e=>{e.isSkinnedMesh?this._forEachSkinnedVertices(e,e=>t.expandByPoint(e)):t.expandByObject(e)}),t}_getAllMeshes(){const t=[];return this._scene.traverse(e=>{e.isMesh&&t.push(e)}),t.sort((e,t)=>e.name.localeCompare(t.name))}_hasSkinnedMesh(){return this._getAllMeshes().some(e=>e.isSkinnedMesh)}_forEachSkinnedVertices(t,i){var e=t.geometry,s=e.attributes.position,e=e.attributes.skinWeight,r=(t.skeleton.update(),q(s)),n=q(e);for(let e=0;e<s.count;e++)i(Y(e,t,r,n))}}const Mi=new Ri,Di=new s;class O extends Oe{constructor(e){super(e),this._loader=new Mt;var t=this._loader;t.setCrossOrigin("anonymous"),t.setDRACOLoader(Mi),t.setKTX2Loader(Di.detectSupport(e.renderer.threeRenderer))}static setMeshoptDecoder(s){return Q(this,void 0,void 0,function*(){return new Promise((e,t)=>{const i=document.createElement("script");i.addEventListener("load",()=>Q(this,void 0,void 0,function*(){yield window.MeshoptDecoder.ready,O.meshoptDecoder=window.MeshoptDecoder,document.body.removeChild(i),e()})),i.addEventListener("error",()=>{document.body.removeChild(i),t()}),i.src=new URL(s,location.href).href,document.body.appendChild(i)})})}load(s){var e=this._view3D;const r=this._loader,n=X(e,s);return Mi.setDecoderPath(e.dracoPath),Di.setTranscoderPath(e.ktxPath),O.meshoptDecoder&&r.setMeshoptDecoder(O.meshoptDecoder),r.manager=P.DefaultLoadingManager,new Promise((i,t)=>{try{r.load(s,t=>Q(this,void 0,void 0,function*(){var e=yield this._parseToModel(t,s);i(e)}),e=>this._onLoadingProgress(e,s,n),e=>{n.initialized=!0,t(e)})}catch(e){t(e)}})}loadFromFiles(o){const h=this._view3D,l=this._loader,c=[],d=()=>{c.forEach(e=>{URL.revokeObjectURL(e)})};return Mi.setDecoderPath(h.dracoPath),Di.setTranscoderPath(h.ktxPath),O.meshoptDecoder&&l.setMeshoptDecoder(O.meshoptDecoder),new Promise((i,t)=>{if(o.length<=0)t(new Error("No files found"));else{const s=o.find(e=>/\.(gltf|glb)$/i.test(e.name));if(s){const r=new Map,n=(o.forEach(e=>{r.set(e.name,e)}),URL.createObjectURL(s));c.push(n);var e=new P.LoadingManager;e.setURLModifier(e=>{var t;return!/^data:.*,.*$/i.test(e)&&(t=(t=/[^\/|\\]+$/.exec(e))&&t[0]||"",r.has(t))?(t=r.get(t),t=URL.createObjectURL(t),c.push(t),t):e});const a=X(h,n);l.manager=e,l.load(n,t=>Q(this,void 0,void 0,function*(){var e=yield this._parseToModel(t,s.name);d(),i(e)}),e=>this._onLoadingProgress(e,n,a),e=>{a.initialized=!0,d(),t(e)})}else t(new Error("No glTF file found"))}})}_parseToModel(c,d){var u;return Q(this,void 0,void 0,function*(){const r=this._view3D;var e=r.fixSkinnedBbox;c.scenes.forEach(e=>{e.traverse(e=>{e.frustumCulled=!1})});const a=r.renderer.threeRenderer.capabilities.maxTextureSize,t=[],o=(c.scenes.forEach(e=>{e.traverse(e=>{e.isMesh&&t.push(e)})}),t.reduce((e,t)=>[...e,...Array.isArray(t.material)?t.material:[t.material]],[]).reduce((e,t)=>[...e,...Me.filter(e=>t[e]).map(e=>t[e])],[])),i=c.parser.associations,s=c.parser.json;var n=o.filter(e=>i.has(e)).map(e=>s.textures[i.get(e).textures]),n=Array.from(new Set(n).values()).reduce((s,e,t)=>{var i=e.extensions&&e.extensions[Ie],r=e.extras&&e.extras[Pe];if(i||r){const n=o[t];(i?e.extensions[Ie]:e.extras[Pe]).levels.forEach(({index:e,size:t},i)=>{t>a||(s[i]||(s[i]=[]),s[i].push({index:e,texture:n}))})}return s},[]);const h=n.map(()=>!1);n.forEach((i,s)=>Q(this,void 0,void 0,function*(){var e=yield Promise.all(i.map(({index:e})=>c.parser.getDependency("texture",e))),t=h.slice(s+1).some(e=>!!e);h[s]=!0,t||e.forEach((e,t)=>{t=i[t].texture;t.image=e.image,t.needsUpdate=!0,r.renderer.renderSingleFrame()})}));var n=[],l=(c.parser.json.extras&&c.parser.json.extras[Ne]&&(l=c.parser.json.extras[Ne],n.push(...r.annotation.parse(l))),null!=(u=c.userData)?u:{}),l=null!=(u=l.gltfExtensions)?u:{},l=l[De]?l[De].variants:[],n=new Ci({src:d,scenes:c.scenes,center:r.center,annotations:n,parser:c.parser,animations:c.animations,variants:l,fixSkinnedBbox:e});return r.variant&&(yield n.selectVariant(r.variant)),n})}}class Ii extends D{constructor(e,{src:t=null,iosSrc:i=null,variant:s=null,dracoPath:r="https://www.gstatic.com/draco/versioned/decoders/1.4.1/",ktxPath:n="https://unpkg.com/three@0.134.0/examples/js/libs/basis/",meshoptPath:a=null,fixSkinnedBbox:o=!1,fov:h=$,center:l=$,yaw:c=0,pitch:d=0,pivot:u=$,initialZoom:_=0,rotate:p=!0,translate:m=!0,zoom:v=!0,autoplay:g=!1,scrollable:f=!0,wheelScrollable:E=!1,useGrabCursor:T=!0,ignoreCenterOnFit:w=!1,skybox:b=null,envmap:x=null,background:S=null,exposure:y=1,shadow:R=!0,skyboxBlur:L=!1,toneMapping:A=xe.LINEAR,useDefaultEnv:O=!0,defaultAnimationIndex:C=0,animationRepeatMode:M=Re.ONE,annotationURL:D=null,annotationWrapper:I="."+J.ANNOTATION_WRAPPER,annotationSelector:F="."+J.ANNOTATION,annotationBreakpoints:U=je,annotationAutoUnfocus:B=!0,webAR:k=!0,sceneViewer:H=!0,quickLook:V=!0,arPriority:G=Ke,poster:z=null,canvasSelector:W="canvas",autoInit:P=!0,autoResize:j=!0,useResizeObserver:K=!0,maintainSize:X=!1,on:q={},plugins:N=[],maxDeltaTime:Y=1/30}={}){super(),this._rootEl=ee(e),this._src=t,this._iosSrc=i,this._variant=s,this._dracoPath=r,this._ktxPath=n,this._meshoptPath=a,this._fixSkinnedBbox=o,this._fov=h,this._center=l,this._yaw=c,this._pitch=d,this._pivot=u,this._initialZoom=_,this._rotate=p,this._translate=m,this._zoom=v,this._autoplay=g,this._scrollable=f,this._wheelScrollable=E,this._useGrabCursor=T,this._ignoreCenterOnFit=w,this._skybox=b,this._envmap=x,this._background=S,this._exposure=y,this._shadow=R,this._skyboxBlur=L,this._toneMapping=A,this._useDefaultEnv=O,this._defaultAnimationIndex=C,this._animationRepeatMode=M,this._annotationURL=D,this._annotationWrapper=I,this._annotationSelector=F,this._annotationBreakpoints=U,this._annotationAutoUnfocus=B,this._webAR=k,this._sceneViewer=H,this._quickLook=V,this._arPriority=G,this._poster=z,this._canvasSelector=W,this._autoInit=P,this._autoResize=j,this._useResizeObserver=K,this._maintainSize=X,this._model=null,this._initialized=!1,this._loadingContext=[],this._plugins=N,this._maxDeltaTime=Y,this._renderer=new Le(this),this._camera=new qe(this),this._control=new Ot(this),this._scene=new Ve(this),this._animator=new Ze(this),this._autoPlayer=new Ct(this,Z(g)),this._autoResizer=new Ye(this),this._arManager=new wt(this),this._annotationManager=new yt(this),this._addEventHandlers(q),this._addPosterImage(),Q(this,void 0,void 0,function*(){yield this._initPlugins(N),t&&P&&(yield this.init())})}get renderer(){return this._renderer}get scene(){return this._scene}get camera(){return this._camera}get control(){return this._control}get autoPlayer(){return this._autoPlayer}get model(){return this._model}get animator(){return this._animator}get ar(){return this._arManager}get annotation(){return this._annotationManager}get rootEl(){return this._rootEl}get initialized(){return this._initialized}get loadingContext(){return this._loadingContext}get plugins(){return this._plugins}get src(){return this._src}get iosSrc(){return this._iosSrc}get variant(){return this._variant}get dracoPath(){return this._dracoPath}get ktxPath(){return this._ktxPath}get meshoptPath(){return this._meshoptPath}get fixSkinnedBbox(){return this._fixSkinnedBbox}get fov(){return this._fov}get center(){return this._center}get yaw(){return this._yaw}get pitch(){return this._pitch}get pivot(){return this._pivot}get initialZoom(){return this._initialZoom}get rotate(){return this._rotate}get translate(){return this._translate}get zoom(){return this._zoom}get autoplay(){return this._autoplay}get scrollable(){return this._scrollable}get wheelScrollable(){return this._wheelScrollable}get useGrabCursor(){return this._useGrabCursor}get ignoreCenterOnFit(){return this._ignoreCenterOnFit}get skybox(){return this._skybox}get envmap(){return this._envmap}get background(){return this._background}get exposure(){return this._exposure}get shadow(){return this._shadow}get skyboxBlur(){return this._skyboxBlur}get toneMapping(){return this._toneMapping}get useDefaultEnv(){return this._useDefaultEnv}get defaultAnimationIndex(){return this._defaultAnimationIndex}get animationRepeatMode(){return this._animationRepeatMode}get annotationURL(){return this._annotationURL}get annotationWrapper(){return this._annotationWrapper}get annotationSelector(){return this._annotationSelector}get annotationBreakpoints(){return this._annotationBreakpoints}get annotationAutoUnfocus(){return this._annotationAutoUnfocus}get webAR(){return this._webAR}get sceneViewer(){return this._sceneViewer}get quickLook(){return this._quickLook}get arPriority(){return this._arPriority}get poster(){return this._poster}get canvasSelector(){return this._canvasSelector}get autoInit(){return this._autoInit}get autoResize(){return this._autoResize}get useResizeObserver(){return this._useResizeObserver}get maintainSize(){return this._maintainSize}get maxDeltaTime(){return this._maxDeltaTime}set iosSrc(e){this._iosSrc=e}set variant(e){this._model&&this._model.selectVariant(e).then(()=>{this.renderer.renderSingleFrame()}),this._variant=e}set defaultAnimationIndex(e){this._defaultAnimationIndex=e}set initialZoom(e){this._initialZoom=e}set skybox(e){this._scene.setSkybox(e),!(this._skybox=e)&&this._useDefaultEnv&&this._scene.setDefaultEnv()}set envmap(e){this._scene.setEnvMap(e),!(this._envmap=e)&&this._useDefaultEnv&&this._scene.setDefaultEnv()}set exposure(e){this._exposure=e,this._renderer.threeRenderer.toneMappingExposure=e,this._renderer.renderSingleFrame()}set skyboxBlur(e){this._skyboxBlur=e;var t=this._scene,i=t.root,t=t.root.environment;t&&null!==i.background&&(i.background=e?b.createBlurredHDR(this,t):t)}set toneMapping(e){this._toneMapping=e,this._renderer.threeRenderer.toneMapping=e,this._renderer.renderSingleFrame()}set useGrabCursor(e){this._useGrabCursor=e,this._control.updateCursor()}set animationRepeatMode(e){this._animationRepeatMode=e,this._animator.updateRepeatMode()}set autoResize(e){(this._autoResize=e)?this._autoResizer.enable():this._autoResizer.disable()}set maintainSize(e){this._maintainSize=e}set maxDeltaTime(e){this._maxDeltaTime=e}destroy(){this._scene.reset(),this._renderer.destroy(),this._control.destroy(),this._autoResizer.disable(),this._animator.destroy(),this._annotationManager.destroy(),this._plugins.forEach(e=>e.teardown(this)),this._plugins=[]}init(){return Q(this,void 0,void 0,function*(){if(!this._src)throw new h(c.PROVIDE_SRC_FIRST,l.PROVIDE_SRC_FIRST);var e=this._scene,t=this._renderer,i=this._control,s=this._animator,r=this._annotationManager,n=this._meshoptPath,a=[],s=(this.resize(),s.init(),r.init(),this._autoResize&&this._autoResizer.enable(),n&&!O.meshoptDecoder&&(yield O.setMeshoptDecoder(n)),a.push(...e.initTextures()),this._loadModel(this._src));a.push(...s),this._resetLoadingContextOnFinish(a),yield Promise.race(s),this._annotationURL&&(yield this._annotationManager.load(this._annotationURL)),i.enable(),this._autoplay&&this._autoPlayer.enable(),t.stopAnimationLoop(),t.setAnimationLoop(t.defaultRenderLoop),t.renderSingleFrame(),this._initialized=!0,this.trigger(E.READY,{type:E.READY,target:this})})}resize(){var e=this._renderer,t=this._initialized?e.size:null,i=(e.resize(),e.size);this._camera.resize(i,t),this._control.resize(i),this._annotationManager.resize(),this._initialized&&e.renderSingleFrame(!0),this.trigger(E.RESIZE,Object.assign(Object.assign({},i),{type:E.RESIZE,target:this}))}load(t,{iosSrc:i=null}={}){return Q(this,void 0,void 0,function*(){var e;this._initialized?(e=this._loadModel(t),this._resetLoadingContextOnFinish(e),yield Promise.race(e),this._src=t,this._iosSrc=i):(this._src=t,this._iosSrc=i,yield this.init())})}display(e,{resetCamera:t=!0}={}){var i=this._renderer,s=this._scene,r=this._camera,n=this._animator,a=this._annotationManager,o=i.threeRenderer.xr.isPresenting;s.reset(),s.add(e.scene),s.shadowPlane.updateDimensions(e),t&&(r.fit(e),r.reset(0)),n.reset(),n.setClips(e.animations),0<e.animations.length&&n.play(this._defaultAnimationIndex),a.reset(),a.collect(),a.add(...e.annotations),this._model=e,o&&(s=this._arManager.activeSession)&&s.control.syncTargetModel(e),this._initialized&&i.renderSingleFrame(),this.trigger(E.MODEL_CHANGE,{type:E.MODEL_CHANGE,target:this,model:e})}loadPlugins(...e){return Q(this,void 0,void 0,function*(){yield this._initPlugins(e),this._plugins.push(...e)})}removePlugins(...e){return Q(this,void 0,void 0,function*(){yield Promise.all(e.map(e=>e.teardown(this))),e.forEach(e=>{e=this._plugins.indexOf(e);e<0||this._plugins.splice(e,1)})})}screenshot(e="screenshot"){var t=this._renderer.canvas.toDataURL("png"),i=document.createElement("a");i.href=t,i.download=e,i.click()}_loadModel(e){const i=new O(this);if(Array.isArray(e)){const s=e.map(()=>!1);return e.map((e,t)=>this._loadSingleModel(i,e,t,s))}return[this._loadSingleModel(i,e,0,[!1])]}_loadSingleModel(r,n,a,o){return Q(this,void 0,void 0,function*(){var t=o.length-1;this.trigger(E.LOAD_START,{type:E.LOAD_START,target:this,src:n,level:a,maxLevel:t});try{var e=yield r.load(n),i=o.slice(a+1).some(e=>!!e),s=o.some(e=>!!e);this.trigger(E.LOAD,{type:E.LOAD,target:this,model:e,level:a,maxLevel:t}),o[a]=!0,i||this.display(e,{resetCamera:!s})}catch(e){throw this.trigger(E.LOAD_ERROR,{type:E.LOAD_ERROR,target:this,level:a,maxLevel:t,error:e}),new h(c.MODEL_FAIL_TO_LOAD(n),l.MODEL_FAIL_TO_LOAD)}})}_addEventHandlers(t){Object.keys(t).forEach(e=>{this.on(e,t[e])})}_addPosterImage(){var t=this._poster;const i=this._rootEl;if(t){var s=N(t);let e;if(s||B(t)){s=s?t:i.querySelector(t);if(!s)throw new h(c.ELEMENT_NOT_FOUND(t),l.ELEMENT_NOT_FOUND);e=s}else{const r=document.createElement("img");r.className=J.POSTER,r.src=t,i.appendChild(r),e=r,this.once(E.READY,()=>{r.parentElement===i&&i.removeChild(r)})}this.once(E.READY,()=>{e.parentElement&&e.parentElement.removeChild(e)})}}_initPlugins(e){return Q(this,void 0,void 0,function*(){yield Promise.all(e.map(e=>e.init(this)))})}_resetLoadingContextOnFinish(e){return Q(this,void 0,void 0,function*(){Promise.all(e).then(()=>{this.trigger(E.LOAD_FINISH,{type:E.LOAD_FINISH,target:this}),this._loadingContext=[]})})}}Ii.VERSION="2.10.2";class Pi{constructor({className:e={},showPlaneDetection:t=!0,toastText:i="Point your device downwards to find the ground and move it around."}={}){this.className=e,this.showPlaneDetection=t,this.toastText=i,this._createElements()}init(h){return Q(this,void 0,void 0,function*(){const r=this._rootEl,n=this._detectionRootEl,a=this._closeButtonEl,o=Object.assign(Object.assign({},Pi.DEFAULT_CLASS),this.className);h.on(E.AR_START,({session:e})=>{var t=e.domOverlay.root;if(t){t.appendChild(r);const i=()=>{e.exit()},s=(null!==n&&void 0!==n&&n.classList.add(o.DETECTION_VISIBLE),()=>{null!==n&&void 0!==n&&n.classList.remove(o.DETECTION_VISIBLE)});h.once(E.AR_MODEL_PLACED,s),a.addEventListener(m.CLICK,i),h.once(E.AR_END,()=>{r.parentElement&&r.parentElement.removeChild(r),a.removeEventListener(m.CLICK,i),h.off(E.AR_MODEL_PLACED,s)})}})})}teardown(){}_createElements(){var e=Object.assign(Object.assign({},Pi.DEFAULT_CLASS),this.className),t=document.createElement(f),i=document.createElement(f);i.classList.add(e.CLOSE_BUTTON),i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48px" height="48px" fill="#FFFFFF"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>',t.classList.add(e.ROOT),t.appendChild(i),this.showPlaneDetection&&(this._detectionRootEl=this._createPlaneDetectionElements(),t.appendChild(this._detectionRootEl)),this._rootEl=t,this._closeButtonEl=i}_createPlaneDetectionElements(){const t=Object.assign(Object.assign({},Pi.DEFAULT_CLASS),this.className);var e=document.createElement(f),i=document.createElement(f),s=document.createElement(f),r=document.createElement(f);const n=document.createElement(f);var a=document.createElement(f),o=k(5).map(()=>document.createElement(f));return e.classList.add(t.DETECTION_ROOT),i.classList.add(t.DETECTION_ICON),s.classList.add(t.DETECTION_TOAST),r.classList.add(t.DETECTION_PHONE),n.classList.add(t.DETECTION_CUBE),a.classList.add(t.DETECTION_PLANE),s.innerHTML=this.toastText,o.forEach(e=>{e.classList.add(t.DETECTION_CUBE_FACE),n.appendChild(e)}),i.appendChild(r),i.appendChild(n),i.appendChild(a),e.appendChild(i),e.appendChild(s),e}}Pi.DEFAULT_CLASS={ROOT:"view3d-ar-root",CLOSE_BUTTON:"view3d-ar-close",DETECTION_ROOT:"view3d-ar-detection",DETECTION_ICON:"view3d-ar-detection-icon",DETECTION_TOAST:"view3d-ar-detection-toast",DETECTION_PHONE:"view3d-ar-phone",DETECTION_CUBE:"view3d-ar-cube",DETECTION_CUBE_FACE:"view3d-ar-cube-face",DETECTION_PLANE:"view3d-ar-plane",DETECTION_VISIBLE:"visible"};class C{constructor(e={}){this._startLoading=({target:s,level:e})=>{if(0!==e)return;const{type:t=C.TYPE.DEFAULT,loadingLabel:i="Loading 3D Model...",parsingLabel:r="Parsing 3D Model...",labelColor:n="#ffffff",barWidth:a="70%",barHeight:o="10px",barBackground:h="#bbbbbb",barForeground:l="#3e8ed0",spinnerWidth:c="30%",overlayBackground:d="rgba(0, 0, 0, 0.3)"}=this._options;var e=document.createElement(f),u=document.createElement(f);const _=document.createElement(f);var p=document.createElement(f);const m=document.createElement(f);var v=Object.assign(Object.assign({},this._options.className),C.DEFAULT_CLASS);if(e.classList.add(v.OVERLAY),u.classList.add(v.WRAPPER),p.classList.add(v.BASE),_.classList.add(v.LABEL),m.classList.add(v.FILLER),e.style.backgroundColor=d,t!==C.TYPE.SPINNER?(p.style.height=o,p.style.backgroundColor=h,m.style.backgroundColor=l):(p.classList.add(v.TYPE_SPINNER),p.style.width=c,p.style.paddingTop=c,m.style.borderWidth=o,m.style.borderColor=l,m.style.borderLeftColor="transparent"),t===C.TYPE.TOP?e.classList.add(v.TYPE_TOP):t===C.TYPE.DEFAULT&&(p.style.width=a),_.style.color=n,_.innerText=i,p.appendChild(m),u.appendChild(p),u.appendChild(_),e.appendChild(u),s.rootEl.appendChild(e),t!==C.TYPE.SPINNER){const g=()=>{var e,t,i;s.loadingContext.every(e=>e.initialized)&&([e,t]=s.loadingContext.filter(e=>e.lengthComputable).reduce((e,t)=>(e[0]+=t.loaded,e[1]+=t.total,e),[0,0]),t<=0||(i=e/t*100,m.style.width=i.toFixed(2)+"%",e===t&&(_.innerText=r)))};s.on(E.PROGRESS,g),s.once(E.LOAD_FINISH,()=>{s.off(E.PROGRESS,g)})}s.once(E.LOAD_FINISH,()=>{this._removeOverlay(s)}),this._overlay=e},this._options=e}init(e){return Q(this,void 0,void 0,function*(){e.on(E.LOAD_START,this._startLoading)})}teardown(e){e.off(E.LOAD_START,this._startLoading),this._removeOverlay(e)}_removeOverlay(e){var t=this._overlay;t&&(t.parentElement===e.rootEl&&e.rootEl.removeChild(t),this._overlay=null)}}C.DEFAULT_CLASS={OVERLAY:"view3d-lb-overlay",WRAPPER:"view3d-lb-wrapper",BASE:"view3d-lb-base",LABEL:"view3d-lb-label",FILLER:"view3d-lb-filler",TYPE_SPINNER:"is-spinner",TYPE_TOP:"is-top"},C.TYPE={DEFAULT:"default",TOP:"top",SPINNER:"spinner"};class Ni{constructor(e,t,{position:i=M.POSITION.TOP,order:s=9999}={}){this._onResize=()=>{this._rootBbox=this._trackEl.getBoundingClientRect()},this._onRender=({target:e})=>{var e=e.animator,t=e.activeAnimationIndex,i=e.activeAnimation,e=e.actions[t];i&&e&&(t=e.time/i.duration,this._fill(t))},this._onMouseDown=e=>{var t,i;e.button===o.LEFT&&(t=(i=this._view3D.animator).activeAnimationIndex,i=i.actions[t],e.preventDefault(),window.addEventListener(m.MOUSE_MOVE,this._onMouseMove,!1),window.addEventListener(m.MOUSE_UP,this._onMouseUp,!1),this._rootBbox=this._trackEl.getBoundingClientRect(),this._showThumb(),this._origTimeScale=i.getEffectiveTimeScale(),this._setAnimationTimeScale(0),this._updateAnimationProgress(e.pageX))},this._onMouseMove=e=>{e.preventDefault(),this._updateAnimationProgress(e.pageX)},this._onMouseUp=()=>{window.removeEventListener(m.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(m.MOUSE_UP,this._onMouseUp,!1),this._hideThumb(),this._setAnimationTimeScale(this._origTimeScale)},this._onTouchStart=e=>{var t,i;1<e.touches.length||(e=e.touches[0],t=(i=this._view3D.animator).activeAnimationIndex,i=i.actions[t],this._rootBbox=this._trackEl.getBoundingClientRect(),this._showThumb(),this._firstTouch={x:e.pageX,y:e.pageY},this._origTimeScale=i.getEffectiveTimeScale(),this._setAnimationTimeScale(0),this._updateAnimationProgress(e.pageX))},this._onTouchMove=e=>{if(!(1<e.touches.length||this._scrolling)){var t=e.touches[0],i=this._view3D.scrollable,s=this._firstTouch;if(s){if(i){i=new P.Vector2(t.pageX,t.pageY).sub(new P.Vector2(s.x,s.y));if(Math.abs(i.y)>Math.abs(i.x))return this._scrolling=!0,void this._release()}this._firstTouch=null}e.cancelable&&e.preventDefault(),e.stopPropagation(),this._setAnimationTimeScale(0),this._updateAnimationProgress(t.pageX)}},this._onTouchEnd=e=>{0<e.touches.length||(this._release(),this._scrolling=!1)},this._updateAnimationProgress=e=>{var t=this._view3D,i=this._rootBbox,s=this._thumbEl,r=t.animator,n=r.activeAnimationIndex,a=r.activeAnimation,r=r.actions[n];a&&r&&(n=(e-i.x)/i.width,e=d(n,0,1)*a.duration,r.time=e,i=Math.floor(e),n=Math.floor(100*(e-i)),s.setAttribute("data-time",(a=e=>""+"0".repeat(Math.max(2-e.toString().length,0))+e)(i)+":"+a(n)),t.renderer.renderSingleFrame())},this.position=i,this.order=s,this._view3D=e,this._controlBar=t,this._createElements(),this._enabled=!1,this._firstTouch=null,this._scrolling=!1,this._origTimeScale=1}get element(){return this._rootEl}get enabled(){return this._enabled}enable(){var e=this._view3D;this._enabled||(this._rootBbox=this._trackEl.getBoundingClientRect(),this._enabled=!0,e.on(E.RESIZE,this._onResize),e.on(E.RENDER,this._onRender),this._fill(0),this.enableInput())}disable(){var e=this._view3D;this._enabled&&(this._enabled=!1,e.off(E.RESIZE,this._onResize),e.off(E.RENDER,this._onRender),this.disableInput())}enableInput(){var e=this._rootEl,t=this._view3D;this._firstTouch=null,this._scrolling=!1,t.animator.animationCount<=0||(e.addEventListener(m.MOUSE_DOWN,this._onMouseDown),e.addEventListener(m.TOUCH_START,this._onTouchStart,{passive:!1}),e.addEventListener(m.TOUCH_MOVE,this._onTouchMove,{passive:!1}),e.addEventListener(m.TOUCH_END,this._onTouchEnd))}disableInput(){var e=this._rootEl;e.removeEventListener(m.MOUSE_DOWN,this._onMouseDown),window.removeEventListener(m.MOUSE_MOVE,this._onMouseMove,!1),window.removeEventListener(m.MOUSE_UP,this._onMouseUp,!1),e.removeEventListener(m.TOUCH_START,this._onTouchStart),e.removeEventListener(m.TOUCH_MOVE,this._onTouchMove),e.removeEventListener(m.TOUCH_END,this._onTouchEnd)}_createElements(){var e=this._controlBar,e=Object.assign(Object.assign({},e.className),M.DEFAULT_CLASS),t=document.createElement(f),i=(t.classList.add(e.PROGRESS_ROOT),t.draggable=!1,document.createElement(f)),s=(i.classList.add(e.PROGRESS_TRACK),document.createElement(f)),r=(s.classList.add(e.PROGRESS_THUMB),document.createElement(f));r.classList.add(e.PROGRESS_FILLER),i.appendChild(r),i.appendChild(s),t.appendChild(i),this._rootEl=t,this._trackEl=i,this._thumbEl=s,this._fillerEl=r}_fill(e){this._fillerEl.style.width=100*e+"%",this._thumbEl.style.transform=`translateX(${e*this._rootBbox.width}px)`}_release(){this._hideThumb(),this._setAnimationTimeScale(this._origTimeScale)}_showThumb(){var e=this._thumbEl,t=this._controlBar,t=Object.assign(Object.assign({},t.className),M.DEFAULT_CLASS);e.classList.add(t.VISIBLE)}_hideThumb(){var e=this._thumbEl,t=this._controlBar,t=Object.assign(Object.assign({},t.className),M.DEFAULT_CLASS);e.classList.remove(t.VISIBLE)}_setAnimationTimeScale(e){var t=this._view3D.animator,i=t.activeAnimationIndex,s=t.activeAnimation,t=t.actions[i];s&&t&&t.setEffectiveTimeScale(e)}}var Fi='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" height="48" width="48"><path d="M16 37.85V9.85L38 23.85Z"/></svg>';class Ui{constructor(e,t,{position:i=M.POSITION.LEFT,order:s=9999}={}){this._updateIcon=()=>{var e=this._view3D;e.animator.paused!==this._paused&&(this._paused=e.animator.paused,this._element.innerHTML=this._paused?Fi:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" height="48" width="48"><path d="M28.25 38V10H36V38ZM12 38V10H19.75V38Z"/></svg>')},this._onClick=()=>{var e=this._view3D.animator;e.paused?e.resume():e.pause(),this._updateIcon()},this.position=i,this.order=s,this._view3D=e,this._element=this._createButton(t),this._enabled=!1,this._paused=!0}get element(){return this._element}get enabled(){return this._enabled}enable(){this._enabled||(this._view3D.on(E.RENDER,this._updateIcon),this._element.addEventListener(m.CLICK,this._onClick),this._enabled=!0)}disable(){this._enabled&&(this._view3D.off(E.RENDER,this._updateIcon),this._element.removeEventListener(m.CLICK,this._onClick),this._enabled=!1)}_createButton(e){var t=document.createElement(we),e=Object.assign(Object.assign({},e.className),M.DEFAULT_CLASS);return t.classList.add(e.CONTROLS_ITEM),t.innerHTML=Fi,t}}class Bi{constructor(e,t,{position:i=M.POSITION.LEFT,order:s=9999}={}){this._updateAnimations=()=>{var e=this._view3D,t=this._controlBar;const r=e.animator;e=this._rootEl;const i=this._nameEl,n=this._itemListEl;var s=r.clips;const a=Object.assign(Object.assign({},t.className),M.DEFAULT_CLASS);for(;n.firstChild;)n.removeChild(n.firstChild);if(s.length<=0)e.classList.add(a.DISABLED);else{e.classList.remove(a.DISABLED);const o=s.map(e=>{var t=document.createElement(f);return t.classList.add(a.ANIMATION_ITEM),t.innerHTML=e.name,t}),h=(e,t)=>{o[t].classList.add(a.ANIMATION_SELECTED),i.innerHTML=e.name};s.forEach((i,s)=>{var e=o[s];s===r.activeAnimationIndex&&h(i,s),e.addEventListener(m.CLICK,e=>{var t=r.paused;r.play(s),t&&r.pause(),o.forEach(e=>{e.classList.remove(a.ANIMATION_SELECTED)}),h(i,s),this._hideList(),e.stopPropagation()}),n.appendChild(e)})}},this._toggleList=e=>{var t=this._controlBar,i=this._itemListEl,t=Object.assign(Object.assign({},t.className),M.DEFAULT_CLASS);i.classList.toggle(t.VISIBLE),i.classList.contains(t.VISIBLE)&&this._view3D.rootEl.addEventListener(m.CLICK,this._hideList),e.stopPropagation()},this._hideList=()=>{var e=this._controlBar,t=this._itemListEl,e=Object.assign(Object.assign({},e.className),M.DEFAULT_CLASS);t.classList.contains(e.VISIBLE)&&t.classList.remove(e.VISIBLE)},this.position=i,this.order=s,this._view3D=e,this._controlBar=t,this._createElements(),this._enabled=!1}get element(){return this._rootEl}get enabled(){return this._enabled}enable(){this._enabled||(this._view3D.initialized&&this._updateAnimations(),this._view3D.on(E.MODEL_CHANGE,this._updateAnimations),this._nameEl.addEventListener(m.CLICK,this._toggleList),this._enabled=!0)}disable(){this._enabled&&(this._view3D.off(E.MODEL_CHANGE,this._updateAnimations),this._view3D.rootEl.removeEventListener(m.CLICK,this._hideList),this._nameEl.removeEventListener(m.CLICK,this._toggleList),this._enabled=!1)}_createElements(){var e=this._controlBar,t=document.createElement(f),i=document.createElement(f),s=document.createElement(f),e=Object.assign(Object.assign({},e.className),M.DEFAULT_CLASS);t.classList.add(e.CONTROLS_ITEM),t.classList.add(e.DISABLED),i.classList.add(e.ANIMATION_NAME),s.classList.add(e.ANIMATION_LIST),t.appendChild(i),t.appendChild(s),this._rootEl=t,this._nameEl=i,this._itemListEl=s}}const ki=["requestFullscreen","webkitRequestFullscreen","webkitRequestFullScreen","webkitCancelFullScreen","mozRequestFullScreen","msRequestFullscreen"],Hi=["fullscreenElement","webkitFullscreenElement","webkitCurrentFullScreenElement","mozFullScreenElement","msFullscreenElement"],Vi=["exitFullscreen","webkitExitFullscreen","webkitCancelFullScreen","mozCancelFullScreen","msExitFullscreen"];class Gi{constructor(e,t,{position:i=M.POSITION.RIGHT,order:s=9999}={}){this._onClick=()=>{var e=this._view3D.rootEl;this._isFullscreen()?this._exitFullscreen():this._requestFullscreen(e)},this.position=i,this.order=s,this._view3D=e,this._element=this._createButton(t),this._enabled=!1}get element(){return this._element}get enabled(){return this._enabled}enable(){this._enabled||(this._element.addEventListener(m.CLICK,this._onClick),this._enabled=!0)}disable(){this._enabled&&(this._element.removeEventListener(m.CLICK,this._onClick),this._enabled=!1)}_isFullscreen(){if(document)for(const e of Hi)if(document[e])return!0;return!1}_requestFullscreen(e){for(const i of ki){var t=e[i];t&&t.call(e)}}_exitFullscreen(){for(const t of Vi){var e=document[t];e&&e.call(document)}}_createButton(e){var t=document.createElement(we),e=Object.assign(Object.assign({},e.className),M.DEFAULT_CLASS);return t.classList.add(e.CONTROLS_ITEM),t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" height="48" width="48"><path d="M10 38v-9.65h3V35h6.65v3Zm0-18.35V10h9.65v3H13v6.65ZM28.35 38v-3H35v-6.65h3V38ZM35 19.65V13h-6.65v-3H38v9.65Z"/></svg>',t}}class zi{constructor(e,t,{axisWidth:i=5,font:s="14px sans-serif",xAxisColor:r="#ef2746",yAxisColor:n="#a7c031",zAxisColor:a="#6571a6"}={}){this._onRender=()=>{var e=this._view3D;const o=this._ctx;var t=this._canvasSize,i=e.camera.threeCamera;if(o&&e.model){o.clearRect(0,0,t.x,t.y);var e=i.quaternion.clone(),i=(e.invert(),new P.Vector3(1,0,0).applyQuaternion(e)),s=new P.Vector3(0,1,0).applyQuaternion(e),e=new P.Vector3(0,0,1).applyQuaternion(e);const h=new P.Vector2(.5,.5).multiply(t);o.lineCap="round",o.lineWidth=this.axisWidth;var t=new P.Color(this.xAxisColor),r=new P.Color(this.yAxisColor),n=new P.Color(this.zAxisColor);[{idx:0,axis:"X",color:t,pos:i,negative:!1},{idx:1,axis:"Y",color:r,pos:s,negative:!1},{idx:2,axis:"Z",color:n,pos:e,negative:!1},{idx:3,axis:"X",color:t,pos:i.clone().negate(),negative:!0},{idx:4,axis:"Y",color:r,pos:s.clone().negate(),negative:!0},{idx:5,axis:"Z",color:n,pos:e.clone().negate(),negative:!0}].sort((e,t)=>e.pos.z-t.pos.z).forEach(({axis:e,pos:t,color:i,negative:s,idx:r},n)=>{var a=this._getScreenPos(t),t=0<=t.z?1:.6,i=this._getColorRGBAString(i,t),t=(s||(o.strokeStyle=i,o.beginPath(),o.moveTo(h.x,h.y),o.lineTo(a.x,a.y),o.stroke(),o.globalCompositeOperation="destination-out",o.fillStyle="white",o.beginPath(),o.ellipse(a.x,a.y,10,10,0,0,2*Math.PI),o.fill(),o.globalCompositeOperation="source-over"),o.fillStyle=i,o.beginPath(),o.ellipse(a.x,a.y,10,10,0,0,2*Math.PI),o.fill(),s||(o.font=this.font,o.fillStyle="white",o.textAlign="center",o.textBaseline="middle",o.fillText(e,a.x,a.y)),this._axisEls[r]);t.style.left=a.x+"px",t.style.top=a.y+"px",t.style.zIndex=n.toString()})}},this.axisWidth=i,this.font=s,this.xAxisColor=r,this.yAxisColor=n,this.zAxisColor=a,this._view3D=e,this._createElement(t),this._ctx=this._canvasEl.getContext("2d"),this._enabled=!1,this._canvasSize=new P.Vector2}get element(){return this._rootEl}get enabled(){return this._enabled}enable(){if(!this._enabled&&this._ctx){var e=this._rootEl,t=this._canvasEl;const s=this._view3D,r=(this._enabled=!0,s.rootEl.appendChild(e),s.on(E.RENDER,this._onRender),this._canvasSize.set(t.clientWidth,t.clientHeight),t.width=this._canvasSize.x,t.height=this._canvasSize.y,[new y(-90,0,0),new y(0,90,0),new y(0,0,0),new y(90,0,0),new y(0,-90,0),new y(180,0,0)]);r.forEach(e=>{e.pivot.copy(s.camera.defaultPose.pivot)}),this._axisClickListeners=this._axisEls.map((e,t)=>{const i=r[t];t=()=>{s.camera.reset(300,x,i)};return e.addEventListener(m.CLICK,t),t})}}disable(){var e,t;this._enabled&&(this._enabled=!1,e=this._view3D.rootEl,(t=this._rootEl)&&t.parentElement===e&&e.removeChild(t),this._view3D.off(E.RENDER,this._onRender),this._axisEls.forEach((e,t)=>{t=this._axisClickListeners[t];e.removeEventListener(m.CLICK,t)}),this._axisClickListeners=[])}_createElement(e){const t=document.createElement(f);var i=document.createElement("canvas"),s=k(6).map(()=>document.createElement(f));const r=Object.assign(Object.assign({},e.className),M.DEFAULT_CLASS);t.classList.add(r.GIZMO_ROOT),t.appendChild(i),s.forEach(e=>{e.classList.add(r.GIZMO_AXIS),t.appendChild(e)}),this._rootEl=t,this._canvasEl=i,this._axisEls=s}_getScreenPos(e){var t=this._canvasSize;return new P.Vector2(e.x,-e.y).multiplyScalar(.8).addScalar(1).multiplyScalar(.5).multiply(t)}_getColorRGBAString(e,t){return`rgba(${Math.floor(255*e.r)},${Math.floor(255*e.g)},${Math.floor(255*e.b)},${t})`}}class Wi{constructor(e,t,{position:i=M.POSITION.RIGHT,order:s=9999,duration:r=500}={}){this._onClick=()=>{this._view3D.camera.reset(this.duration)},this.position=i,this.order=s,this.duration=r,this._view3D=e,this._element=this._createButton(t),this._enabled=!1}get element(){return this._element}get enabled(){return this._enabled}enable(){this._enabled||(this._element.addEventListener(m.CLICK,this._onClick),this._enabled=!0)}disable(){this._enabled&&(this._element.removeEventListener(m.CLICK,this._onClick),this._enabled=!1)}_createButton(e){var t=document.createElement(we),e=Object.assign(Object.assign({},e.className),M.DEFAULT_CLASS);return t.classList.add(e.CONTROLS_ITEM),t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" height="48" width="48"><path d="M24 44q-3.75 0-7.025-1.4-3.275-1.4-5.725-3.85Q8.8 36.3 7.4 33.025 6 29.75 6 26h3q0 6.25 4.375 10.625T24 41q6.25 0 10.625-4.375T39 26q0-6.25-4.25-10.625T24.25 11H23.1l3.65 3.65-2.05 2.1-7.35-7.35 7.35-7.35 2.05 2.05-3.9 3.9H24q3.75 0 7.025 1.4 3.275 1.4 5.725 3.85 2.45 2.45 3.85 5.725Q42 22.25 42 26q0 3.75-1.4 7.025-1.4 3.275-3.85 5.725-2.45 2.45-5.725 3.85Q27.75 44 24 44Z"/></svg>',t}}class M{constructor({autoHide:e=!0,className:t={},progressBar:i=!0,playButton:s=!0,animationSelector:r=!0,fullscreenButton:n=!0,navigationGizmo:a=!0,cameraResetButton:o=!0}={}){this.show=()=>{var e=this._rootEl,t=Object.assign(Object.assign({},M.DEFAULT_CLASS),this.className);e.classList.add(t.VISIBLE)},this.hide=()=>{var e=this._rootEl,t=Object.assign(Object.assign({},M.DEFAULT_CLASS),this.className);e.classList.remove(t.VISIBLE)},this._updateModelParams=()=>{this._items.forEach(e=>{e.disable(),e.enable()})},this._hideAfterDelay=()=>{var{delay:e=0}=Z(this.autoHide);this._autoHideTimer&&(window.clearTimeout(this._autoHideTimer),this._autoHideTimer=-1),e<=0?this.hide():this._autoHideTimer=window.setTimeout(this.hide,e)},this.autoHide=e,this.className=t,this.progressBar=i,this.playButton=s,this.animationSelector=r,this.fullscreenButton=n,this.navigationGizmo=a,this.cameraResetButton=o,this._items=[],this._initElements(),this._autoHideTimer=-1}get rootEl(){return this._rootEl}get items(){return this._items}init(e){return Q(this,void 0,void 0,function*(){this._attachElements(e),e.model&&this._updateModelParams(),this._items=this._createDefaultItems(e),this._addItemElements(),this._items.forEach(e=>{e.enable()}),e.on(E.MODEL_CHANGE,this._updateModelParams),this.show(),this._setupAutoHide(e)})}teardown(e){var t=e.rootEl;t.removeEventListener(m.POINTER_ENTER,this.show),t.removeEventListener(m.POINTER_LEAVE,this._hideAfterDelay),this._removeElements(e),this._items.forEach(e=>{e.disable()}),this._items=[],e.off(E.MODEL_CHANGE,this._updateModelParams),window.clearTimeout(this._autoHideTimer)}_initElements(){var e=Object.assign(Object.assign({},M.DEFAULT_CLASS),this.className),t=document.createElement(f),i=(t.classList.add(e.ROOT),this._rootEl=t,document.createElement(f)),i=(i.classList.add(e.CONTROLS_BG),t.appendChild(i),document.createElement(f)),s=document.createElement(f),r=document.createElement(f),n=document.createElement(f);i.classList.add(e.CONTROLS_TOP),s.classList.add(e.CONTROLS_SIDE),r.classList.add(e.CONTROLS_LEFT),n.classList.add(e.CONTROLS_RIGHT),t.appendChild(i),s.appendChild(r),s.appendChild(n),t.appendChild(s),this._topControlsWrapper=i,this._leftControlsWrapper=r,this._rightControlsWrapper=n}_addItemElements(){var e=this._topControlsWrapper,t=this._leftControlsWrapper,i=this._rightControlsWrapper,s=this._items.filter(e=>e.position&&null!=e.order);const r={[M.POSITION.TOP]:{parentEl:e,items:[]},[M.POSITION.LEFT]:{parentEl:t,items:[]},[M.POSITION.RIGHT]:{parentEl:i,items:[]}};s.forEach(e=>{r[e.position].items.push(e)}),Object.keys(r).forEach(e=>{const{parentEl:t,items:i}=r[e];i.sort((e,t)=>e.order-t.order),i.forEach(e=>{t.appendChild(e.element)})})}_attachElements(e){e.rootEl.appendChild(this._rootEl)}_removeElements(e){var t=this._rootEl;[this._topControlsWrapper,this._leftControlsWrapper,this._rightControlsWrapper].forEach(e=>{for(;e.firstChild;)e.removeChild(e.firstChild)}),t.parentElement===e.rootEl&&e.rootEl.removeChild(t)}_setupAutoHide(e){var t;this.autoHide&&({initialDelay:t=3e3}=Z(this.autoHide),e=e.rootEl,this._autoHideTimer=window.setTimeout(()=>{this.hide()},t),e.addEventListener(m.POINTER_ENTER,this.show),e.addEventListener(m.POINTER_LEAVE,this._hideAfterDelay))}_createDefaultItems(e){var t=[];return this.progressBar&&t.push(new Ni(e,this,Z(this.progressBar))),this.playButton&&t.push(new Ui(e,this,Z(this.playButton))),this.animationSelector&&t.push(new Bi(e,this,Z(this.animationSelector))),this.cameraResetButton&&t.push(new Wi(e,this,Z(this.cameraResetButton))),this.fullscreenButton&&t.push(new Gi(e,this,Z(this.fullscreenButton))),this.navigationGizmo&&t.push(new zi(e,this,Z(this.navigationGizmo))),t}}M.DEFAULT_CLASS={ROOT:"view3d-control-bar",VISIBLE:"visible",DISABLED:"disabled",CONTROLS_BG:"view3d-controls-background",CONTROLS_SIDE:"view3d-side-controls",CONTROLS_TOP:"view3d-top-controls",CONTROLS_LEFT:"view3d-left-controls",CONTROLS_RIGHT:"view3d-right-controls",CONTROLS_ITEM:"view3d-control-item",PROGRESS_ROOT:"view3d-progress-bar",PROGRESS_TRACK:"view3d-progress-track",PROGRESS_THUMB:"view3d-progress-thumb",PROGRESS_FILLER:"view3d-progress-filler",ANIMATION_NAME:"view3d-animation-name",ANIMATION_LIST:"view3d-animation-list",ANIMATION_ITEM:"view3d-animation-item",ANIMATION_SELECTED:"selected",GIZMO_ROOT:"view3d-gizmo",GIZMO_AXIS:"view3d-gizmo-axis"},M.POSITION={TOP:"top",LEFT:"left",RIGHT:"right"};var t={__proto__:null,default:Ii,Animation:Qe,ARManager:wt,AutoPlayer:Ct,AutoResizer:Ye,Camera:qe,Model:Ci,ModelAnimator:Ze,Motion:S,Pose:y,Renderer:Le,Scene:Ve,ShadowPlane:Be,Skybox:b,View3DError:h,Annotation:bt,PointAnnotation:xt,FaceAnnotation:St,AnnotationManager:yt,AnimationControl:Xe,OrbitControl:Ot,RotateControl:Rt,TranslateControl:Lt,ZoomControl:At,Loader:Oe,GLTFLoader:O,TextureLoader:Ce,ARButton:class{constructor(e={}){this._options=e,this._button=null}init(e){return Q(this,void 0,void 0,function*(){yield this._addButton(e)})}teardown(e){var t=this._button;t&&(t.parentElement===e.rootEl&&e.rootEl.removeChild(t),this._button=null)}_addButton(o){return Q(this,void 0,void 0,function*(){var{availableText:e="View in AR",unavailableText:t="AR is not available in this browser",buttonClass:i="view3d-ar-button",tooltipClass:s="view3d-tooltip"}=this._options;const r=yield o.ar.isAvailable(),n=document.createElement(we);var a=document.createElement(f),e=document.createTextNode(r?e:t);n.classList.add(i),a.classList.add(s),n.disabled=!0,n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" viewBox="0 0 24 24" width="32px" height="32px"><g><rect fill="none" height="24" width="24" x="0" y="0"/></g><g><g><path d="M3,4c0-0.55,0.45-1,1-1h2V1H4C2.34,1,1,2.34,1,4v2h2V4z"/><path d="M3,20v-2H1v2c0,1.66,1.34,3,3,3h2v-2H4C3.45,21,3,20.55,3,20z"/><path d="M20,1h-2v2h2c0.55,0,1,0.45,1,1v2h2V4C23,2.34,21.66,1,20,1z"/><path d="M21,20c0,0.55-0.45,1-1,1h-2v2h2c1.66,0,3-1.34,3-3v-2h-2V20z"/><path d="M19,14.87V9.13c0-0.72-0.38-1.38-1-1.73l-5-2.88c-0.31-0.18-0.65-0.27-1-0.27s-0.69,0.09-1,0.27L6,7.39 C5.38,7.75,5,8.41,5,9.13v5.74c0,0.72,0.38,1.38,1,1.73l5,2.88c0.31,0.18,0.65,0.27,1,0.27s0.69-0.09,1-0.27l5-2.88 C18.62,16.25,19,15.59,19,14.87z M11,17.17l-4-2.3v-4.63l4,2.33V17.17z M12,10.84L8.04,8.53L12,6.25l3.96,2.28L12,10.84z M17,14.87l-4,2.3v-4.6l4-2.33V14.87z"/></g></g></svg>',n.appendChild(a),a.appendChild(e),o.rootEl.appendChild(n),this._button=n,o.initialized?yield this._setAvailable(o,n,r):o.once(E.MODEL_CHANGE,()=>{this._setAvailable(o,n,r)})})}_setAvailable(e,t,i){return Q(this,void 0,void 0,function*(){i?(t.disabled=!1,t.addEventListener("click",()=>{e.ar.enter()})):t.disabled=!0})}},AROverlay:Pi,LoadingBar:C,ControlBar:M,AnimationProgressBar:Ni,AnimationSelector:Bi,FullscreenButton:Gi,PlayButton:Ui,NavigationGizmo:zi,ARScene:dt,WebARSession:gt,SceneViewerSession:ft,QuickLookSession:Et,DOMOverlay:ut,HitTest:_t,LightEstimation:vt,AUTO:$,EVENTS:E,EASING:be,DEFAULT_CLASS:J,TONE_MAPPING:xe,ZOOM_TYPE:Se,AR_SESSION_TYPE:e,SCENE_VIEWER_MODE:ye,QUICK_LOOK_APPLE_PAY_BUTTON_TYPE:{PLAIN:"plain",PAY:"pay",BUY:"buy",CHECK_OUT:"check-out",BOOK:"book",DONATE:"donate",SUBSCRIBE:"subscribe"},QUICK_LOOK_CUSTOM_BANNER_SIZE:{SMALL:"small",MEDIUM:"medium",LARGE:"large"},INPUT_TYPE:g,ANIMATION_REPEAT_MODE:Re,ERROR_CODES:r,isAvailable:({webGL:e=!0,fetch:t=!0,stream:i=!0,wasm:s=!0}={})=>{if(e&&!(()=>{try{const e=document.createElement("canvas");return!!window.WebGLRenderingContext&&!!(e.getContext("webgl")||e.getContext("experimental-webgl"))}catch(e){return false}})())return!1;if(t&&!(window&&window.fetch))return!1;if(i&&!(window&&window.ReadableStream))return!1;if(s&&!(()=>{try{if(typeof WebAssembly==="object"&&typeof WebAssembly.instantiate==="function"){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){return false}})())return!1;return!0},withMethods:(r,n)=>{[D.prototype,Ii.prototype].forEach(s=>{Object.getOwnPropertyNames(s).filter(e=>"_"!==e.charAt(0)&&"constructor"!==e).forEach(e=>{const i=Object.getOwnPropertyDescriptor(s,e);var t;i.value?Object.defineProperty(r,e,{value:function(...e){return i.value.call(this[n],...e)}}):(t={},i.get&&(t.get=function(){var e;return this[n]&&(null==(e=i.get)?void 0:e.call(this[n]))}),i.set&&(t.set=function(...e){var t;return null==(t=i.set)?void 0:t.call(this[n],...e)}),Object.defineProperty(r,e,t))})})},getValidProps:i=>Object.keys(i).reduce((e,t)=>(null!=i[t]&&(e[t]=i[t]),e),{}),isNumber:I,isString:n,isElement:N,getNullableElement:F,getElement:ee,findCanvas:U,isCSSSelector:B,range:k,toRadian:_,toDegree:p,clamp:d,lerp:H,circulate:u,merge:V,getBoxPoints:e=>[e.min.clone(),new P.Vector3(e.min.x,e.min.y,e.max.z),new P.Vector3(e.min.x,e.max.y,e.min.z),new P.Vector3(e.min.x,e.max.y,e.max.z),new P.Vector3(e.max.x,e.min.y,e.min.z),new P.Vector3(e.max.x,e.min.y,e.max.z),new P.Vector3(e.max.x,e.max.y,e.min.z),e.max.clone()],toPowerOfTwo:G,getPrimaryAxisIndex:(e,i)=>{let s=0,r=0;return e.forEach((e,t)=>{e=Math.abs(i.dot(e));e>r&&(s=t,r=e)}),s},getRotationAngle:z,getObjectOption:Z,toBooleanString:W,getRotatedPosition:j,directionToYawPitch:K,createLoadingContext:X,getAttributeScale:q,getSkinnedVertex:Y,isSignedArrayBuffer:te,checkHalfFloatAvailable:ie,getFaceVertices:se,getAnimatedFace:re,subclip:(e,t,h,l)=>{var i=e.clone();i.name=t;const c=[];i.tracks.forEach(i=>{var s=i.getValueSize(),e=[],r=[];for(let t=0;t<i.times.length;++t){var n=i.times[t],a=i.times[t+1],o=i.times[t-1];if(a&&n<h&&h<a||h<=n&&n<l||o&&l<=n&&o<l){e.push(n);for(let e=0;e<s;++e)r.push(i.values[t*s+e])}}0!==e.length&&(i.times=ne(e,i.times.constructor),i.values=ne(r,i.values.constructor),c.push(i))}),i.tracks=c;for(let e=0;e<i.tracks.length;++e)i.tracks[e].shift(-h);return i.duration=l-h,i},parseAsBboxRatio:ae};return V(Ii,t),Ii});
